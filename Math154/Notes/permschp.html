<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 5 Permutation Tests | Computational Statistics</title>
<meta name="author" content="Jo Hardin">
<meta name="description" content="Motivation: Great video of how/why computational statistical methods can be extremely useful. And it’s about beer and mosquitoes! John Rauser from Pintrest gives the keynote address at Strata +...">
<meta name="generator" content="bookdown 0.23 with bs4_book()">
<meta property="og:title" content="Chapter 5 Permutation Tests | Computational Statistics">
<meta property="og:type" content="book">
<meta property="og:description" content="Motivation: Great video of how/why computational statistical methods can be extremely useful. And it’s about beer and mosquitoes! John Rauser from Pintrest gives the keynote address at Strata +...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 5 Permutation Tests | Computational Statistics">
<meta name="twitter:description" content="Motivation: Great video of how/why computational statistical methods can be extremely useful. And it’s about beer and mosquitoes! John Rauser from Pintrest gives the keynote address at Strata +...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11.1/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.0/transition.js"></script><script src="libs/bs3compat-0.3.0/tabs.js"></script><script src="libs/bs3compat-0.3.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script type="text/x-mathjax-config">
    const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
    for (let popover of popovers){
      const div = document.createElement('div');
      div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
      div.innerHTML = popover.getAttribute('data-content');
      
      // Will this work with TeX on its own line?
      var has_math = div.querySelector("span.math");
      if (has_math) {
        document.body.appendChild(div);
      	MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
      	MathJax.Hub.Queue(function(){
          popover.setAttribute('data-content', div.innerHTML);
      	})
      }
    }
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Computational Statistics</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Class Information</a></li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="visualization.html"><span class="header-section-number">2</span> Visualization</a></li>
<li><a class="" href="wrang.html"><span class="header-section-number">3</span> Data Wrangling</a></li>
<li><a class="" href="sims.html"><span class="header-section-number">4</span> Simulating</a></li>
<li><a class="active" href="permschp.html"><span class="header-section-number">5</span> Permutation Tests</a></li>
<li><a class="" href="boot.html"><span class="header-section-number">6</span> Bootstrapping</a></li>
<li><a class="" href="ethics.html"><span class="header-section-number">7</span> Ethics</a></li>
<li><a class="" href="class.html"><span class="header-section-number">8</span> Classification</a></li>
<li><a class="" href="unsup.html"><span class="header-section-number">9</span> Unsupervised Methods</a></li>
<li><a class="" href="misc.html"><span class="header-section-number">10</span> Misc</a></li>
<li><a class="" href="compstat.html"><span class="header-section-number">11</span> Computational Statistics</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/hardin47/website">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="permschp" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Permutation Tests<a class="anchor" aria-label="anchor" href="#permschp"><i class="fas fa-link"></i></a>
</h1>
<!--
Just use repeated measures????
-->
<div id="motivation" class="section level5 unnumbered">
<h5>Motivation:<a class="anchor" aria-label="anchor" href="#motivation"><i class="fas fa-link"></i></a>
</h5>
<ul>
<li>Great video of how/why computational statistical methods can be extremely useful. And it’s about beer and mosquitoes! John Rauser from Pintrest gives the keynote address at Strata + Hadoop World Conference October 16, 2014. David Smith, Revolution Analytics blog, October 17, 2014. <a href="http://blog.revolutionanalytics.com/2014/10/statistics-doesnt-have-to-be-that-hard.html" class="uri">http://blog.revolutionanalytics.com/2014/10/statistics-doesnt-have-to-be-that-hard.html</a>
</li>
<li>A more complicated scenario with the same tools being applied. Here the point is to understand gerrymandering. <a href="https://www.youtube.com/watch?v=gRCZR_BbjTo&amp;t=125s" class="uri">https://www.youtube.com/watch?v=gRCZR_BbjTo&amp;t=125s</a>
</li>
</ul>
<blockquote>
<p>The big lesson here, IMO, is that so many statistical problems can seem complex, but you can actually get a lot of insight by recognizing that your data is just one possible instance of a random process. If you have a hypothesis for what that process is, you can simulate it, and get an intuitive sense of how surprising your data is. R has excellent tools for simulating data, and a couple of hours spent writing code to simulate data can often give insights that will be valuable for the formal data analysis to come. (David Smith)</p>
</blockquote>
<p>Rauser says that the in order to follow a statistical argument that uses simulation, you need three things:</p>
<ol style="list-style-type: decimal">
<li>Ability to follow a simple logical argument.</li>
<li>Random number generation.</li>
<li>Iteration</li>
</ol>
</div>
<div id="algs" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Inference Algorithms<a class="anchor" aria-label="anchor" href="#algs"><i class="fas fa-link"></i></a>
</h2>
<div id="hypothesis-test-algorithm" class="section level3" number="5.1.1">
<h3>
<span class="header-section-number">5.1.1</span> Hypothesis Test Algorithm<a class="anchor" aria-label="anchor" href="#hypothesis-test-algorithm"><i class="fas fa-link"></i></a>
</h3>
<p>Before working out the nitty gritty details, recall the structure of hypothesis testing. Consider the applet on Simulating ANOVA Tables (Chance &amp; Rossman) <a href="http://www.rossmanchance.com/applets/AnovaSim.html" class="uri">http://www.rossmanchance.com/applets/AnovaSim.html</a></p>
<ol style="list-style-type: decimal">
<li>Choose a statistic that measures the effect you are looking for. For example, the ANOVA F statistic is:</li>
</ol>
<p><span class="math display">\[\begin{align}
F &amp;= \frac{\text{between-group variability}}{\text{within-group variability}}\\
&amp;= \frac{\sum_i n_i(\overline{X}_{i\cdot} - \overline{X})^2/(K-1)}{\sum_{ij} (X_{ij}-\overline{X}_{i\cdot})^2/(N-K)}
\end{align}\]</span></p>
<ol start="2" style="list-style-type: decimal">
<li><p>Construct the sampling distribution that this statistic would have if the effect were <em>not</em> present in the population (the null sampling distribution). [The sampling distributions for t statistics and F statistics are based on the Central Limit Theorem and derived in Math 152.]</p></li>
<li><p>Locate the observed statistic in the null distribution. A value in the main body of the distribution could easily occur just by chance. A value in the tail would rarely occur by chance and so is evidence that something other than chance is operating. [This piece is going to happen in permutation tests as well as in analytic tests – the point is to see if the observed data is consistent with the null distribution.]</p></li>
<li><p><strong>p-value</strong> is the probability of the observed data or more extreme if the null hypothesis is true. [Same definition for analytic, permutation, and randomization tests!]<br>
To estimate the p-value for a test of significance, estimate the sampling distribution of the test statistic when the null hypothesis is true by simulating in a manner that is consistent with the null hypothesis. Alternatively, there are analytic / mathematical formulas for many of the common statistical hypothesis tests.</p></li>
</ol>
</div>
<div id="permutation-tests-algorithm" class="section level3" number="5.1.2">
<h3>
<span class="header-section-number">5.1.2</span> Permutation Tests Algorithm<a class="anchor" aria-label="anchor" href="#permutation-tests-algorithm"><i class="fas fa-link"></i></a>
</h3>
<p>To evaluate the p-value for a permutation test, estimate the sampling distribution of the test statistic when the null hypothesis is true by resampling in a manner that is consistent with the null hypothesis (the number of resamples is finite but can be large!).</p>
<ol style="list-style-type: decimal">
<li><p>Choose a test statistic</p></li>
<li><p>Shuffle the data (force the null hypothesis to be true)</p></li>
<li><p>Create a null sampling distribution of the test statistic (under <span class="math inline">\(H_0\)</span>)</p></li>
<li><p>Find the observed test statistic on the null sampling distribution and compute the p-value (observed data or more extreme). The p-value can be one or two-sided.</p></li>
</ol>
<div id="technical-conditions-1" class="section level4 unnumbered">
<h4>Technical Conditions<a class="anchor" aria-label="anchor" href="#technical-conditions-1"><i class="fas fa-link"></i></a>
</h4>
<p>Permutation tests fall into a broad class of tests called “non-parametric” tests. The label indicates that there are no distributional conditions required about the data (i.e., no condition that the data come from a normal or binomial distribution). However, a test which is “non-parametric” does not meant that there are no conditions on the data, simply that there are no <em>distributional or parametric</em> conditions on the data. <strong>The parameters are at the heart of almost all parametric tests.</strong></p>
<p>For permutation tests, we are not basing the test on population parameters, so we don’t need to make any claims about them (i.e., that they are the mean of a particular distribution).</p>
<ul>
<li>
<strong>Permutation</strong> The different treatments have the same effect. [Note: exchangeability, same population, etc.] <em>If the null hypothesis is true, the labels assigning groups are interchangeable with respect to the probability distribution.</em>
<ul>
<li>Note that it is our choice of <em>statistic</em> which makes the test more sensitive to some kinds of difference (e.g., difference in mean) than other kinds (e.g., difference in variance).</li>
</ul>
</li>
<li>
<strong>Parametric</strong> For example, the different populations have the same mean.</li>
</ul>
<p><strong>IMPORTANT KEY IDEA</strong> the point of technical conditions for parametric or permutation tests is to create a sampling distribution that accurately reflects the null sampling distribution for the statistic of interest (the statistic which captures the relevant research question information).</p>
</div>
</div>
</div>
<div id="perms" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Permutation tests in practice<a class="anchor" aria-label="anchor" href="#perms"><i class="fas fa-link"></i></a>
</h2>
<p>How is the test interpreted given the different types of sampling which are possibly used to collect the data?</p>
<ul>
<li><p><strong>Random Sample</strong> The concept of a p-value usually comes from the idea of taking a sample from a population and comparing it to a sampling distribution (from many many random samples).</p></li>
<li>
<p><strong>Random Experiment</strong> In the context of a <strong>randomized experiment</strong>, the p-value represents the observed data compared to “happening by chance.”</p>
<ul>
<li>The interpretation is direct: if there is only a very small chance that the observed statistic would take such an extreme value, as a result only of the randomization of cases: we reject the null treatment effect hypothesis. CAUSAL!</li>
</ul>
</li>
<li>
<p><strong>Observational Study</strong> In the context of <strong>observational studies</strong> the results are less strong, but it is reasonable to conclude that the effect observed in the sample reflects an effect present in the population.</p>
<ul>
<li>In a sample, consider the difference (or ratio) and ask “Is this difference so large it would rarely occur by chance in a particular sample constructed under the null setting?”</li>
<li>If the data come from a random sample, then the sample (or results from the sample) are probably consistent with the population [i.e., we can infer the results back to the larger population].</li>
</ul>
</li>
</ul>
<div id="other-test-statistics" class="section level4" number="5.2.0.1">
<h4>
<span class="header-section-number">5.2.0.1</span> Other Test Statistics<a class="anchor" aria-label="anchor" href="#other-test-statistics"><i class="fas fa-link"></i></a>
</h4>
<p>The example in class used a modification of the ANOVA F-statistic to compare the observed data with the permuted data test statistics. Depending on the data and question, the permuted test statistic can take on any of a variety of forms.</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="left">Data</th>
<th align="center">Hypothesis Question</th>
<th align="center">Statistic</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">2 categorical</td>
<td align="center">diff in prop</td>
<td align="center">
<span class="math inline">\(\hat{p}_1 - \hat{p}_2\)</span> or <span class="math inline">\(\chi^2\)</span>
</td>
</tr>
<tr class="even">
<td align="left">variables</td>
<td align="center">ratio of prop</td>
<td align="center"><span class="math inline">\(\hat{p}_1 / \hat{p}_2\)</span></td>
</tr>
<tr class="odd">
<td align="left">1 numeric</td>
<td align="center">diff in means</td>
<td align="center"><span class="math inline">\(\overline{X}_1 - \overline{X}_2\)</span></td>
</tr>
<tr class="even">
<td align="left">1 binary</td>
<td align="center">ratio of means</td>
<td align="center"><span class="math inline">\(\overline{X}_1 / \overline{X}_2\)</span></td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center">diff in medians</td>
<td align="center"><span class="math inline">\(\mbox{median}_1 - \mbox{median}_2\)</span></td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center">ratio of medians</td>
<td align="center"><span class="math inline">\(\mbox{median}_1 / \mbox{median}_2\)</span></td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center">diff in SD</td>
<td align="center"><span class="math inline">\(s_1 - s_2\)</span></td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center">diff in var</td>
<td align="center"><span class="math inline">\(s^2_1 - s^2_2\)</span></td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="center">ratio of SD or VAR</td>
<td align="center"><span class="math inline">\(s_1 / s_2\)</span></td>
</tr>
<tr class="even">
<td align="left">1 numeric</td>
<td align="center">diff in means</td>
<td align="center">
<span class="math inline">\(\sum n_i (\overline{X}_i - \overline{X})^2\)</span> or</td>
</tr>
<tr class="odd">
<td align="left">k groups</td>
<td align="center"></td>
<td align="center">F stat</td>
</tr>
<tr class="even">
<td align="left">paired or</td>
<td align="center">(permute <em>within</em> row)</td>
<td align="center"><span class="math inline">\(\overline{X}_1 - \overline{X}_2\)</span></td>
</tr>
<tr class="odd">
<td align="left">repeated measures</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="left">regression</td>
<td align="center">correlation</td>
<td align="center">least sq slope</td>
</tr>
<tr class="odd">
<td align="left">time series</td>
<td align="center">no serial corr</td>
<td align="center">lag 1 autocross</td>
</tr>
</tbody>
</table></div>
<p>Depending on the data, hypotheses, and original data collection structure (e.g., random sampling vs random allocation), the choice of statistic for the permutation test will vary.</p>
</div>
<div id="permutation-vs.-randomization-tests" class="section level3" number="5.2.1">
<h3>
<span class="header-section-number">5.2.1</span> Permutation vs. Randomization Tests<a class="anchor" aria-label="anchor" href="#permutation-vs.-randomization-tests"><i class="fas fa-link"></i></a>
</h3>
<p>We will call <strong>randomization tests</strong> those that enumerate <em>all</em> possible data permutations. <strong>permutation tests</strong>, on the other hand, will permute the data <span class="math inline">\(B\)</span> (<span class="math inline">\(&lt; &lt;\)</span> all) times. [Some authors call a permutation test applied to a randomized experiment a randomization test, but we will use the term randomization to indicate that all possible permutations have been considered.]</p>
<ul>
<li>Main difference: randomization tests consider every possible permutation of the labels, permutation tests take a random sample of permutations of the labels.</li>
<li>Both can only be applied to a comparison situation (e.g., no one sample t-tests).</li>
<li>Both permute labels under <span class="math inline">\(H_0\)</span>, for example, <span class="math inline">\(H_0: F(x) = G(x)\)</span>.</li>
<li>Both can be used in situations where sampling distributions are unknown (e.g., differences in medians).</li>
<li>Both can be used in situations where sampling distributions are based on population distributions (e.g., ratio of variances).</li>
<li>Randomization tests were the first nonparametric tests conceived (R.A. Fisher, 1935).</li>
</ul>
<div id="randomization-p-value" class="section level4 unnumbered">
<h4>Randomization p-value<a class="anchor" aria-label="anchor" href="#randomization-p-value"><i class="fas fa-link"></i></a>
</h4>
<p>Let <span class="math inline">\(t^*\)</span> be the observed test statistic. For a two sample test with <span class="math inline">\(N\)</span> total observations and <span class="math inline">\(n\)</span> observations in group 1, there are <span class="math inline">\({N \choose n}\)</span> randomizations, all of which are equally likely under <span class="math inline">\(H_0\)</span>. The p-value then becomes:
<span class="math display">\[\begin{align}
p_R &amp;= P(T \leq t^* | H_0) = \frac{\sum_{i=1}^{{N \choose n}} I(t_i \leq t*)}{{N \choose n}}
\end{align}\]</span>
If we choose a significance level of <span class="math inline">\(\alpha = k/{N \choose n}\)</span>, then the type I error rate is:
<span class="math display">\[\begin{align}
P(\text{type I error}) &amp;= P(p_R \leq \alpha | H_0)\\
&amp;= P\bigg(\sum_{i=1}^{{N \choose n}} I(t_i \leq t*) \leq k | H_0 \bigg)\\
&amp;= \frac{k}{{N \choose n}}= \alpha\\
\text{alternatively }  k&amp;= \alpha {N \choose n}
\end{align}\]</span>
The point of which is to say that the randomization test controls the probability of a Type I error under the very minimal conditions that the subjects are randomized to treatments (a minimal condition, but hard to do in practice!!)</p>
</div>
<div id="permutation-p-value" class="section level4 unnumbered">
<h4>Permutation p-value<a class="anchor" aria-label="anchor" href="#permutation-p-value"><i class="fas fa-link"></i></a>
</h4>
<p>Now consider a permutation test that randomly permutes the data <span class="math inline">\(B\)</span> times (instead of all <span class="math inline">\({N \choose n}\)</span> times). A permutation test approximates a randomization test. In fact, the permutation test can be analyzed using the following binomial random variable:
<span class="math display">\[\begin{align}
X_P &amp;= \# \ \mbox{permutations out of B that give a more extreme value than the observed test statistic}\\
X_P &amp;\sim Bin(p_R, B)\\
SE(X_P) &amp;= \sqrt{\frac{p_R (1-p_R)}{B}} \approx \sqrt{\frac{\hat{p}_P (1-\hat{p}_P)}{B}}
\end{align}\]</span></p>
<p>Consider a situation where interest is in a small effect, say p-value<span class="math inline">\(\approx 0.01\)</span>. The SE should be less than 0.001.
<span class="math display">\[\begin{align}
0.001 &amp;= \sqrt{ (0.01)\cdot(0.99) / B}\\
B &amp;= (0.01) \cdot (0.99) / (0.001)^2\\
&amp;= 9900
\end{align}\]</span></p>
<p>Another way to look at the same problem is to use the estimated p-value = <span class="math inline">\(\hat{p}_P = \frac{X_P}{B}\)</span> to come up with a confidence interval for <span class="math inline">\(p_R\)</span>.</p>
<p>CI for <span class="math inline">\(p_R \approx \hat{p}_P \pm 1.96 \sqrt{\frac{\hat{p}_P (1-\hat{p}_P)}{B}}\)</span></p>
</div>
</div>
<div id="ci-from-permutation-tests" class="section level3" number="5.2.2">
<h3>
<span class="header-section-number">5.2.2</span> CI from Permutation Tests<a class="anchor" aria-label="anchor" href="#ci-from-permutation-tests"><i class="fas fa-link"></i></a>
</h3>
<p>Use shifts or rescaling to create a CI for a parameter value using permutation tests. That is, consider a situation with data from <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> Use one of the following transformation (depending on the study):
<span class="math display">\[\begin{align}
W &amp;= Y + a\\
\mbox{or } U &amp;= Y / b
\end{align}\]</span>
and run the permutation test of interest on <span class="math inline">\(X\)</span> vs. <span class="math inline">\(W\)</span> or <span class="math inline">\(X\)</span> vs. <span class="math inline">\(U\)</span>. For a series of <span class="math inline">\(a\)</span> or <span class="math inline">\(b\)</span> values we can find which we don’t reject at a particular level of significance (<span class="math inline">\(\alpha\)</span>) to create a <span class="math inline">\((1-\alpha)100\%\)</span> confidence interval.</p>
<p>Usually, however, we use bootstrapping for confidence intervals and permutation tests for hypothesis testing.</p>
</div>
<div id="randomization-example" class="section level3" number="5.2.3">
<h3>
<span class="header-section-number">5.2.3</span> Randomization Example<a class="anchor" aria-label="anchor" href="#randomization-example"><i class="fas fa-link"></i></a>
</h3>
<div id="fishers-exact-test-computationally-efficient-randomization-test" class="section level4" number="5.2.3.1">
<h4>
<span class="header-section-number">5.2.3.1</span> Fisher’s Exact Test – computationally efficient randomization test<a class="anchor" aria-label="anchor" href="#fishers-exact-test-computationally-efficient-randomization-test"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>N observations are classified into a 2x2 table.</li>
<li>Each observation is classified into exactly one cell.</li>
<li>Row and column totals are fixed.</li>
</ul>
<p>Given fixed row and column totals, we can easily calculate the interior distribution using the hypergeometric. Note that once a single cell is filled, all other cells are determined.</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="center"></th>
<th align="center">Col 1</th>
<th align="center">Col 2</th>
<th align="center">Total</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Row 1</td>
<td align="center">X</td>
<td align="center">r-X</td>
<td align="center">r</td>
</tr>
<tr class="even">
<td align="center">Row 2</td>
<td align="center">c-X</td>
<td align="center">N-r-c+X</td>
<td align="center">N-r</td>
</tr>
<tr class="odd">
<td align="center">Total</td>
<td align="center">c</td>
<td align="center">N-c</td>
<td align="center">N</td>
</tr>
</tbody>
</table></div>
<p><span class="math display">\[\begin{align}
P(X=x) &amp;= \frac{{r \choose x}{{N-r} \choose{c-x}}}{{N \choose c}}\\
&amp; \mbox{out of those in col 1, how many are in row 1?}\\
P(X \leq x) &amp;= \sum_{i=0}^x \frac{{r \choose i}{{N-r} \choose {c-i}}}{{N \choose c}}\\
&amp;= \mbox{p-value}
\end{align}\]</span></p>
<p>Not common for both row and column totals to be fixed. (More likely for just column totals to be fixed, e.g., men and women.) Instead, consider all subsets of the sample space with <span class="math inline">\(N\)</span> observations. For any particular combination of row and column totals (<span class="math inline">\(rc\)</span>):</p>
<p><span class="math display">\[\begin{align}
P(\mbox{rejecting } H_0 | rc, H_0) &amp;\leq&amp; \alpha\\
P(\mbox{rejecting } H_0 \ \ \forall \mbox{ subsets } | H_0) &amp;\leq&amp; \sum_{rc \ combos} P(\mbox{rejecting } H_0 | rc, H_0) P(rc | H_0)\\
&amp;\leq&amp; \alpha
\end{align}\]</span></p>
<p>(Note: assume $P(rc | H_0) = 1 / # rc $ combos.) The test will be valid at any <span class="math inline">\(\alpha\)</span> level, but it won’t be as powerful as one in which fixed columns/rows is actually meaningful.</p>
</div>
<div id="r-times-c-tables" class="section level4" number="5.2.3.2">
<h4>
<span class="header-section-number">5.2.3.2</span> <span class="math inline">\(r \times c\)</span> tables<a class="anchor" aria-label="anchor" href="#r-times-c-tables"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>permute data in a new way</li>
<li>new test stat
<span class="math display">\[\begin{align}
T = \sum_{i,j} \frac{(O_{i,j} - E_{i,j})^2}{E_{i,j}}
\end{align}\]</span>
</li>
<li>2-sided p-value. what do we expect?
<span class="math display">\[\begin{align}
E_{i,j} = \frac{R_i C_j}{N}
\end{align}\]</span>
</li>
</ul>
<div id="example-observer" class="section level5" number="5.2.3.2.1">
<h5>
<span class="header-section-number">5.2.3.2.1</span> Example: Observer<a class="anchor" aria-label="anchor" href="#example-observer"><i class="fas fa-link"></i></a>
</h5>
<p>In a study published in the <em>Journal of Personality and Social Psychology</em> (Butler and Baumeister, 1998), researchers investigated a conjecture that having an observer with a vested interest would decrease subjects’ performance on a skill-based task. Subjects were given time to practice playing a video game that required them to navigate an obstacle course as quickly as possible. They were then told to play the game on final time with an observer present. Subjects were randomly assigned to one of two groups:</p>
<ul>
<li>Group A was told that the participant and the observer would each win $3 if the participant beat a certain threshold.</li>
<li>Group B was told that only that the participant would win the prize if the threshold was beaten.</li>
</ul>
<p>The goal of this data analysis is to determine whether or not there is an effect from the observer on the performance. That is, like the <span class="math inline">\(\chi^2\)</span> test, our hypotheses are:</p>
<p><span class="math inline">\(H_0:\)</span> there is no association between the two variables
<span class="math inline">\(H_a:\)</span> there is an association between the two variables</p>
<p>The data from the 24 subjects is given below:</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="center"></th>
<th align="center">A: shares prize</th>
<th align="center">B: no sharing</th>
<th align="center">Total</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Beat threshold</td>
<td align="center">3</td>
<td align="center">8</td>
<td align="center">11</td>
</tr>
<tr class="even">
<td align="center">Did not beat threshold</td>
<td align="center">9</td>
<td align="center">4</td>
<td align="center">13</td>
</tr>
<tr class="odd">
<td align="center">Total</td>
<td align="center">12</td>
<td align="center">12</td>
<td align="center">24</td>
</tr>
</tbody>
</table></div>
<ol style="list-style-type: decimal">
<li>Card simulation (to demonstrate how the permutation test works)</li>
<li>Permutation Test (see Chance and Rossman applet for automated permutation test, <a href="http://www.rossmanchance.com/applets/ChisqShuffle.htm?FET=1" class="uri">http://www.rossmanchance.com/applets/ChisqShuffle.htm?FET=1</a>)</li>
</ol>
<p><span class="math display">\[\begin{align}
SE(\mbox{p-value}) = \sqrt{\frac{\hat{p}_r (1-\hat{p}_r)}{100}} = 0.02
\end{align}\]</span></p>
<ol start="3" style="list-style-type: decimal">
<li>Randomization Test
<span class="math display">\[\begin{align}
P(X \leq 3) = \sum_{i=0}^3 \frac{{11 \choose i}{12 \choose {12-i}}}{{24 \choose 12}} = 0.0436
\end{align}\]</span>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="r-examples" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> R examples<a class="anchor" aria-label="anchor" href="#r-examples"><i class="fas fa-link"></i></a>
</h2>
<div id="cloud-seeding-two-sample-test-computationally-very-difficult-to-do-a-randomization-test" class="section level3" number="5.3.1">
<h3>
<span class="header-section-number">5.3.1</span> Cloud Seeding (Two sample test – computationally very difficult to do a randomization test)<a class="anchor" aria-label="anchor" href="#cloud-seeding-two-sample-test-computationally-very-difficult-to-do-a-randomization-test"><i class="fas fa-link"></i></a>
</h3>
<p>Cloud seeding data: seeding or not seeding was randomly allocated to 52 days when seeding was appropriate. The pilot did not know whether or not the plane was seeding. Rain is measured in acre-feet.</p>
<p>After running tests to compare means and variances we obtain the following p-values:</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th></th>
<th align="center">comparison of means</th>
<th align="center"></th>
<th align="center">comparison of variances</th>
<th align="center"></th>
</tr></thead>
<tbody>
<tr class="odd">
<td></td>
<td align="center">Permutation</td>
<td align="center">t-test</td>
<td align="center">Permutation</td>
<td align="center">F-test</td>
</tr>
<tr class="even">
<td>Raw Data</td>
<td align="center">0.031</td>
<td align="center">0.054</td>
<td align="center">0.068</td>
<td align="center">0.000067</td>
</tr>
<tr class="odd">
<td>Logged Data</td>
<td align="center">0.010</td>
<td align="center">0.014</td>
<td align="center">0.535</td>
<td align="center">0.897</td>
</tr>
</tbody>
</table></div>
<div id="r-code" class="section level4" number="5.3.1.1">
<h4>
<span class="header-section-number">5.3.1.1</span> R code<a class="anchor" aria-label="anchor" href="#r-code"><i class="fas fa-link"></i></a>
</h4>
<p>Before doing anything, let’s look at the data. Here, we visualize with both boxplots and histograms. Also, we visualize on the raw scale as well as the log scale. Certainly, the log10 scale indicates that a transformation makes the data more symmetric.</p>
<div class="sourceCode" id="cb362"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">clouds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/readr/man/read_delim.html">read_delim</a></span><span class="op">(</span><span class="st">"https://dasl.datadescription.com/download/data/3117/cloud-seeding.txt"</span>, 
     <span class="st">"\t"</span>, escape_double <span class="op">=</span> <span class="cn">FALSE</span>, trim_ws <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> 

<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">clouds</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"unseeded"</span>, <span class="st">"seeded"</span><span class="op">)</span>
<span class="va">clouds</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tidyr/man/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="va">clouds</span>, cols <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, names_to <span class="op">=</span> <span class="st">"seeding"</span>, values_to <span class="op">=</span> <span class="st">"rainfall"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>seeding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">seeding</span><span class="op">)</span><span class="op">)</span>

<span class="va">clouds</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">seeding</span>, y<span class="op">=</span><span class="va">rainfall</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-permutation_files/figure-html/unnamed-chunk-2-1.png" width="480" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb363"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">clouds</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">rainfall</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">seeding</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-permutation_files/figure-html/unnamed-chunk-2-2.png" width="480" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb364"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">clouds</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">seeding</span>, y<span class="op">=</span><span class="va">rainfall</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-permutation_files/figure-html/unnamed-chunk-3-1.png" width="480" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb365"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">clouds</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">rainfall</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">seeding</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/scale_continuous.html">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-permutation_files/figure-html/unnamed-chunk-3-2.png" width="480" style="display: block; margin: auto;"></div>
<p><strong>unlogged data:</strong></p>
<div class="sourceCode" id="cb366"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">clouds</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>lnrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">rainfall</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">seeding</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>meanrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">rainfall</span><span class="op">)</span>, meanlnrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">lnrain</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##   seeding  meanrain meanlnrain
##   &lt;fct&gt;       &lt;dbl&gt;      &lt;dbl&gt;
## 1 seeded       442.       5.13
## 2 unseeded     165.       3.99</code></pre>
<div class="sourceCode" id="cb368"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">clouds</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>lnrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">rainfall</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">seeding</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>meanrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">rainfall</span><span class="op">)</span>, meanlnrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">lnrain</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">meanrain</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">meanlnrain</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 2
##   `diff(meanrain)` `diff(meanlnrain)`
##              &lt;dbl&gt;              &lt;dbl&gt;
## 1            -277.              -1.14</code></pre>
<div class="sourceCode" id="cb370"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raindiffs</span> <span class="op">&lt;-</span> <span class="va">clouds</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>lnrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">rainfall</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">seeding</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>meanrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">rainfall</span><span class="op">)</span>, meanlnrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">lnrain</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>diffrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">meanrain</span><span class="op">)</span>, difflnrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">meanlnrain</span><span class="op">)</span><span class="op">)</span>

<span class="va">raindiffs</span></code></pre></div>
<pre><code>## # A tibble: 1 x 2
##   diffrain difflnrain
##      &lt;dbl&gt;      &lt;dbl&gt;
## 1    -277.      -1.14</code></pre>
<p>Below, we’ve formally gone through a permutation. here, the resampling is not coded in a particularly tidy way, but there is a tidy way to code loops! Generally, loops are not the fasted way to code in R, so if you need to quickly run code that seems like it should go in a loop, it is very likely that <code>purrr</code> is the direction you want to go, <a href="https://purrr.tidyverse.org/" class="uri">https://purrr.tidyverse.org/</a>.</p>
<div id="difference-in-means-after-permuting" class="section level5" number="5.3.1.1.1">
<h5>
<span class="header-section-number">5.3.1.1.1</span> Difference in means after permuting<a class="anchor" aria-label="anchor" href="#difference-in-means-after-permuting"><i class="fas fa-link"></i></a>
</h5>
<div class="sourceCode" id="cb372"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reps</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">permdiffs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">reps</span><span class="op">)</span><span class="op">{</span>
  <span class="va">onediff</span> <span class="op">&lt;-</span> <span class="va">clouds</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>permseed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/resample.html">sample</a></span><span class="op">(</span><span class="va">seeding</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">permseed</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>meanrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">rainfall</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">meanrain</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span>
  
<span class="va">permdiffs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">permdiffs</span>, <span class="va">onediff</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">permdiffs</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">permdiffs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>bins<span class="op">=</span><span class="fl">30</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">raindiffs</span><span class="op">$</span><span class="va">diffrain</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-permutation_files/figure-html/unnamed-chunk-5-1.png" width="480" style="display: block; margin: auto;"></div>
</div>
<div id="ratio-of-variances-after-permuting" class="section level5" number="5.3.1.1.2">
<h5>
<span class="header-section-number">5.3.1.1.2</span> Ratio of variances after permuting<a class="anchor" aria-label="anchor" href="#ratio-of-variances-after-permuting"><i class="fas fa-link"></i></a>
</h5>
<div class="sourceCode" id="cb373"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rainvarratio</span> <span class="op">&lt;-</span> <span class="va">clouds</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">seeding</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>varrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">var</a></span><span class="op">(</span><span class="va">rainfall</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>rainratio <span class="op">=</span> <span class="va">varrain</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="va">varrain</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>


<span class="va">reps</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">permvars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">reps</span><span class="op">)</span><span class="op">{</span>
  <span class="va">oneratio</span> <span class="op">&lt;-</span> <span class="va">clouds</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>permseed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/resample.html">sample</a></span><span class="op">(</span><span class="va">seeding</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">permseed</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>varrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">var</a></span><span class="op">(</span><span class="va">rainfall</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span><span class="va">varrain</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="va">varrain</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span>
  
<span class="va">permvars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">permvars</span>, <span class="va">oneratio</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">permvars</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">permvars</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>bins<span class="op">=</span><span class="fl">30</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">rainvarratio</span><span class="op">$</span><span class="va">rainratio</span> , color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-permutation_files/figure-html/unnamed-chunk-6-1.png" width="480" style="display: block; margin: auto;"></div>
</div>
<div id="testing-differences-in-means-or-ratios-of-variances" class="section level5" number="5.3.1.1.3">
<h5>
<span class="header-section-number">5.3.1.1.3</span> Testing differences in means or ratios of variances<a class="anchor" aria-label="anchor" href="#testing-differences-in-means-or-ratios-of-variances"><i class="fas fa-link"></i></a>
</h5>
<p>As evidenced in the histograms above,</p>
<ul>
<li><p>the permutation test (one-sided) for the difference in means will count the number of permuted differences that are less than or equal to the observed difference in means, just over 1%.</p></li>
<li><p>the permutation test (one-sided) for the ratio of variances will count the number of permuted ratios that are greater than or equal to the observed ratio of variances, about 7%.</p></li>
</ul>
<div class="sourceCode" id="cb374"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">sum</a></span><span class="op">(</span><span class="va">raindiffs</span><span class="op">$</span><span class="va">diffrain</span> <span class="op">&gt;=</span> <span class="va">permdiffs</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span><span class="fl">1000</span></code></pre></div>
<pre><code>## [1] 0.027</code></pre>
<div class="sourceCode" id="cb376"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">sum</a></span><span class="op">(</span><span class="va">rainvarratio</span><span class="op">$</span><span class="va">rainratio</span> <span class="op">&lt;=</span> <span class="va">permvars</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span></code></pre></div>
<pre><code>## [1] 0.081</code></pre>
<!--

need to add b to one side before permuting.  R code was getting complicated.

#####  How can permutations be used to create confidence intervals?

To find a CI for the difference in locations of the distributions of the seeded vs. unseeded rainfall, we shift the unseeded values by some amount, and do our usual hypothesis test.  Our CI will be those values we don't reject for a given $\alpha$. Here:

|   | b test value  |   |   |   |   |   |   |   |   |   |
|---    |:------------: |:----: |:----: |:----: |:----: |:----: |:----: |:----: |:----: |:----: |
|   | 0     | 20    | 50    | 100   | 300   | 400   | 500   | 550   | 570   | 600   |
| p     | 0.027     | 0.03  | 0.05  | 0.11  | 0.56  | 0.80  | 0.94  | 0.98  | 0.98  | 0.99  |


where p is the proportion of simulated test statistics greater than or equal to our observed value (after shifting by an amount "b").


```r
reps <- 1000
raindiffs <- clouds %>%
  mutate(lnrain = log(rainfall)) %>%
  group_by(seeding) %>%
  summarize(meanrain = mean(rainfall)) %>%
  summarize(diffrain = diff(meanrain))

for(b in c(0,20,50,100,300,400,500,550,570,600)){
  

permdiffs <- c()

for(i in 1:reps){
  onediff <- clouds %>%
    mutate(permseed = sample(seeding)) %>%
    group_by(permseed) %>%
    summarize(meanrain = mean(rainfall)) %>%
    summarize(diff(meanrain)) %>% pull()
  
permdiffs <- c(permdiffs, onediff)
}

cloud.ci<-cbind(rainfall=c(cloud[,1]+c(rep(b,26),rep(0,26))),cloud[,2])

obs.um.ci.stat<-tapply(cloud.ci[,1],cloud.ci[,2],mean)[2] -
tapply(cloud.ci[,1],cloud.ci[,2],mean)[1]


perm.um.ci.stat<-c()

for(i in 1:3999){
     cloud.ci2<-sample(cloud.ci[,1],52,replace=F)
     perm.um.ci.stat<-c(perm.um.ci.stat,tapply(cloud.ci2,cloud[,2],mean)[1] -
    tapply(cloud.ci2,cloud[,2],mean)[2])
    }

print((sum(obs.um.ci.stat>=perm.um.ci.stat)+1)/4000)
}
```

-->
</div>
</div>
</div>
<div id="macnell-teaching-evaluations-stratified-two-sample-t-test" class="section level3" number="5.3.2">
<h3>
<span class="header-section-number">5.3.2</span> MacNell Teaching Evaluations (Stratified two-sample t-test)<a class="anchor" aria-label="anchor" href="#macnell-teaching-evaluations-stratified-two-sample-t-test"><i class="fas fa-link"></i></a>
</h3>
<p>Boring et al. (2016) reanalyze data from MacNell et al. (2014). Students were randomized to 4 online sections of a course. In two sections, the instructors swapped identities. Was the instructor who identified as female rated lower on average? (<a href="https://www.math.upenn.edu/~pemantle/active-papers/Evals/stark2016.pdf" class="uri">https://www.math.upenn.edu/~pemantle/active-papers/Evals/stark2016.pdf</a>)</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-91"></span>
<img src="figs/genderbias2a.png" alt="@genderbias3" width="100%"><p class="caption">
Figure 5.1: <span class="citation"><a href="references.html#ref-genderbias3" role="doc-biblioref">Kraj</a> (<a href="references.html#ref-genderbias3" role="doc-biblioref">2017</a>)</span>
</p>
</div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-92"></span>
<img src="figs/genderbias2b.png" alt="@genderbias3" width="100%"><p class="caption">
Figure 5.2: <span class="citation"><a href="references.html#ref-genderbias3" role="doc-biblioref">Kraj</a> (<a href="references.html#ref-genderbias3" role="doc-biblioref">2017</a>)</span>
</p>
</div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-10"></span>
<img src="figs/genderbias.png" alt="@genderbias1" width="100%"><p class="caption">
Figure 5.3: <span class="citation"><a href="references.html#ref-genderbias1" role="doc-biblioref">Mengel, Sauermann, and Zölitz</a> (<a href="references.html#ref-genderbias1" role="doc-biblioref">2019</a>)</span>
</p>
</div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-111"></span>
<img src="figs/genderbias3a.png" alt="@genderbias2" width="100%"><p class="caption">
Figure 5.4: <span class="citation"><a href="references.html#ref-genderbias2" role="doc-biblioref">MacNell, Driscoll, and Hunt</a> (<a href="references.html#ref-genderbias2" role="doc-biblioref">2015</a>)</span>
</p>
</div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-112"></span>
<img src="figs/genderbias3b.png" alt="@genderbias2" width="100%"><p class="caption">
Figure 5.5: <span class="citation"><a href="references.html#ref-genderbias2" role="doc-biblioref">MacNell, Driscoll, and Hunt</a> (<a href="references.html#ref-genderbias2" role="doc-biblioref">2015</a>)</span>
</p>
</div>
<div id="r-code-1" class="section level5" number="5.3.2.0.1">
<h5>
<span class="header-section-number">5.3.2.0.1</span> R code<a class="anchor" aria-label="anchor" href="#r-code-1"><i class="fas fa-link"></i></a>
</h5>
<div class="sourceCode" id="cb378"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">macnell</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/readr/man/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/statlab/permuter/master/data-raw/macnell.csv"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb379"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">macnell</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>TAID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">taidgender</span><span class="op">==</span><span class="fl">1</span>, <span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>TAGend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">tagender</span><span class="op">==</span><span class="fl">1</span>, <span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>gendjitter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">tagender</span><span class="op">==</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">0.2</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
<span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">TAGend</span>, y<span class="op">=</span><span class="va">overall</span>, color<span class="op">=</span><span class="va">TAID</span>, fill<span class="op">=</span><span class="va">TAID</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">'white'</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_point.html">geom_point</a></span><span class="op">(</span>position<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/position_jitterdodge.html">position_jitterdodge</a></span><span class="op">(</span>jitter.width<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/stat_summary.html">stat_summary</a></span><span class="op">(</span>fun.y<span class="op">=</span><span class="st">"mean"</span>, geom<span class="op">=</span><span class="st">"point"</span>, size<span class="op">=</span><span class="fl">3</span>,
    position<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/position_dodge.html">position_dodge</a></span><span class="op">(</span>width<span class="op">=</span><span class="fl">0.75</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-permutation_files/figure-html/unnamed-chunk-13-1.png" width="480" style="display: block; margin: auto;"></div>
</div>
<div id="analysis-goal" class="section level4" number="5.3.2.1">
<h4>
<span class="header-section-number">5.3.2.1</span> Analysis goal<a class="anchor" aria-label="anchor" href="#analysis-goal"><i class="fas fa-link"></i></a>
</h4>
<p>Want to know if the score for the <strong>perceived</strong> gender is different.</p>
<p><span class="math display">\[H_0:  \mu_{ID.Female} = \mu_{ID.Male}\]</span></p>
</div>
<div id="macnell-data-without-permutation" class="section level4" number="5.3.2.2">
<h4>
<span class="header-section-number">5.3.2.2</span> MacNell Data without permutation<a class="anchor" aria-label="anchor" href="#macnell-data-without-permutation"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb380"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">macnell</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/select.html">select</a></span><span class="op">(</span><span class="va">overall</span>, <span class="va">tagender</span>, <span class="va">taidgender</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 15 x 3
##    overall tagender taidgender
##      &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
##  1       4        0          1
##  2       4        0          1
##  3       5        0          1
##  4       5        0          1
##  5       5        0          1
##  6       4        0          1
##  7       4        0          1
##  8       5        0          1
##  9       4        0          1
## 10       3        0          1
## 11       5        0          1
## 12       4        0          1
## 13       5        1          1
## 14       5        1          1
## 15       4        1          1</code></pre>
</div>
<div id="permuting-macnell-data" class="section level4" number="5.3.2.3">
<h4>
<span class="header-section-number">5.3.2.3</span> Permuting MacNell data<a class="anchor" aria-label="anchor" href="#permuting-macnell-data"><i class="fas fa-link"></i></a>
</h4>
<p>Conceptually, there are two levels of randomization:</p>
<ol style="list-style-type: decimal">
<li><p><span class="math inline">\(N_m\)</span> students are randomly assigned to the male instructor and the remaining <span class="math inline">\(N_f\)</span> get the female instructor.</p></li>
<li><p>Of the <span class="math inline">\(N_j\)</span> assigned to instructor <span class="math inline">\(j\)</span>, <span class="math inline">\(N_{jm}\)</span> are told that the instructor is male, for <span class="math inline">\(j=1,2\)</span>.</p></li>
</ol>
<p><strong>Stratified two-sample test:</strong></p>
<ul>
<li>For each instructor, permute <em>perceived</em> gender assignments.</li>
<li>Use difference in mean ratings for female-identified vs male-identified instructors.</li>
</ul>
<pre><code class="language-r"><code>macnell %&gt;% <span style="background-color:#ffff7f">group_by(tagender)</span> %&gt;%<br>  mutate(permTAID = sample(taidgender, replace=FALSE)) %&gt;%<br>  select(overall, tagender, taidgender, permTAID) %&gt;% head(15)</code></code></pre>
<pre><code>## # A tibble: 15 x 4
## # Groups:   tagender [2]
##    overall tagender taidgender permTAID
##      &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
##  1       4        0          1        1
##  2       4        0          1        1
##  3       5        0          1        0
##  4       5        0          1        0
##  5       5        0          1        1
##  6       4        0          1        1
##  7       4        0          1        0
##  8       5        0          1        0
##  9       4        0          1        1
## 10       3        0          1        1
## 11       5        0          1        0
## 12       4        0          1        0
## 13       5        1          1        1
## 14       5        1          1        1
## 15       4        1          1        1</code></pre>
<pre><code class="language-r"><code>macnell %&gt;% <span style="background-color:#ffff7f">group_by(tagender)</span> %&gt;%<br>  mutate(permTAID = sample(taidgender, replace=FALSE)) %&gt;%<br>  ungroup(tagender) %&gt;%<br><span style="background-color:#ffff7f">group_by(permTAID)</span> %&gt;%<br>  summarize(pmeans = mean(overall, na.rm=TRUE)) %&gt;%<br>  summarize(diff(pmeans))</code></code></pre>
<pre><code>## # A tibble: 1 x 1
##   `diff(pmeans)`
##            &lt;dbl&gt;
## 1         -0.380</code></pre>
<pre><code class="language-r"><code><span style="background-color:#ffff7f">replicate(5</span>,<br>  macnell %&gt;% group_by(tagender) %&gt;%<br>  mutate(permTAID = sample(taidgender, replace=FALSE)) %&gt;%<br>  ungroup(tagender) %&gt;%<br>  group_by(permTAID) %&gt;%<br>  summarize(pmeans = mean(overall, na.rm=TRUE)) %&gt;%<br>  summarize(diff(pmeans)))</code></code></pre>
<pre><code>## $`diff(pmeans)`
## [1] -0.671
## 
## $`diff(pmeans)`
## [1] -0.1
## 
## $`diff(pmeans)`
## [1] 0.18
## 
## $`diff(pmeans)`
## [1] -0.00652
## 
## $`diff(pmeans)`
## [1] 0.0952</code></pre>
<div class="sourceCode" id="cb385"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">47</span><span class="op">)</span>
<span class="va">reps</span> <span class="op">=</span> <span class="fl">10000</span>
<span class="va">ov.stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="va">reps</span>,
  <span class="va">macnell</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">tagender</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>permTAID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/resample.html">sample</a></span><span class="op">(</span><span class="va">taidgender</span>, replace<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">ungroup</a></span><span class="op">(</span><span class="va">tagender</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">permTAID</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>pmeans <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">overall</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">pmeans</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">ov.stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">ov.stats</span><span class="op">)</span></code></pre></div>
</div>
<div id="permutation-sampling-distribution" class="section level4" number="5.3.2.4">
<h4>
<span class="header-section-number">5.3.2.4</span> permutation sampling distribution:<a class="anchor" aria-label="anchor" href="#permutation-sampling-distribution"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb386"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">ov.stats</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="fl">0.47</span>, col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-permutation_files/figure-html/unnamed-chunk-19-1.png" width="480" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb387"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># brute force permuation</span>
<span class="fl">2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">sum</a></span><span class="op">(</span><span class="va">ov.stats</span> <span class="op">&gt;</span> <span class="fl">0.47</span><span class="op">)</span> <span class="op">/</span> <span class="va">reps</span></code></pre></div>
<pre><code>## [1] 0.113</code></pre>
</div>
<div id="macnell-data-with-different-permutation-tests" class="section level4" number="5.3.2.5">
<h4>
<span class="header-section-number">5.3.2.5</span> MacNell Data with different permutation tests<a class="anchor" aria-label="anchor" href="#macnell-data-with-different-permutation-tests"><i class="fas fa-link"></i></a>
</h4>
<p>The <code>permuter</code> package contains functions for a variety of different permutation tests, including one with stratification.</p>
<div class="sourceCode" id="cb389"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">distr1</span> <span class="op">&lt;-</span> <span class="fu">stratified_two_sample</span><span class="op">(</span>response <span class="op">=</span> <span class="va">macnell</span><span class="op">$</span><span class="va">overall</span>,
                               group <span class="op">=</span>  <span class="va">macnell</span><span class="op">$</span><span class="va">taidgender</span>,
                               stratum <span class="op">=</span> <span class="va">macnell</span><span class="op">$</span><span class="va">tagender</span>,
                               stat <span class="op">=</span> <span class="st">"mean"</span>, reps<span class="op">=</span><span class="va">reps</span><span class="op">)</span>

<span class="va">distr2</span> <span class="op">&lt;-</span> <span class="fu">stratified_two_sample</span><span class="op">(</span>response <span class="op">=</span> <span class="va">macnell</span><span class="op">$</span><span class="va">overall</span>,
                               group <span class="op">=</span>  <span class="va">macnell</span><span class="op">$</span><span class="va">taidgender</span>,
                               stratum <span class="op">=</span> <span class="va">macnell</span><span class="op">$</span><span class="va">tagender</span>,
                               stat <span class="op">=</span> <span class="st">"t"</span>, reps<span class="op">=</span><span class="va">reps</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb390"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">macnell</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">taidgender</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>means <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">overall</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##   `diff(means)`
##           &lt;dbl&gt;
## 1         0.474</code></pre>
<div class="sourceCode" id="cb392"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">macnell</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">taidgender</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>means <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">overall</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, 
            vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">var</a></span><span class="op">(</span><span class="va">overall</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, ns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span><span class="op">(</span><span class="va">means</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">means</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">vars</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="va">ns</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">vars</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">/</span><span class="va">ns</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##   `(means[1] - means[2])/sqrt(vars[1]/ns[1] + vars[2]/ns[2])`
##                                                         &lt;dbl&gt;
## 1                                                       -1.59</code></pre>
<div class="sourceCode" id="cb394"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># brute force permuation</span>
<span class="fl">2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">sum</a></span><span class="op">(</span><span class="va">ov.stats</span> <span class="op">&gt;</span> <span class="fl">0.47</span><span class="op">)</span> <span class="op">/</span> <span class="va">reps</span></code></pre></div>
<pre><code>## [1] 0.113</code></pre>
<div class="sourceCode" id="cb396"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># mean(x) - mean(y)</span>
<span class="fu">t2p</span><span class="op">(</span><span class="fl">0.47</span>, <span class="va">distr1</span>, alternative<span class="op">=</span><span class="st">"two-sided"</span><span class="op">)</span></code></pre></div>
<pre><code>## Two-sided 
##      0.13</code></pre>
<div class="sourceCode" id="cb398"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># t permutation</span>
<span class="fu">t2p</span><span class="op">(</span><span class="op">-</span><span class="fl">1.56</span>, <span class="va">distr2</span>, alternative<span class="op">=</span><span class="st">"two-sided"</span><span class="op">)</span></code></pre></div>
<pre><code>## Two-sided 
##    0.0978</code></pre>
</div>
<div id="actual-macnell-results" class="section level4" number="5.3.2.6">
<h4>
<span class="header-section-number">5.3.2.6</span> Actual MacNell results<a class="anchor" aria-label="anchor" href="#actual-macnell-results"><i class="fas fa-link"></i></a>
</h4>
<div class="inline-figure"><img src="figs/genderbias3c.png" width="100%" style="display: block; margin: auto;"></div>
</div>
</div>
<div id="income-and-health-f-like-test" class="section level3" number="5.3.3">
<h3>
<span class="header-section-number">5.3.3</span> Income and Health (F-like test)<a class="anchor" aria-label="anchor" href="#income-and-health-f-like-test"><i class="fas fa-link"></i></a>
</h3>
<p>Consider the NHANES dataset.</p>
<ul>
<li>Income
<ul>
<li>(HHIncomeMid - Numerical version of HHIncome derived from the middle income in each category)</li>
</ul>
</li>
<li>Health
<ul>
<li>(HealthGen - Self-reported rating of participant’s health in general Reported for participants aged 12 years or older. One of Excellent, Vgood, Good, Fair, or Poor.)</li>
</ul>
</li>
</ul>
<div id="summary-of-the-variables-of-interest" class="section level4" number="5.3.3.1">
<h4>
<span class="header-section-number">5.3.3.1</span> Summary of the variables of interest<a class="anchor" aria-label="anchor" href="#summary-of-the-variables-of-interest"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb400"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NHANES</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/select.html">select</a></span><span class="op">(</span><span class="va">HealthGen</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## .
## Excellent     Vgood      Good      Fair      Poor 
##       878      2508      2956      1010       187</code></pre>
<div class="sourceCode" id="cb402"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NHANES</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/select.html">select</a></span><span class="op">(</span><span class="va">HHIncomeMid</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##   HHIncomeMid    
##  Min.   :  2500  
##  1st Qu.: 30000  
##  Median : 50000  
##  Mean   : 57206  
##  3rd Qu.: 87500  
##  Max.   :100000  
##  NA's   :811</code></pre>
</div>
<div id="mean-income-broken-down-by-health" class="section level4" number="5.3.3.2">
<h4>
<span class="header-section-number">5.3.3.2</span> Mean Income broken down by Health<a class="anchor" aria-label="anchor" href="#mean-income-broken-down-by-health"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb404"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NH.means</span> <span class="op">&lt;-</span> <span class="va">NHANES</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HealthGen</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HHIncomeMid</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">HealthGen</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>IncMean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">HHIncomeMid</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, count<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">NH.means</span></code></pre></div>
<pre><code>## # A tibble: 5 x 3
##   HealthGen IncMean count
##   &lt;fct&gt;       &lt;dbl&gt; &lt;int&gt;
## 1 Excellent  69354.   817
## 2 Vgood      65011.  2342
## 3 Good       55662.  2744
## 4 Fair       44194.   899
## 5 Poor       37027.   164</code></pre>
<p>Are the differences in means simply due to random chance??</p>
<div class="sourceCode" id="cb406"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NHANES</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HealthGen</span><span class="op">)</span><span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HHIncomeMid</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
<span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">HealthGen</span>, y<span class="op">=</span><span class="va">HHIncomeMid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_jitter.html">geom_jitter</a></span><span class="op">(</span>width<span class="op">=</span><span class="fl">0.1</span>, alpha<span class="op">=</span><span class="fl">.2</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-permutation_files/figure-html/unnamed-chunk-27-1.png" width="480" style="display: block; margin: auto;"></div>
<p>The differences in health, can be calculated directly, but we still don’t know if the differences are due to randome chance or some other larger structure.</p>
<div class="sourceCode" id="cb407"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diff.mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">5</span>, nrow<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">diff.mat</span><span class="op">)</span> <span class="op">=</span> <span class="va">NH.means</span><span class="op">$</span><span class="va">HealthGen</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">diff.mat</span><span class="op">)</span> <span class="op">=</span> <span class="va">NH.means</span><span class="op">$</span><span class="va">HealthGen</span>

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span>
    <span class="va">diff.mat</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="va">NH.means</span><span class="op">$</span><span class="va">IncMean</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">NH.means</span><span class="op">$</span><span class="va">IncMean</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>   <span class="op">}</span><span class="op">}</span>

<span class="va">diff.mat</span></code></pre></div>
<pre><code>##           Excellent  Vgood   Good  Fair  Poor
## Excellent         0   4344  13692 25161 32327
## Vgood         -4344      0   9348 20817 27983
## Good         -13692  -9348      0 11469 18635
## Fair         -25161 -20817 -11469     0  7166
## Poor         -32327 -27983 -18635 -7166     0</code></pre>
</div>
<div id="overall-difference" class="section level4" number="5.3.3.3">
<h4>
<span class="header-section-number">5.3.3.3</span> Overall difference<a class="anchor" aria-label="anchor" href="#overall-difference"><i class="fas fa-link"></i></a>
</h4>
<p>We can measure the overall differences as the amount of variability between each of the means and the overall mean:</p>
<p><span class="math display">\[F = \frac{\text{between-group variability}}{\text{within-group variability}}\]</span>
<span class="math display">\[F = \frac{\sum_i n_i(\overline{X}_{i\cdot} - \overline{X})^2/(K-1)}{\sum_{ij} (X_{ij}-\overline{X}_{i\cdot})^2/(N-K)}\]</span>
<span class="math display">\[SumSqBtwn = \sum_i n_i(\overline{X}_{i\cdot} - \overline{X})^2\]</span></p>
</div>
<div id="creating-a-test-statistic" class="section level4" number="5.3.3.4">
<h4>
<span class="header-section-number">5.3.3.4</span> Creating a test statistic<a class="anchor" aria-label="anchor" href="#creating-a-test-statistic"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb409"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NHANES</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/select.html">select</a></span><span class="op">(</span><span class="va">HHIncomeMid</span>, <span class="va">HealthGen</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HealthGen</span><span class="op">)</span><span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HHIncomeMid</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 2
##   HHIncomeMid HealthGen
##         &lt;int&gt; &lt;fct&gt;    
## 1       30000 Good     
## 2       30000 Good     
## 3       30000 Good     
## 4       40000 Good     
## 5       87500 Vgood    
## 6       87500 Vgood</code></pre>
<div class="sourceCode" id="cb411"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">GM</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">NHANES</span><span class="op">$</span><span class="va">HHIncomeMid</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>; <span class="va">GM</span></code></pre></div>
<pre><code>## [1] 57206</code></pre>
<div class="sourceCode" id="cb413"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NH.means</span></code></pre></div>
<pre><code>## # A tibble: 5 x 3
##   HealthGen IncMean count
##   &lt;fct&gt;       &lt;dbl&gt; &lt;int&gt;
## 1 Excellent  69354.   817
## 2 Vgood      65011.  2342
## 3 Good       55662.  2744
## 4 Fair       44194.   899
## 5 Poor       37027.   164</code></pre>
<div class="sourceCode" id="cb415"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NH.means</span><span class="op">$</span><span class="va">IncMean</span> <span class="op">-</span> <span class="va">GM</span></code></pre></div>
<pre><code>## [1]  12148   7805  -1544 -13013 -20179</code></pre>
<div class="sourceCode" id="cb417"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">NH.means</span><span class="op">$</span><span class="va">IncMean</span> <span class="op">-</span> <span class="va">GM</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></code></pre></div>
<pre><code>## [1] 1.48e+08 6.09e+07 2.38e+06 1.69e+08 4.07e+08</code></pre>
<div class="sourceCode" id="cb419"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NH.means</span><span class="op">$</span><span class="va">count</span></code></pre></div>
<pre><code>## [1]  817 2342 2744  899  164</code></pre>
<div class="sourceCode" id="cb421"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NH.means</span><span class="op">$</span><span class="va">count</span> <span class="op">*</span> <span class="op">(</span><span class="va">NH.means</span><span class="op">$</span><span class="va">IncMean</span> <span class="op">-</span> <span class="va">GM</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></code></pre></div>
<pre><code>## [1] 1.21e+11 1.43e+11 6.54e+09 1.52e+11 6.68e+10</code></pre>
<p><span class="math display">\[SumSqBtwn = \sum_i n_i(\overline{X}_{i\cdot} - \overline{X})^2\]</span></p>
<div class="sourceCode" id="cb423"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">sum</a></span><span class="op">(</span><span class="va">NH.means</span><span class="op">$</span><span class="va">count</span> <span class="op">*</span> <span class="op">(</span><span class="va">NH.means</span><span class="op">$</span><span class="va">IncMean</span> <span class="op">-</span> <span class="va">GM</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 4.89e+11</code></pre>
</div>
<div id="permuting-the-data" class="section level4" number="5.3.3.5">
<h4>
<span class="header-section-number">5.3.3.5</span> Permuting the data<a class="anchor" aria-label="anchor" href="#permuting-the-data"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb425"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NHANES</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HealthGen</span><span class="op">)</span><span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HHIncomeMid</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>IncomePerm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/resample.html">sample</a></span><span class="op">(</span><span class="va">HHIncomeMid</span>, replace<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/select.html">select</a></span><span class="op">(</span><span class="va">HealthGen</span>, <span class="va">HHIncomeMid</span>, <span class="va">IncomePerm</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##   HealthGen HHIncomeMid IncomePerm
##   &lt;fct&gt;           &lt;int&gt;      &lt;int&gt;
## 1 Good            30000     100000
## 2 Good            30000      87500
## 3 Good            30000      17500
## 4 Good            40000      60000
## 5 Vgood           87500      50000
## 6 Vgood           87500     100000</code></pre>
</div>
<div id="permuting-the-data-a-new-test-statistic" class="section level4" number="5.3.3.6">
<h4>
<span class="header-section-number">5.3.3.6</span> Permuting the data &amp; a new test statistic<a class="anchor" aria-label="anchor" href="#permuting-the-data-a-new-test-statistic"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb427"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NHANES</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HealthGen</span><span class="op">)</span><span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HHIncomeMid</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>IncomePerm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/resample.html">sample</a></span><span class="op">(</span><span class="va">HHIncomeMid</span>, replace<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">HealthGen</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>IncMeanP <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">IncomePerm</span><span class="op">)</span>, count<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>teststat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">*</span><span class="op">(</span><span class="va">IncMeanP</span> <span class="op">-</span> <span class="va">GM</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##       teststat
##          &lt;dbl&gt;
## 1 12553059728.</code></pre>
</div>
<div id="lots-of-times" class="section level4" number="5.3.3.7">
<h4>
<span class="header-section-number">5.3.3.7</span> Lots of times…<a class="anchor" aria-label="anchor" href="#lots-of-times"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb429"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reps</span> <span class="op">=</span> <span class="fl">1000</span>
<span class="va">SSB</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="va">reps</span>, 
     <span class="va">NHANES</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HealthGen</span><span class="op">)</span><span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HHIncomeMid</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>IncomePerm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/resample.html">sample</a></span><span class="op">(</span><span class="va">HHIncomeMid</span>, replace<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">HealthGen</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>IncMeanP <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">IncomePerm</span><span class="op">)</span>, count<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>teststat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">*</span><span class="op">(</span><span class="va">IncMeanP</span> <span class="op">-</span> <span class="va">GM</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
      <span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">SSB</span><span class="op">)</span></code></pre></div>
<pre><code>## teststat teststat teststat teststat teststat teststat 
## 1.45e+10 1.60e+10 1.38e+10 1.32e+10 1.37e+10 1.44e+10</code></pre>
</div>
<div id="compared-to-the-real-data" class="section level4" number="5.3.3.8">
<h4>
<span class="header-section-number">5.3.3.8</span> Compared to the real data<a class="anchor" aria-label="anchor" href="#compared-to-the-real-data"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb431"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">obsSSB</span> <span class="op">&lt;-</span> <span class="va">NHANES</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HealthGen</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HHIncomeMid</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">HealthGen</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>IncMean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">mean</a></span><span class="op">(</span><span class="va">HHIncomeMid</span><span class="op">)</span>, count<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>obs.teststat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">*</span><span class="op">(</span><span class="va">IncMean</span> <span class="op">-</span> <span class="va">GM</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="va">obsSSB</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##    obs.teststat
##           &lt;dbl&gt;
## 1 488767088754.</code></pre>
<div class="sourceCode" id="cb433"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mosaic/man/aggregating.html">sum</a></span><span class="op">(</span><span class="va">SSB</span><span class="op">&gt;</span><span class="va">obsSSB</span><span class="op">)</span> <span class="op">/</span> <span class="va">reps</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb435"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">SSB</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">6e+11</span><span class="op">)</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">obsSSB</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-permutation_files/figure-html/unnamed-chunk-37-1.png" width="480" style="display: block; margin: auto;"></div>

</div>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="sims.html"><span class="header-section-number">4</span> Simulating</a></div>
<div class="next"><a href="boot.html"><span class="header-section-number">6</span> Bootstrapping</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#permschp"><span class="header-section-number">5</span> Permutation Tests</a></li>
<li>
<a class="nav-link" href="#algs"><span class="header-section-number">5.1</span> Inference Algorithms</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#hypothesis-test-algorithm"><span class="header-section-number">5.1.1</span> Hypothesis Test Algorithm</a></li>
<li><a class="nav-link" href="#permutation-tests-algorithm"><span class="header-section-number">5.1.2</span> Permutation Tests Algorithm</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#perms"><span class="header-section-number">5.2</span> Permutation tests in practice</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#permutation-vs.-randomization-tests"><span class="header-section-number">5.2.1</span> Permutation vs. Randomization Tests</a></li>
<li><a class="nav-link" href="#ci-from-permutation-tests"><span class="header-section-number">5.2.2</span> CI from Permutation Tests</a></li>
<li><a class="nav-link" href="#randomization-example"><span class="header-section-number">5.2.3</span> Randomization Example</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#r-examples"><span class="header-section-number">5.3</span> R examples</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#cloud-seeding-two-sample-test-computationally-very-difficult-to-do-a-randomization-test"><span class="header-section-number">5.3.1</span> Cloud Seeding (Two sample test – computationally very difficult to do a randomization test)</a></li>
<li><a class="nav-link" href="#macnell-teaching-evaluations-stratified-two-sample-t-test"><span class="header-section-number">5.3.2</span> MacNell Teaching Evaluations (Stratified two-sample t-test)</a></li>
<li><a class="nav-link" href="#income-and-health-f-like-test"><span class="header-section-number">5.3.3</span> Income and Health (F-like test)</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/hardin47/website/blob/master/05-permutation.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/hardin47/website/edit/master/05-permutation.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Computational Statistics</strong>" was written by Jo Hardin. It was last built on 2021-11-02.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
