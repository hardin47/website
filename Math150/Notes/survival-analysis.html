<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 6 Survival Analysis | Methods in Biostatistics</title>
<meta name="author" content="Jo Hardin">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.7.6/header-attrs.js"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.4.9000/tabs.js"></script><script src="libs/bs3compat-0.2.4.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet">
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script><script type="text/x-mathjax-config">
    const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
    for (let popover of popovers){
      const div = document.createElement('div');
      div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
      div.innerHTML = popover.getAttribute('data-content');
      
      // Will this work with TeX on its own line?
      var has_math = div.querySelector("span.math");
      if (has_math) {
        document.body.appendChild(div);
      	MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
      	MathJax.Hub.Queue(function(){
          popover.setAttribute('data-content', div.innerHTML);
      	})
      }
    }
    </script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Methods in Biostatistics</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Class Information</a></li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="t-tests-vs-slr.html"><span class="header-section-number">2</span> t-tests vs SLR</a></li>
<li><a class="" href="SLR.html"><span class="header-section-number">3</span> Simple Linear Regression</a></li>
<li><a class="" href="analysis-of-categorical-data.html"><span class="header-section-number">4</span> Analysis of Categorical Data</a></li>
<li><a class="" href="logistic-regression.html"><span class="header-section-number">5</span> Logistic Regression</a></li>
<li><a class="active" href="survival-analysis.html"><span class="header-section-number">6</span> Survival Analysis</a></li>
<li><a class="" href="multiple-comparisons.html"><span class="header-section-number">7</span> Multiple Comparisons</a></li>
<li><a class="" href="poisson-regression.html"><span class="header-section-number">8</span> Poisson Regression</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/hardin47/website">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="survival-analysis" class="section level1" number="6">
<h1>
<span class="header-section-number">6</span> Survival Analysis<a class="anchor" aria-label="anchor" href="#survival-analysis"><i class="fas fa-link"></i></a>
</h1>
<p>To motivate the technical details which are vital to understanding survival analysis, consider the following example <span class="citation">(<a href="references.html#ref-gerds" role="doc-biblioref">Gerds 2016</a>)</span>.</p>
<div class="example">
<p><span id="exm:unlabeled-div-32" class="example"><strong>Example 6.1  </strong></span>In class – experience the Titanic going down.</p>
<ul>
<li>The Titanic is sinking. How long can you hold your breath?<br>
</li>
<li>Every person is sinking and will also be their own time keeper (number of seconds the sinker can hold their breath).<br>
</li>
<li>Because the Titanic is sinking slowly, the participants go under water asynchronously (i.e., at different times).<br>
</li>
<li>Accrual period will last about a minute.<br>
</li>
<li>When I say “stop” (about another minute), everyone should end their time clocks (this is the end of the follow-up period).<br>
</li>
<li>Each participant will have a recorded time as well as an indicator as to whether or not they have died.</li>
</ul>
<p>Based on the data, we would like to calculate:<br>
1. What is the probability of surviving 40 seconds?<br>
2. What is the median survival time?<br>
3. What is the average survival time?</p>
</div>
<p>The next example is given in your text <span class="citation">(<a href="references.html#ref-KuiperSklar" role="doc-biblioref">Kuiper and Sklar 2013</a> (chapter 9))</span> as part of the motivation for survival analysis.</p>
<div class="example">
<p><span id="exm:unlabeled-div-33" class="example"><strong>Example 6.2  </strong></span>Class chocolate melting activity</p>
<ul>
<li>Each student should be randomly assigned to a white or milk chocolate chip (flip a coin)<br>
</li>
<li>When the instructor gives approval, students should place either a white or milk chocolate chip into their mouths and record the time until it completely melts.<br>
</li>
<li>Treat the study as if it could only be done for a specified period of time (this may require some experimenting, but 60 seconds has worked well). If the actual time is less than 60 seconds, then the actual time will be complete. The student should submit the data (chip color, actual time, censoring status); 1=observed, 0=censored. Any chips that are “swallowed” prior to 60 seconds should be regarded as censored.</li>
</ul>
</div>
<p>Survival analysis is typically done with a prospective study (see censoring below) on a cohort of patients (observational or experimental) to determine some clinical outcome. We will also usually measure covariates of interest: treatment, clinical variables measured at recruitment, etc.</p>
<blockquote>
<p><strong>Key Point</strong>: the outcome of interest (death, recurrence, etc.) may <em>not</em> occur</p>
</blockquote>
<p>Possible responses:</p>
<ul>
<li><p>Outcome of interest occurs<br></p></li>
<li><p>Study ends<br></p></li>
<li><p>The individual can no longer be measured (moves away, etc.)</p></li>
<li><p><strong>response</strong> fate <em>and</em> length of follow-up<br></p></li>
<li><p><strong>data</strong> suppose we are following n patients<br><span class="math display">\[
\begin{align*}
t_i &amp;= \mbox{time the } i^{th} \mbox{ has event of interest}\\
m(t) &amp;= \mbox{number of patients for whom } t_i &gt; t \mbox{ (die
later)}\\
d(t) &amp;= \mbox{number of patients for whom } t_i \leq t \mbox{
(die sooner)}\\
\end{align*}
\]</span></p></li>
</ul>
<div id="timedata" class="section level2" number="6.1">
<h2>
<span class="header-section-number">6.1</span> Time-to-event data<a class="anchor" aria-label="anchor" href="#timedata"><i class="fas fa-link"></i></a>
</h2>
<div id="survival-function" class="section level3" number="6.1.1">
<h3>
<span class="header-section-number">6.1.1</span> Survival Function<a class="anchor" aria-label="anchor" href="#survival-function"><i class="fas fa-link"></i></a>
</h3>
<p>The two main quantities of interest (i.e., <em>parameters</em>) are:</p>
<p><span class="math display">\[
\begin{align*}
S(t) &amp;= P(T &gt; t) = \mbox{ probability of surviving until after time } t\\
D(t) &amp;= P(T \leq t) = \mbox{ probability of dying by time } t \ (= F(t))\\
\end{align*}
\]</span> Where <span class="math inline">\(T\)</span> is a random variable representing the time to event; t is a number.</p>
<p>If <span class="math inline">\(t_i\)</span> is known for all i (no censoring), we can estimate <span class="math inline">\(S(t)\)</span> and <span class="math inline">\(D(t)\)</span> with <span class="math display">\[
\begin{align*}
\hat{S}(t)_E &amp;= m(t)/n = \mbox{ proportion alive at time } t\\
\hat{D}(t)_E &amp;= d(t)/n = \mbox{ proportion who have died by time } t\\
\end{align*}
\]</span></p>
<div id="censoring" class="section level4" number="6.1.1.1">
<h4>
<span class="header-section-number">6.1.1.1</span> censoring<a class="anchor" aria-label="anchor" href="#censoring"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>
<strong>right</strong> censoring: when the observation on an individual begins at a defined starting time and ends before the outcome of interest happens (this is the censoring for our model)<br>
</li>
<li>
<strong>left</strong> censoring: when the outcome of interest is known to have occurred before the study begins (infection of a disease, learning to count). Note that the event of interest <em>has happened</em>, unlike in right censoring where the event of interest has not happened.<br>
</li>
<li>
<strong>interval</strong> censoring; when the event of interest is only known to have occurred between two time points, but the precise time is not known.</li>
</ul>
<p><strong>Important Assumption</strong>: survival time must be independent of any mechanism which causes censoring (called non-informative censoring). Censoring should be random: a person who is censored has the same probability of dying as non-censored people at given explanatory variables <span class="math inline">\(\underline{X}\)</span>.</p>
<p>Said differently: within any subgroup of interest, the subjects who are censored at time <span class="math inline">\(t\)</span> should be representative of all the subjects in that subgroup who remained at risk at time <span class="math inline">\(t\)</span> with respect to their survival experience.</p>
<ul>
<li>
<p>Not independent</p>
<ul>
<li>Subjects who drop out because they are extremely ill<br>
</li>
<li>Subjects who drop out because of adverse effects of the treatment regimen<br>
</li>
</ul>
</li>
<li>
<p>Independent</p>
<ul>
<li>Subjects who drop out because the study ends<br>
</li>
<li>Subjects who drop out because they move away</li>
</ul>
</li>
</ul>
<div class="example">
<p><span id="exm:unlabeled-div-34" class="example"><strong>Example 6.3  </strong></span>Suppose we have the following melting times (in seconds) of milk chocolate chips for 7 students where the maximum time allowed for the experiment was 60 seconds:</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="right">Student</th>
<th align="center">1</th>
<th align="center">2</th>
<th align="center">3</th>
<th align="center">4</th>
<th align="center">5</th>
<th align="center">6</th>
<th align="center">7</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">Time</td>
<td align="center">35</td>
<td align="center">30</td>
<td align="center">60</td>
<td align="center">45</td>
<td align="center">25</td>
<td align="center">55</td>
<td align="center">30</td>
</tr></tbody>
</table></div>
<p>To find the estimated proportion of chocolate chips that have not melted after 45 seconds we use the <strong>empirical survival function</strong>, <span class="math inline">\(\hat{S}(45)_E\)</span>. <span class="math display">\[
\begin{align*}
\hat{S}(45)_E &amp;= \frac{\mbox{number of chips that have not melted
after 45 seconds}}{\mbox{total number of chips in the sample}}\\
&amp;= 2/7 = 0.286\\
\hat{S}(t)_E &amp;= \frac{\mbox{number of individuals yet to experience
the event at time } t}{\mbox{number of individuals in the study}}\\
&amp;= \frac{\mbox{number of event times greater than } t}{\mbox{number
of individuals in the study}}\\
\end{align*}
\]</span></p>
<p>What if some of the observations are incomplete (i.e., censored)?</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="right">Student</th>
<th align="center">1</th>
<th align="center">2</th>
<th align="center">3</th>
<th align="center">4</th>
<th align="center">5</th>
<th align="center">6</th>
<th align="center">7</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">Time</td>
<td align="center"><span class="math inline">\(35^+\)</span></td>
<td align="center">30</td>
<td align="center"><span class="math inline">\(60^+\)</span></td>
<td align="center">45</td>
<td align="center">25</td>
<td align="center">55</td>
<td align="center"><span class="math inline">\(30^+\)</span></td>
</tr></tbody>
</table></div>
<p>One way to deal with censored observations is to remove them from the study. We would consider our sample to be only those observations that have complete information.</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="right">Student</th>
<th align="center">2</th>
<th align="center">4</th>
<th align="center">5</th>
<th align="center">6</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">Time</td>
<td align="center">30</td>
<td align="center">45</td>
<td align="center">25</td>
<td align="center">55</td>
</tr></tbody>
</table></div>
<p><span class="math display">\[
\begin{align*}
\hat{S}(45)_E &amp;= \frac{\mbox{number of chips that have not melted after 45 seconds}}{\mbox{total number of chips in the sample}}\\
&amp;= 1/4 = 0.25\\
\end{align*}
\]</span></p>
</div>
<p>By treating censored observations as complete, we assume that the event times are shorter than what they actually are (thereby underestimating the true probability of survival). By removing the censored observations from the data, we lose information. By treating censored observations as complete we bias the estimate based on the remaining times; by ignoring censored observations, we reduce the power of the inferential model.</p>
</div>
</div>
</div>
<div id="KM" class="section level2" number="6.2">
<h2>
<span class="header-section-number">6.2</span> Kaplan-Meier Curves<a class="anchor" aria-label="anchor" href="#KM"><i class="fas fa-link"></i></a>
</h2>
<p>When a data set contains incomplete observations, the best estimator of the survival function is the Kaplan-Meier estimator, <span class="math inline">\(\hat{S}(t)_{KM}\)</span>. We’ll create a few curves by hand, and then we’ll let R make them for us.</p>
<p><span class="math display">\[
\begin{align*}
t_1 &lt; t_2 &lt; \cdots &lt; t_n &amp; \ \mbox{ are the ordered completed times}\\
n_i &amp;= \mbox{number of patients known to be at risk at time (day) } t_i, \mbox{ just before } [t_i, t_{i+1})\\
d_i &amp;= \mbox{number of patients who die at time (day) } t_i, \mbox{ in } [t_i, t_{i+1})\\
\end{align*}
\]</span></p>
<p>For the patients alive at the beginning of the <span class="math inline">\(t_i^{th}\)</span> time, the probability of surviving that time is <span class="math display">\[p_i = \frac{n_i - d_i}{n_i}\]</span> The probability that a patient survives to time 2 given that they survived to time 1 is <span class="math display">\[p_2 = \frac{n_2 - d_2}{n_2}\]</span> The probability that (at the outset) a patient survives to time 2 is: <span class="math display">\[
\begin{align*}
P(T &gt; t_2) &amp;= P(T &gt; t_2 | T &gt; t_1) P(T &gt; t_1)\\
&amp;= \frac{n_1 - d_1}{n_1} \frac{n_2 - d_2}{n_2}
\end{align*}
\]</span> The probability of surviving the first t days is: <span class="math display">\[
\begin{align*}
\hat{S}(t)_{KM} &amp;= \prod_{i:t_i &lt; t} \frac{n_i - d_i}{n_i}\\
&amp;= \prod_{i:t_i &lt; t} p_i\\
\hat{D}(t)_{KM} &amp;= 1 - \hat{S}(t)_{KM}\\
\end{align*}
\]</span> If there are no deaths at time <span class="math inline">\(t_i\)</span>, then <span class="math inline">\((n_i -d_i) / n_i = 1\)</span>.</p>
<p>If there is no censoring at time <span class="math inline">\(t_i\)</span>, then <span class="math inline">\(n_i - d_i = n_{i+1}\)</span>. The Kaplan-Meier survival curve will be equivalent to the empirical survival curve:</p>
<p><span class="math display">\[
\begin{align*}
\hat{S}(t)_{KM} &amp;= \prod_{i:t_i &lt; t} \frac{n_i - d_i}{n_i}\\
&amp;= \frac{n_1 - d_1}{n_1} \frac{n_2 - d_2}{n_2} \cdots \frac{n_k - d_k}{n_k}\\
&amp;= \frac{m(t)}{n}
\end{align*}
\]</span> ::: {.example} milk chocolate times by hand.</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="center"><span class="math inline">\(t_i\)</span></th>
<th align="center"><span class="math inline">\(n_i\)</span></th>
<th align="center"><span class="math inline">\(d_i\)</span></th>
<th align="center"><span class="math inline">\(n_i - d_i\)</span></th>
<th align="center"><span class="math inline">\(\frac{n_i - d_i}{n_i}\)</span></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">25</td>
<td align="center">7</td>
<td align="center">1</td>
<td align="center">6</td>
<td align="center">6/7= 0.857</td>
</tr>
<tr class="even">
<td align="center">30</td>
<td align="center">6</td>
<td align="center">1</td>
<td align="center">5</td>
<td align="center">5/6 = 0.833</td>
</tr>
<tr class="odd">
<td align="center">35</td>
<td align="center">4</td>
<td align="center">0</td>
<td align="center">4</td>
<td align="center">4/4 = 1</td>
</tr>
<tr class="even">
<td align="center">45</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">2/3 = 0.667</td>
</tr>
<tr class="odd">
<td align="center">55</td>
<td align="center">2</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1/2=0.5</td>
</tr>
<tr class="even">
<td align="center">60</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">1/1=1</td>
</tr>
</tbody>
</table></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="center">time interval</th>
<th align="center"><span class="math inline">\(\hat{S}(t)_{KM}\)</span></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center"><span class="math inline">\([0,25)\)</span></td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="center"><span class="math inline">\([25,30)\)</span></td>
<td align="center">0.857</td>
</tr>
<tr class="odd">
<td align="center"><span class="math inline">\([30, 35)\)</span></td>
<td align="center">0.857 <span class="math inline">\(\cdot\)</span> 0.833 = 0.714</td>
</tr>
<tr class="even">
<td align="center"><span class="math inline">\([35,45)\)</span></td>
<td align="center">0.714 <span class="math inline">\(\cdot\)</span> 1 = 0.714</td>
</tr>
<tr class="odd">
<td align="center"><span class="math inline">\([45,55)\)</span></td>
<td align="center">0.714 <span class="math inline">\(\cdot\)</span> 0.667 = 0.476</td>
</tr>
<tr class="even">
<td align="center"><span class="math inline">\([55,60)\)</span></td>
<td align="center">0.476 <span class="math inline">\(\cdot\)</span> 0.5 = 0.238</td>
</tr>
</tbody>
</table></div>
<p>:::</p>
<div id="KMCI" class="section level3" number="6.2.1">
<h3>
<span class="header-section-number">6.2.1</span> CI for KM curve<a class="anchor" aria-label="anchor" href="#KMCI"><i class="fas fa-link"></i></a>
</h3>
<p>Recall: <span class="math inline">\(\hat{S}(t)_{KM} = \prod_{k:t_k &lt; t} [ (n_k - d_k) / n_k]\)</span>.</p>
<p>Because <span class="math inline">\(\hat{S}(t)_{KM}\)</span> is just a product of counts, we can “easily” estimate the SE: <span class="math display">\[
\begin{align*}
s^2_{\hat{S}(t)_{KM}} = \hat{S}(t)_{KM}^2 \sum_{k:t_k &lt; t}
\frac{d_k}{n_k(n_k - d_k)}
\end{align*}
\]</span></p>
<p>Your book uses the above SE and normal theory which does work, particularly with large sample sizes. However, with smaller sample sizes and at the ends of the survival curve (close to zero or one), the sampling distribution of the estimated KM curve will not be normal. Additionally if we try to apply normal theory, we’ll get something meaningless because the CI will go outside the bounds of 0 and 1. Fortunately, someone figured out a transformation for us!</p>
<p><span class="math inline">\(l l \hat{S}(t) = \ln (-\ln \hat{S}(t)_{KM})\)</span> has a much more normal sampling distribution than the sampling distribution of the untransformed estimator <span class="math inline">\(\hat{S}(t)_{KM}\)</span>.</p>
<p><span class="math display">\[
\begin{align*}
\hat{\sigma}^2(t) &amp;= SE( l l \hat{S}(t))\\
&amp;= \frac{\sum_{k:t_k &lt; t} \frac{d_k}{n_k(n_k - d_k)}}{\bigg[\sum_{k:t_k &lt; t} \ln ( (n_k - d_k) / n_k) \bigg]^2}
\end{align*}
\]</span> A 95 % CI for <span class="math inline">\(\ln ( -\ln S(t))\)</span> is <span class="math display">\[ll\hat{S}(t) \pm 1.96 \hat{\sigma}(t) \ \ \ \mbox{(a function of
t!!!)}\]</span></p>
<p>A 95 % CI for <span class="math inline">\(S(t)\)</span> is <span class="math display">\[\bigg(\hat{S}(t)_{KM}^{\exp(1.96\hat{\sigma}(t))},
\hat{S}(t)_{KM}^{\exp(-1.96\hat{\sigma}(t))} \bigg)\]</span></p>
<p>We can also find a CI for <span class="math inline">\(D(t) = 1- S(t)\)</span> using:</p>
<p><span class="math display">\[
\begin{align*}
\bigg(1 - \hat{S}(t)_{KM}^{\exp(-1.96\hat{\sigma}(t))}, 1 -
\hat{S}(t)_{KM}^{\exp(1.96\hat{\sigma}(t))} \bigg)
\end{align*}
\]</span></p>
<div id="derivation-of-the-above-confidence-intervals." class="section level5 unnumbered">
<h5>Derivation of the above confidence intervals.<a class="anchor" aria-label="anchor" href="#derivation-of-the-above-confidence-intervals."><i class="fas fa-link"></i></a>
</h5>
<p>Remember that <span class="math inline">\(\exp(a \cdot b) = (\exp(a))^b\)</span>, we’ll need that below. A CI is an interval of values that captures the true parameter in 95 of samples. Let’s say that the complementary log-log interval from above happens to catch the true value of <span class="math inline">\(S(t)\)</span>. Then,</p>
<p><span class="math display">\[
\begin{align*}
ll\hat{S}(t) - 1.96 \hat{\sigma}(t) \leq  &amp; llS(t)  \leq ll\hat{S}(t) + 1.96 \hat{\sigma}(t) \\
\exp(ll\hat{S}(t) - 1.96 \hat{\sigma}(t)) \leq  &amp; -lS(t)  \leq \exp(ll\hat{S}(t) + 1.96 \hat{\sigma}(t)) \\
-l\hat{S}(t)\exp(- 1.96 \hat{\sigma}(t))\leq  &amp;-lS(t)  \leq -l\hat{S}(t)\exp(1.96 \hat{\sigma}(t)) \\
l\hat{S}(t)\exp(- 1.96 \hat{\sigma}(t))\geq  &amp; lS(t)  \geq l\hat{S}(t)\exp(1.96 \hat{\sigma}(t)) \\
l\hat{S}(t)\exp(1.96 \hat{\sigma}(t))\leq  &amp; lS(t)  \leq l\hat{S}(t)\exp(-1.96 \hat{\sigma}(t)) \\
\exp(l\hat{S}(t)\exp(1.96 \hat{\sigma}(t))) \leq  &amp; S(t)  \leq \exp(l\hat{S}(t)\exp(-1.96 \hat{\sigma}(t))) \\
\exp(l\hat{S}(t))^{\exp(1.96 \hat{\sigma}(t))} \leq  &amp; S(t)  \leq \exp(l\hat{S}(t))^{\exp(-1.96 \hat{\sigma}(t))} \\
(\hat{S}(t))^{\exp(1.96 \hat{\sigma}(t))} \leq  &amp; S(t)  \leq (\hat{S}(t))^{\exp(-1.96 \hat{\sigma}(t))}
\end{align*}
\]</span></p>
</div>
<div id="mean-and-median-values" class="section level4" number="6.2.1.1">
<h4>
<span class="header-section-number">6.2.1.1</span> Mean and Median values<a class="anchor" aria-label="anchor" href="#mean-and-median-values"><i class="fas fa-link"></i></a>
</h4>
<p><strong>Mean</strong></p>
<blockquote>
<p>Mean survival time is estimated as the area under the survival curve. The estimator is based upon the entire range of data. Some software uses only the data up to the last observed event <span class="citation">(<a href="references.html#ref-SurvHL" role="doc-biblioref">Hosmer, Lemeshow, and May 2008</a>)</span> point out that this biases the estimate of the mean downwards, and they recommend that the entire range of data be used. A large sample method is used to estimate the variance of the mean survival time and thus to construct a confidence interval <span class="citation">(<a href="references.html#ref-Andersen" role="doc-biblioref">Andersen et al. 1996</a>)</span>. <span class="citation">(<a href="references.html#ref-KMmean" role="doc-biblioref">StatsDirect Limited 2016</a>)</span></p>
</blockquote>
<p>In some ways, it is easier to conceptualize the mean as the average under the curve by thinking about calculating average as horizontal bars instead of vertical bars. The jumps along the y-axis are approximately 1/n, so each horizontal bar represents one of the individual deaths. See the example here: <a href="http://blog.data-miners.com/2010/06/why-is-area-under-survival-curve-equal.html" class="uri">http://blog.data-miners.com/2010/06/why-is-area-under-survival-curve-equal.html</a></p>
<p><span class="math display">\[
\begin{align*}
\hat{\mu} = \left\{
    \begin{array}{ll}
    \sum_{i=0}^{m-1} \hat{S}(t_i)_{KM} (t_{i+1} - t_i) &amp; \mbox{if } t_n = t_m  \mbox{ (last obs is complete)}\\
    \sum_{i=0}^{m-1} \hat{S}(t_i)_{KM} (t_{i+1} - t_i) + \hat{S}(t_m)_{KM}(t_n-t_m) &amp; \mbox{if last obs is censored}
    \end{array}
\right.
\end{align*}
\]</span></p>
<p>Each entry can be rearranged to be thought of as the proportion of people who die in the interval times the width of the interval: <span class="math inline">\([\hat{S}(t_{i-1})_{KM} - \hat{S}(t_{i})_{KM}]t_i\)</span>. The difference, <span class="math inline">\([\hat{S}(t_{i-1})_{KM} - \hat{S}(t_{i})_{KM}]\)</span>, gives the proportion of individuals who die in that time interval. Therefore, our estimate is a weighted average of the time points <span class="math inline">\(t_i\)</span> where the weight is <span class="math inline">\([\hat{S}(t_{i-1})_{KM} - \hat{S}(t_{i})_{KM}]\)</span>.</p>
<p><span class="math display">\[
\begin{align*}
\hat{\mu} &amp;= \sum_{i=0}^{m-1} \hat{S}(t_i)_{KM}(t_{i+1} - t_i)\\
&amp;= \hat{S}(t_0)_{KM}(t_1 - t_0) + \hat{S}(t_1)_{KM}(t_2 - t_1) + \hat{S}(t_2)_{KM} (t_3 - t_2) + \cdots + \hat{S}(t_{m-1})_{KM} (t_m - t_{m-1}) \\
&amp;= -t_0  \hat{S}(t_0)_{KM} + t_1 ( \hat{S}(t_0)_{KM} -  \hat{S}(t_1)_{KM}) + \cdots + t_{m-1}( \hat{S}(t_{m-2})_{KM} -  \hat{S}(t_{m-1})_{KM}) + t_m  \hat{S}(t_{m-1})_{KM}\\
&amp;= 0 + t_1 ( \hat{S}(t_0)_{KM} -  \hat{S}(t_1)_{KM}) + \cdots + t_{m-1}( \hat{S}(t_{m-2})_{KM} -  \hat{S}(t_{m-1})_{KM}) + t_m ( \hat{S}(t_{m-1})_{KM} - 0)\\
&amp;= \mbox{a weighted average of the times}
\end{align*}
\]</span></p>
<p><strong>Median</strong><br>
Since the distribution of survival times tend to be positively skewed, the median is often the preferred summary measure of location of the distribution. Once the survivor function has been estimated, it is straightforward to obtain an estimate of the <em>median survival time</em>. That is, the time beyond which 50 % of the individuals in the population under study are expected to survive, and is given by the value <span class="math inline">\(t_{(50)}\)</span> such that <span class="math inline">\(S(t_{(50)}) = 0.5\)</span>.</p>
<p><span class="math display">\[
\begin{align*}
\hat{t}_{(p)} = \mbox{smallest complete event time, } t_i, \mbox{ in the sample such that } \hat{S}(t_i)_{KM} \leq 1-p/100
\end{align*}
\]</span></p>
<p><span class="math inline">\(\hat{S}(t_i)_{KM}\)</span> then gives the time at which at least p % of events have occurred. There are also ways of compute confidence intervals for percentiles. We won’t cover those here.</p>
</div>
</div>
<div id="logrank" class="section level3" number="6.2.2">
<h3>
<span class="header-section-number">6.2.2</span> Log-rank Test<a class="anchor" aria-label="anchor" href="#logrank"><i class="fas fa-link"></i></a>
</h3>
<p>As before, we’d like to know if two treatments produce the same probability of survival (how did we do that with logistic regression? significance of the <span class="math inline">\(\beta\)</span> coefficient). Here: <span class="math display">\[
\begin{align*}
H_0: &amp; S_1(t) = S_2(t) \ \ \ \ \ \forall t \mbox{
parameters!}\\
H_1: &amp; S_1(t) \ne S_2(t) \ \ \ \ \ \mbox{ for some } t\\
\end{align*}
\]</span></p>
<p>We want to test whether the curves are the same over all <span class="math inline">\(t\)</span> (or different at any <span class="math inline">\(t\)</span>). Let’s consider a particular time, the <span class="math inline">\(j^{th}\)</span> event time (we don’t look at the censored times, because we only consider when the curve changes / steps):</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="right"></th>
<th align="center">Group 1</th>
<th align="center">Group 2</th>
<th>Total</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">died</td>
<td align="center"><span class="math inline">\(d_{1j}\)</span></td>
<td align="center"><span class="math inline">\(d_{2j}\)</span></td>
<td><span class="math inline">\(d_j\)</span></td>
</tr>
<tr class="even">
<td align="right">survived</td>
<td align="center"><span class="math inline">\(n_{1j} - d_{1j}\)</span></td>
<td align="center"><span class="math inline">\(n_{2j} - d_{2j}\)</span></td>
<td><span class="math inline">\(n_j - d_j\)</span></td>
</tr>
<tr class="odd">
<td align="right"></td>
<td align="center"><span class="math inline">\(n_{1j}\)</span></td>
<td align="center"><span class="math inline">\(n_{2j}\)</span></td>
<td><span class="math inline">\(n_j\)</span></td>
</tr>
</tbody>
</table></div>
<p>Because it’s a <span class="math inline">\(2x2\)</span> table with fixed margins, we only need to consider one group. If survival is similar for the two groups, we’d expect:</p>
<p><span class="math display">\[
\begin{align*}
d_{1j} &amp;\approx \frac{d_j}{n_j}n_{1j}\\
d_{1j} &amp;= \mbox{observed}\\
\frac{d_j}{n_j} n_{1j} &amp;= E(d_{1j} | d_j) = E_{1j} \\
var(d_{1j}) &amp;= \frac{n_{1j} n_{2j} d_j (n_j - d_j)}{n_j^2(n_j-1)}
= V_{1j}\\
\end{align*}
\]</span> where the variance is derived from the hypergeometric distribution.</p>
<p>To estimate the overall difference between the observed and expected death counts: <span class="math display">\[
\begin{align*}
\sum_j d_{1j} - \sum_j E(d_{1j} | d_j) = \sum_j d_{1j} - \sum_j
\frac{d_j}{n_j}n\_{1j}
\end{align*}
\]</span> The overall variability: <span class="math display">\[\sum_j var(d_{1j}|d_j)\]</span> The test statistic we use to compare the observed and expected frequency of deaths. (Sum over all of the death (or event) times.) <span class="math display">\[
\begin{align*}
T = \frac{(|\sum_j d_{1j} - \sum_j E(d_{1j} | d_j)| -
0.5)^2}{\sum_j var(d_{1j}|d_j)} \sim \chi^2_1
\end{align*}
\]</span></p>
<p>What if we had had <span class="math inline">\(g\)</span> groups (instead of 2)? We would have <span class="math inline">\(g-1\)</span> “death” values. Consider the test statistic above, call it <span class="math inline">\(T_1\)</span>. If we had <span class="math inline">\(g\)</span> groups, we would need to sum <span class="math inline">\(T_i, i=1,2, \ldots, g-1\)</span>. However, the variances of the <span class="math inline">\(T_i\)</span> would be correlated (because the values must sum to <span class="math inline">\(D_k\)</span>)… so the test statistic is slightly more complicated. <span class="citation">(<a href="references.html#ref-Collett" role="doc-biblioref">Collett 2015</a>(section 2.6))</span></p>
<ul>
<li>The Wilcoxon test is very similar to the log-rank test, but it uses a different derivation for the variance, and therefore a different denominator and test statistic.<br>
</li>
<li>The log-rank test is more powerful than the Wilcoxon, but the log-rank test requires the proportional hazards assumption.<br>
</li>
<li>Wilcoxon test does not require the proportional hazards assumption, but it does require that one curve is always bigger than the other.<br>
</li>
<li>Neither work if the curves cross.<br>
</li>
<li>Other technical conditions are that the sample size should be “big enough.” The sample size is dependent on the number of deaths. No specific criteria, but the results are asymptotic, so the p-values converge to the actual probabilities as the number of deaths gets larger.</li>
</ul>
</div>
</div>
<div id="hazfunc" class="section level2" number="6.3">
<h2>
<span class="header-section-number">6.3</span> Hazard Functions<a class="anchor" aria-label="anchor" href="#hazfunc"><i class="fas fa-link"></i></a>
</h2>
<p>Another important idea in survival analysis is the hazard function or instantaneous death rate. Let T be the random variable representing death time. [Your text implicitly redefines <span class="math inline">\(S(t) = P(T \geq t)\)</span> which is inconsistent but not fundamentally problematic.]</p>
<p><span class="math display">\[
\begin{align*}
h(t)&amp;= \lim_{\Delta t \rightarrow 0} \frac{P(\mbox{patient dies by time } t + \Delta t | \mbox{alive at } t)}{\Delta t}\\
 &amp;= \lim_{\Delta t \rightarrow 0} \frac{P(T &lt; t + \Delta t | T \geq t)}{\Delta t}\\
 &amp;= \lim_{\Delta t \rightarrow 0} \frac{P(t \leq T &lt; t + \Delta t | T \geq t)}{\Delta t}\\
 &amp;= \lim_{\Delta t \rightarrow 0} \frac{P(t \leq T &lt; t + \Delta t )}{P(T \geq t) \Delta t}\\
 &amp;= \lim_{\Delta t \rightarrow 0} \frac{S(t) - S(t + \Delta t)}{S(t) \Delta t}\\
 &amp;= \lim_{\Delta t \rightarrow 0} -\frac{S(t + \Delta t) - S(t)}{\Delta t}\frac{1}{S(t)}\\
 &amp;= -S'(t) \frac{1}{S(t)}\\
 &amp;= -\frac{d}{dt} \ln(S(t))\\
S(t) &amp;= \exp \{ - \int^t_0 h(x) dx  \}\\
\end{align*}
\]</span></p>
<p>How do different functions of <span class="math inline">\(h\)</span> affect the survival curve, <span class="math inline">\(S\)</span>?</p>
<p><span class="math display">\[
\begin{align*}
h(t) = 0 &amp;&amp;\Rightarrow \mbox{ no risk of death at time } t\\
&amp;&amp; \Rightarrow S(t) \mbox{ is flat at } t\\
h(t) \&gt; \&gt;&amp;&amp; \Rightarrow S(t) \mbox{ is rapidly declining in } t\\
h(t) =k &amp;&amp; \Rightarrow S(t) = e^{-kt}
\end{align*}
\]</span></p>
<div id="hazard-function-as-a-constant" class="section level4" number="6.3.0.1">
<h4>
<span class="header-section-number">6.3.0.1</span> hazard function as a constant<a class="anchor" aria-label="anchor" href="#hazard-function-as-a-constant"><i class="fas fa-link"></i></a>
</h4>
<p>If <span class="math inline">\(h(t) =k \rightarrow S(t) = e^{-kt}\)</span>.</p>
<p>Plots of different hazard functions and their corresponding survival functions.</p>
<div class="inline-figure"><img src="06-surv_files/figure-html/unnamed-chunk-2-1.png" width="80%" style="display: block; margin: auto;"></div>
</div>
<div id="estimating-ht-ala-kaplan-meier" class="section level3" number="6.3.1">
<h3>
<span class="header-section-number">6.3.1</span> Estimating <span class="math inline">\(h(t)\)</span> ala Kaplan-Meier<a class="anchor" aria-label="anchor" href="#estimating-ht-ala-kaplan-meier"><i class="fas fa-link"></i></a>
</h3>
<p><span class="math inline">\(h(t)\)</span> is the rate at which individuals in the population experience the event in the next <em>instant</em> of time, conditional on surviving to time <span class="math inline">\(t\)</span>. The estimated hazard curve can only extend to the last complete event time, otherwise the denominator is infinitely large. Also, keep in mind that <span class="math inline">\(h(t)\)</span> is very hard to estimate, and <span class="math inline">\(\hat{h}_{KM}(t)\)</span> can be erratic.</p>
<p><span class="math display">\[
\begin{align*}
\hat{P}(t_i \leq T &lt; t_{i+1} | T \geq t_i) &amp;= \frac{d_i}{n_i} = \hat{p}_i\\
\hat{h}_{KM}(t) &amp;= \frac{\hat{p}_i}{t_{i+1} - t_i}  \ \ \ \ \ \ t_{i+1} \leq t &lt; t_i\\
\end{align*}
\]</span></p>
</div>
<div id="proportional-hazards" class="section level3" number="6.3.2">
<h3>
<span class="header-section-number">6.3.2</span> Proportional Hazards<a class="anchor" aria-label="anchor" href="#proportional-hazards"><i class="fas fa-link"></i></a>
</h3>
<p>Suppose that <span class="math inline">\(h_0(t)\)</span> and <span class="math inline">\(h_1(t)\)</span> are the hazard functions for patients on control and experimental treatments. The two groups have {proportional hazards} if <span class="math inline">\(h_1(t) = R h_0(t)\)</span> for some constant R: <span class="math display">\[\frac{h_1(t)}{h_0(t)} = R \ \ \ \ \ \forall t\]</span> R is called the <strong>hazard ratio</strong>. <span class="math inline">\(h_0(t)\)</span> can be anything as long as <span class="math inline">\(h_1(t)\)</span> is proportional. Note in the pictures below that no one dies between 3 and 7 days, the survival curves are flat over that interval.</p>
<div class="inline-figure"><img src="06-surv_files/figure-html/unnamed-chunk-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>Consider the notion of risk of death: <span class="math display">\[
\begin{align*}
\mbox{risk of death by } t + \Delta t \mbox{ given alive at } t=
\left\{
\begin{array}{ll}
h_0(t) \Delta t &amp; \mbox{control}\\
h_1(t) \Delta t &amp; \mbox{experiment}
\end{array}
\right.
\end{align*}
\]</span></p>
<p><span class="math display">\[
\begin{align*}
\frac{\mbox{risk of dying for experim}}{\mbox{risk of dying control}} = \frac{h_1(t) \Delta t}{h_0(t) \Delta t} = \frac{h_1(t) }{h_0(t) } = R
\end{align*}
\]</span>Ratio of hazard functions can be thought of as the <strong>instantaneous relative risk</strong> (i.e., at a time <span class="math inline">\(t\)</span>).</p>
</div>
<div id="coxph" class="section level3" number="6.3.3">
<h3>
<span class="header-section-number">6.3.3</span> Cox PH Regression Analysis<a class="anchor" aria-label="anchor" href="#coxph"><i class="fas fa-link"></i></a>
</h3>
<div id="simple-proportional-hazards-model" class="section level4" number="6.3.3.1">
<h4>
<span class="header-section-number">6.3.3.1</span> Simple proportional hazards model<a class="anchor" aria-label="anchor" href="#simple-proportional-hazards-model"><i class="fas fa-link"></i></a>
</h4>
<p>ASSUMING proportional hazards! Let <span class="math inline">\(h_0(t)\)</span> be the hazard function for the control group. <span class="math inline">\(x_i\)</span> =1 if the <span class="math inline">\(i^{th}\)</span> patient receives treatment; 0 if the <span class="math inline">\(i^{th}\)</span> patient receives the control. A big value of <span class="math inline">\(\beta\)</span> means that the event is more likely to happen.</p>
<p><span class="math display">\[
\begin{align*}
h_i(t) &amp;= h_0(t) e^{\beta x_i} = \left\{
\begin{array}{ll}
h_0(t) e^\beta &amp; \mbox{experim}\\
h_0(t) &amp; \mbox{control}
\end{array}
\right.\\
\mbox{inst. RR} &amp;= \frac{h_0(t) e^\beta}{h_0(t)} = e^\beta\\
S_i(t) &amp;= (S_0(t))^{e^\beta}\\
\end{align*}
\]</span> We don’t yet know how to run this model and estimate the parameters, but still, we can probably do it. Right? We run a <strong>Cox proportional hazards model</strong>, get <span class="math inline">\(b\)</span>, and estimate the HR using: <span class="math inline">\(\widehat{HR} = e^{b}\)</span>! It turns out that for large samples (as with logistic regression, the CI and tests below are again called Wald CI and tests),</p>
<p><span class="math display">\[
\begin{align*}
b \sim N: &amp; \\
&amp; 95\% \mbox{ CI for } \beta: b \pm 1.96 SE(b)\\
&amp; 95\% \mbox{ CI for } HR: (e^{b - 1.96 SE(b)}, e^{b + 1.96 SE(b)})\\
\end{align*}
\]</span> And we can test HR by using <span class="math inline">\(\beta\)</span>: <span class="math display">\[
\begin{align*}
H_0: \ &amp; \beta=0 \iff HR = 1\\
Z &amp;= \frac{b - 0 }{SE(b)}
\end{align*}
\]</span></p>
</div>
<div id="estimating-the-proportional-hazards-coefficients" class="section level4" number="6.3.3.2">
<h4>
<span class="header-section-number">6.3.3.2</span> Estimating the proportional hazards coefficients<a class="anchor" aria-label="anchor" href="#estimating-the-proportional-hazards-coefficients"><i class="fas fa-link"></i></a>
</h4>
<p>The main point of proportional hazards is that if we have proportional hazards, then we don’t actually need to know the hazard function in order to estimate the coefficients which affect the survival function. [We divide out the hazard function.]</p>
<p>Intervals between death times convey no information about the relationship between hazard and explanatory variables (including treatment). We are also assuming that we have no ties for our death times. [Importantly, we assume that the proportional hazards assumption holds over <em>all</em> <span class="math inline">\(t\)</span>.]</p>
<p><span class="math display">\[
\begin{align*}
P(i^{th} \mbox{ indiv, w/}x_i, \mbox{ dies at } t_i | \mbox{one death at } t_i) &amp;= \frac{P(i^{th} \mbox{ indiv w/}x_i \mbox{ dies at } t_i )}{P(\mbox{at least one death at } t_i)}\\
&amp;= \frac{\mbox{hazard at } t_i}{\mbox{sum over all patients at risk at time } t_i}\\
&amp;= \frac{h_i(t_i)}{\sum_{k:t_k \geq t_i} h_k (t_i)} \\
&amp;= \frac{e^{\beta x_i}}{\sum_{k:t_k \geq t_i} e^{\beta x_k}}
\end{align*}
\]</span> As with logistic regression (and linear regression!) we’ll use maximum likelihood to estimate the parameter(s). (The product is over only patients who have death times recorded, not censored times).</p>
<p><span class="math display">\[
\begin{align*}
L(\beta) &amp;= \prod_{i=1}^r \frac{e^{\beta x_i}}{\sum_{k:t_k
\geq t_i} e^{\beta x_k}}\\
\delta_i &amp;= \left\{\begin{array}{ll}
1 &amp; \mbox{death}\\
0 &amp; \mbox{censored}
\end{array}
\right.\\
L(\beta) &amp;= \prod_{i=1}^n \Bigg( \frac{e^{\beta
x_i}}{\sum_{k:t_k \geq t_i} e^{\beta x_k}} \Bigg)^{\delta_i}\\
\ln L(\beta) &amp;= \sum_{i=1}^n \delta_i \bigg[ \beta x_i - \ln
(\sum_{k:t_k \geq t_i} e^{\beta x_k}) \bigg]
\end{align*}
\]</span> <span class="math inline">\(b\)</span> is found using numerical methods (as it was with logistic regression).</p>
<div class="example">
<p><span id="exm:unlabeled-div-35" class="example"><strong>Example 6.4  </strong></span>Consider the following data from a prostate cancer study. The study was performed as a randomized clinical trail to compare treatments for prostatic cancer, and was begun in 1967 by the Veteran’s Administration Cooperative Urological Research Group. The trial was double blind and two of the treatments used were a placebo and 1.0 mg of diethylstilbestrol (DES). The time origin of the study is the date on which a patient was randomized to a treatment, and the end-point is the death of the patient from prostate cancer. The full data set is given in <span class="citation"><a href="references.html#ref-AndHerz" role="doc-biblioref">Andrews and Herzberg</a> (<a href="references.html#ref-AndHerz" role="doc-biblioref">1985</a>)</span>, but the data used in this example are from patients presenting with Stage III cancer and given in <span class="citation"><a href="references.html#ref-Collett" role="doc-biblioref">Collett</a> (<a href="references.html#ref-Collett" role="doc-biblioref">2015</a>)</span> (page 8).</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span>
<span class="va">prostate</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"PROSTATE.csv"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">prostate</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 7</span>
<span class="co">#&gt;   Treatment  Time Status   Age  Haem  Size Gleason</span>
<span class="co">#&gt;       &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt; 1         1    65      0    67  13.4    34       8</span>
<span class="co">#&gt; 2         2    61      0    60  14.6     4      10</span>
<span class="co">#&gt; 3         2    60      0    77  15.6     3       8</span>
<span class="co">#&gt; 4         1    58      0    64  16.2     6       9</span>
<span class="co">#&gt; 5         2    51      0    65  14.1    21       9</span>
<span class="co">#&gt; 6         1    51      0    61  13.5     8       8</span>

<span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">Time</span>,<span class="va">Status</span><span class="op">)</span> <span class="op">~</span> <span class="va">Treatment</span>, data <span class="op">=</span> <span class="va">prostate</span><span class="op">)</span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; coxph(formula = Surv(Time, Status) ~ Treatment, data = prostate)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;           coef exp(coef) se(coef)  z    p</span>
<span class="co">#&gt; Treatment -2.0       0.1      1.1 -2 0.07</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Likelihood ratio test=5  on 1 df, p=0.03</span>
<span class="co">#&gt; n= 38, number of events= 6</span>

<span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">Time</span>,<span class="va">Status</span><span class="op">)</span> <span class="op">~</span> <span class="va">Treatment</span>, data <span class="op">=</span> <span class="va">prostate</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 x 5</span>
<span class="co">#&gt;   term      estimate std.error statistic p.value</span>
<span class="co">#&gt;   &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Treatment    -1.98      1.10     -1.80  0.0717</span>
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">Time</span>,<span class="va">Status</span><span class="op">)</span> <span class="op">~</span> <span class="va">Treatment</span>, data <span class="op">=</span> <span class="va">prostate</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/glance.html">glance</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 x 18</span>
<span class="co">#&gt;       n nevent statistic.log p.value.log statistic.sc p.value.sc statistic.wald</span>
<span class="co">#&gt;   &lt;int&gt;  &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;          &lt;dbl&gt;</span>
<span class="co">#&gt; 1    38      6          4.55      0.0329         4.42     0.0355           3.24</span>
<span class="co">#&gt; # … with 11 more variables: p.value.wald &lt;dbl&gt;, statistic.robust &lt;dbl&gt;,</span>
<span class="co">#&gt; #   p.value.robust &lt;dbl&gt;, r.squared &lt;dbl&gt;, r.squared.max &lt;dbl&gt;,</span>
<span class="co">#&gt; #   concordance &lt;dbl&gt;, std.error.concordance &lt;dbl&gt;, logLik &lt;dbl&gt;, AIC &lt;dbl&gt;,</span>
<span class="co">#&gt; #   BIC &lt;dbl&gt;, nobs &lt;int&gt;</span></code></pre></div>
<ul>
<li><p><strong>Note 1</strong>: There is no intercept in the linear component of the model (i.e., there is no <span class="math inline">\(\beta_0\)</span> or <span class="math inline">\(b_0).\)</span> The baseline estimate (usually the role of the “intercept”) is contained within the <span class="math inline">\(h_0(t)\)</span> parameter.<br></p></li>
<li><p><strong>Note 2</strong>: Nowhere have we made any assumptions about the form of <span class="math inline">\(h_0(t)\)</span>.<br></p></li>
<li><p><strong>Note 3</strong>: To estimate <span class="math inline">\(h_0(t)\)</span>, we use the pointwise values (here for the control group only to get <span class="math inline">\(h_0),\)</span> just like Kaplan-Meier plots <span class="math inline">\((\tau_j = t_{(j+1)} - t_j):\)</span> <span class="math display">\[h_0(t_j) = \frac{d_j}{n_j \tau_j}\]</span> If there are covariates, the estimation gets much more complicated.<br></p></li>
<li><p><strong>Note 4</strong>: The logrank statistic can be derived as the score test for the Cox proportional hazards model comparing two groups. It is therefore approximately equivalent to the likelihood ratio test statistics from that model <span class="citation">(<a href="references.html#ref-Collett" role="doc-biblioref">Collett 2015</a> (section 3.9, page 102-106))</span>. Additionally, the log-rank test is most powerful against the alternative that the hazard of death at any given time for an individual in one group is proportional to the hazard at that time for a similar individual in the other group (i.e., the proportional hazards assumption). <span class="citation">(<a href="references.html#ref-Collett" role="doc-biblioref">Collett 2015</a> (section 2.5.4, pg 44-45))</span> <span class="math display">\[
\begin{align*}
H_0:\ &amp;h_1(t) = h_2(t)\\
H_1:\ &amp;h_1(t) = R h_2(t)
\end{align*}
\]</span></p></li>
<li>
<p><strong>Note 5</strong>: You need proportional hazards to do the <em>inference</em> (otherwise your p-values are meaningless!). The technical assumptions for the Cox Proportional Hazards model are:</p>
<ul>
<li>Observations are independent (this is almost always an important assumption in all of statistical inference)<br>
</li>
<li>Proportional hazards: the hazard ratios are not dependent on time.<br>
</li>
<li>Independent censoring: the censored observations have the same survival prospects as the non-censored participants.<br>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="multcoxph" class="section level4" number="6.3.3.3">
<h4>
<span class="header-section-number">6.3.3.3</span> Cox PH Multiple Regression Analysis<a class="anchor" aria-label="anchor" href="#multcoxph"><i class="fas fa-link"></i></a>
</h4>
<p>Extending the simple proportional hazards model to include multiple covariates.</p>
<p>Let <span class="math inline">\(x_{i1}, x_{i2}, \ldots, x_{iq}\)</span> be the <span class="math inline">\(q\)</span> covariates for person <span class="math inline">\(i\)</span>. We define the baseline hazard as: <span class="math display">\[
\begin{align*}
h_0(t) &amp;= \mbox{hazard for patients with covariates }
x_{i1}=x_{i2}=\cdots=x_{iq} = 0\\
h_i(t) &amp;= h_0(t) e^{\beta_1 x_{i1} + \beta_2 x_{i2} + \cdots +
\beta_q x_{iq}}\\
\end{align*}
\]</span> is the hazard function for the <span class="math inline">\(i^{th}\)</span> patient.</p>
<p>As before, we can consider nested models and compare their likelihoods.</p>
<p><span class="math display">\[
\begin{align*}
-2 \ln \frac{L_{\mbox{reduced model}}}{L_{\mbox{full model}}}
&amp;\sim \chi^2_{\Delta p}\\
&amp; \\
2 \bigg( \ln L_{\mbox{full model}} - \ln L_{\mbox{reduced model}} \bigg) &amp;=
\mbox{test stat}\\
\end{align*}
\]</span></p>
<div class="example">
<p><span id="exm:unlabeled-div-36" class="example"><strong>Example 6.5  </strong></span><strong>Framingham Heart Study</strong> <span class="citation">(example <a href="references.html#ref-Dupont" role="doc-biblioref">Dupont 2009</a> (section 3.10))</span> Long-term follow-up and cardiovascular risk factor data on almost 5000 residents of the town of Framingham, MA. Recruitment started in 1948 (went for 40+ years). These data are 4699 patients who were free of coronary heart disease at their baseline exam <span class="citation">(<a href="references.html#ref-framingham" role="doc-biblioref">Mahmood et al. 2014</a>)</span>:</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th>variable</th>
<th align="center"></th>
<th>code</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>sex</td>
<td align="center">=</td>
<td>gender coded as</td>
</tr>
<tr class="even">
<td></td>
<td align="center"></td>
<td>1=if subject is male</td>
</tr>
<tr class="odd">
<td></td>
<td align="center"></td>
<td>0= if subject is female</td>
</tr>
<tr class="even">
<td>sbp</td>
<td align="center">=</td>
<td>systolic blood pressure (SBP) in mm Hg</td>
</tr>
<tr class="odd">
<td>dbp</td>
<td align="center">=</td>
<td>diastolic blood pressure (DBP) in mm Hg</td>
</tr>
<tr class="even">
<td>scl</td>
<td align="center">=</td>
<td>serum cholesterol (SCL) in mg/100ml</td>
</tr>
<tr class="odd">
<td>chdfate</td>
<td align="center">=</td>
<td>1= if the patient develops CHD at the end of follow-up</td>
</tr>
<tr class="even">
<td></td>
<td align="center"></td>
<td>0= otherwise</td>
</tr>
<tr class="odd">
<td>followup</td>
<td align="center">=</td>
<td>the subject’s follow-up in days</td>
</tr>
<tr class="even">
<td>age</td>
<td align="center">=</td>
<td>age in years</td>
</tr>
<tr class="odd">
<td>bmi</td>
<td align="center">=</td>
<td>body mass index (BMI) =weight/height<span class="math inline">\(^2\)</span> in kg/m<span class="math inline">\(^2\)</span>
</td>
</tr>
<tr class="even">
<td>month</td>
<td align="center">=</td>
<td>month of year in which baseline exam occurred</td>
</tr>
<tr class="odd">
<td>id</td>
<td align="center">=</td>
<td>a patient identification variable (numbered 1 to 4699)</td>
</tr>
</tbody>
</table></div>
<p>We look at the K-M survival curves broken down by diastolic blood pressure. The logrank statistic comparing all 7 groups is highly significant (<span class="math inline">\(p &lt; 10^{-52}\)</span>), and the pairwise logrank tests for adjacent pairs of risk groups are also all significant (though be careful with multiple comparisons!).</p>
</div>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">heart</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"framingham.csv"</span><span class="op">)</span>

<span class="va">heart</span> <span class="op">&lt;-</span> <span class="va">heart</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>dbpf <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span>
    <span class="va">dbp</span> <span class="op">&lt;=</span> <span class="fl">60</span> <span class="op">~</span> <span class="st">"under60"</span>,
    <span class="va">dbp</span> <span class="op">&lt;=</span><span class="fl">70</span> <span class="op">~</span> <span class="st">"60-70"</span>,
    <span class="va">dbp</span> <span class="op">&lt;=</span> <span class="fl">80</span> <span class="op">~</span> <span class="st">"70-80"</span>,
    <span class="va">dbp</span> <span class="op">&lt;=</span><span class="fl">90</span> <span class="op">~</span> <span class="st">"80-90"</span>,
    <span class="va">dbp</span> <span class="op">&lt;=</span><span class="fl">100</span> <span class="op">~</span> <span class="st">"90-100"</span>,
    <span class="va">dbp</span> <span class="op">&lt;=</span><span class="fl">110</span> <span class="op">~</span> <span class="st">"100-110"</span>,
    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"over110"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>dbpf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">dbpf</span>,
                       levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"under60"</span>, <span class="st">"60-70"</span>, <span class="st">"70-80"</span>,<span class="st">"80-90"</span>, <span class="st">"90-100"</span>,<span class="st">"100-110"</span>,<span class="st">"over110"</span><span class="op">)</span><span class="op">)</span>,
         sex <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span>
           <span class="va">sex</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"male"</span>, 
           <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"female"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><span class="math display">\[
\begin{align*}
dbp_{ij} &amp;= \left\{
\begin{array}{ll}
1 &amp; \mbox{if the } i^{th} \mbox{ patient is in DBP group } j\\
0 &amp; \mbox{otherwise}
\end{array}
\right.\\
male_i &amp;= \left\{
\begin{array}{ll}
1 &amp; \mbox{if the } i^{th} \mbox{ patient is male}\\
0 &amp; \mbox{if the } i^{th} \mbox{ patient is female}\\
\end{array}
\right.\\
\end{align*}
\]</span></p>
<ul>
<li>
<strong>Table 7.1</strong><br>
Using a proportional hazards model for estimating the hazard ratio associated with each blood pressure group, we get: <span class="math display">\[
\begin{align*}
h_i(t) &amp;= h_0(t) \exp \bigg\{ \beta_2 dbp_{i2} + \beta_3 dbp_{i3} + \beta_4 dbp_{i4} + \beta_5 dbp_{i5} + \beta_6 dbp_{i6} + \beta_7 dbp_{i7} \bigg\}\\ 
h_i(t) &amp;= h0(t) \exp \bigg\{ \sum_{j=2}^7 \beta_j dbp_{ij} \bigg\} 
\end{align*}
\]</span>
</li>
</ul>
<p>We can use the model with dbp as categorical to check whether dbp could be used as a continuous variable. Indeed, it seems that the model is linear (in ln(HR)) with respect to <code>dbp</code>. What we see (in the linearity) is that the hazard ratio for an increase in 10 dbp is constant regardless of the actual value of <code>dbp</code>. Indeed, it seems like the hazard ratio for a 10 unit increase in <code>dbp</code> is roughly <span class="math inline">\(e^{0.3}\)</span> regardless of the value of <code>dbp</code>. When the model is run on <code>dbp</code> as a continuous variable (instead of as groups) we <strong>also</strong> see that the hazard ratio associated with a 10 unit increase in <code>dbp</code> is <span class="math inline">\(e^{0.3}\)</span>.</p>
<p>One reason, however, to keep the variable broken into groups is because of the way the results are nicely laid out for each group.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">followup</span>,<span class="va">chdfate</span><span class="op">)</span> <span class="op">~</span> <span class="va">dbpf</span>, data <span class="op">=</span> <span class="va">heart</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">kable</span><span class="op">(</span>caption <span class="op">=</span> <span class="st">"coefficients for Cox PH with dpb categorical."</span>,
        digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-6">Table 6.1: </span>coefficients for Cox PH with dpb categorical.
</caption>
<thead><tr>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
p.value
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
dbpf60-70
</td>
<td style="text-align:right;">
0.677
</td>
<td style="text-align:right;">
0.247
</td>
<td style="text-align:right;">
2.74
</td>
<td style="text-align:right;">
0.006
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpf70-80
</td>
<td style="text-align:right;">
0.939
</td>
<td style="text-align:right;">
0.241
</td>
<td style="text-align:right;">
3.90
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpf80-90
</td>
<td style="text-align:right;">
1.117
</td>
<td style="text-align:right;">
0.241
</td>
<td style="text-align:right;">
4.64
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpf90-100
</td>
<td style="text-align:right;">
1.512
</td>
<td style="text-align:right;">
0.243
</td>
<td style="text-align:right;">
6.22
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpf100-110
</td>
<td style="text-align:right;">
1.839
</td>
<td style="text-align:right;">
0.254
</td>
<td style="text-align:right;">
7.23
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpfover110
</td>
<td style="text-align:right;">
2.247
</td>
<td style="text-align:right;">
0.271
</td>
<td style="text-align:right;">
8.29
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
</tbody>
</table></div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">followup</span>,<span class="va">chdfate</span><span class="op">)</span> <span class="op">~</span> <span class="va">dbp</span>, data <span class="op">=</span> <span class="va">heart</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">kable</span><span class="op">(</span>caption <span class="op">=</span> <span class="st">"coefficients for Cox PH with dpb numeric"</span>,
        digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-6">Table 6.1: </span>coefficients for Cox PH with dpb numeric
</caption>
<thead><tr>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
p.value
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:left;">
dbp
</td>
<td style="text-align:right;">
0.032
</td>
<td style="text-align:right;">
0.002
</td>
<td style="text-align:right;">
16.3
</td>
<td style="text-align:right;">
0
</td>
</tr></tbody>
</table></div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">followup</span>,<span class="va">chdfate</span><span class="op">)</span> <span class="op">~</span> <span class="va">dbpf</span>, data <span class="op">=</span> <span class="va">heart</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/glance.html">glance</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">kable</span><span class="op">(</span>caption <span class="op">=</span> <span class="st">"glance for Cox PH with dpb categorical."</span>,
        digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-6">Table 6.1: </span>glance for Cox PH with dpb categorical.
</caption>
<thead><tr>
<th style="text-align:right;">
n
</th>
<th style="text-align:right;">
nevent
</th>
<th style="text-align:right;">
statistic.log
</th>
<th style="text-align:right;">
p.value.log
</th>
<th style="text-align:right;">
statistic.sc
</th>
<th style="text-align:right;">
p.value.sc
</th>
<th style="text-align:right;">
statistic.wald
</th>
<th style="text-align:right;">
p.value.wald
</th>
<th style="text-align:right;">
statistic.robust
</th>
<th style="text-align:right;">
p.value.robust
</th>
<th style="text-align:right;">
r.squared
</th>
<th style="text-align:right;">
r.squared.max
</th>
<th style="text-align:right;">
concordance
</th>
<th style="text-align:right;">
std.error.concordance
</th>
<th style="text-align:right;">
logLik
</th>
<th style="text-align:right;">
AIC
</th>
<th style="text-align:right;">
BIC
</th>
<th style="text-align:right;">
nobs
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:right;">
4699
</td>
<td style="text-align:right;">
1473
</td>
<td style="text-align:right;">
222
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
260
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
237
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
0.05
</td>
<td style="text-align:right;">
0.99
</td>
<td style="text-align:right;">
0.61
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
-11724
</td>
<td style="text-align:right;">
23460
</td>
<td style="text-align:right;">
23492
</td>
<td style="text-align:right;">
4699
</td>
</tr></tbody>
</table></div>
<div class="figure" style="text-align: center">
<span id="fig:unnamed-chunk-7"></span>
<img src="figs/table71_CHDHR.png" alt="Table 7.1 from @Dupont." width="90%"><p class="caption">
Figure 6.1: Table 7.1 from <span class="citation"><a href="references.html#ref-Dupont" role="doc-biblioref">Dupont</a> (<a href="references.html#ref-Dupont" role="doc-biblioref">2009</a>)</span>.
</p>
</div>
<ul>
<li>
<p><strong>Table 7.2</strong><br>
As our next step, we can consider adding gender as a <em>multiplicative effect</em> to our model. <span class="math display">\[
\begin{align*}
h_i(t) &amp;= h_0(t) \exp \bigg\{ \sum_{j=2}^7 \beta_j
dbp_{ij} + \gamma male_i \bigg\}
\end{align*}
\]</span> We say the effects are multiplicative because we are adding in the exponent, so any effect due to gender will be multiplied with the effect due to dbp. How do we tell - from the results - that interaction wasn’t modeled? Look at the hazard ratios, are they consistent when comparing one variable and keeping the other one constant? That is, check to see if the HR for two different levels of dbp is the same regardless of whether men or women are considered.</p>
<ul>
<li>The change in deviance is 133 (<span class="math inline">\(H_0: \gamma =0\)</span>), so with one degree of freedom, the p-value is very small. We do not think that <span class="math inline">\(\gamma=0\)</span>, so we need gender in the model.</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">followup</span>,<span class="va">chdfate</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">dbpf</span>, data <span class="op">=</span> <span class="va">heart</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">kable</span><span class="op">(</span>caption <span class="op">=</span> <span class="st">"coefficients for Cox PH with sex and dpb categorical."</span>,
        digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-8">Table 6.2: </span>coefficients for Cox PH with sex and dpb categorical.
</caption>
<thead><tr>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
p.value
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
sexmale
</td>
<td style="text-align:right;">
0.606
</td>
<td style="text-align:right;">
0.053
</td>
<td style="text-align:right;">
11.49
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpf60-70
</td>
<td style="text-align:right;">
0.648
</td>
<td style="text-align:right;">
0.247
</td>
<td style="text-align:right;">
2.62
</td>
<td style="text-align:right;">
0.009
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpf70-80
</td>
<td style="text-align:right;">
0.888
</td>
<td style="text-align:right;">
0.241
</td>
<td style="text-align:right;">
3.69
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpf80-90
</td>
<td style="text-align:right;">
1.022
</td>
<td style="text-align:right;">
0.241
</td>
<td style="text-align:right;">
4.24
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpf90-100
</td>
<td style="text-align:right;">
1.401
</td>
<td style="text-align:right;">
0.243
</td>
<td style="text-align:right;">
5.76
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpf100-110
</td>
<td style="text-align:right;">
1.785
</td>
<td style="text-align:right;">
0.254
</td>
<td style="text-align:right;">
7.01
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpfover110
</td>
<td style="text-align:right;">
2.217
</td>
<td style="text-align:right;">
0.271
</td>
<td style="text-align:right;">
8.18
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
</tbody>
</table></div>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R">  
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">followup</span>,<span class="va">chdfate</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">dbpf</span>, data <span class="op">=</span> <span class="va">heart</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://generics.r-lib.org/reference/glance.html">glance</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">kable</span><span class="op">(</span>caption <span class="op">=</span> <span class="st">"glance for Cox PH with sex and dpb categorical."</span>,
        digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-8">Table 6.2: </span>glance for Cox PH with sex and dpb categorical.
</caption>
<thead><tr>
<th style="text-align:right;">
n
</th>
<th style="text-align:right;">
nevent
</th>
<th style="text-align:right;">
statistic.log
</th>
<th style="text-align:right;">
p.value.log
</th>
<th style="text-align:right;">
statistic.sc
</th>
<th style="text-align:right;">
p.value.sc
</th>
<th style="text-align:right;">
statistic.wald
</th>
<th style="text-align:right;">
p.value.wald
</th>
<th style="text-align:right;">
statistic.robust
</th>
<th style="text-align:right;">
p.value.robust
</th>
<th style="text-align:right;">
r.squared
</th>
<th style="text-align:right;">
r.squared.max
</th>
<th style="text-align:right;">
concordance
</th>
<th style="text-align:right;">
std.error.concordance
</th>
<th style="text-align:right;">
logLik
</th>
<th style="text-align:right;">
AIC
</th>
<th style="text-align:right;">
BIC
</th>
<th style="text-align:right;">
nobs
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:right;">
4699
</td>
<td style="text-align:right;">
1473
</td>
<td style="text-align:right;">
355
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
397
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
369
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
0.07
</td>
<td style="text-align:right;">
0.99
</td>
<td style="text-align:right;">
0.65
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
-11657
</td>
<td style="text-align:right;">
23329
</td>
<td style="text-align:right;">
23366
</td>
<td style="text-align:right;">
4699
</td>
</tr></tbody>
</table></div>
<div class="figure" style="text-align: center">
<span id="fig:unnamed-chunk-9"></span>
<img src="figs/table72_CHDHR.png" alt="Table 7.2 from @Dupont." width="90%"><p class="caption">
Figure 6.2: Table 7.2 from <span class="citation"><a href="references.html#ref-Dupont" role="doc-biblioref">Dupont</a> (<a href="references.html#ref-Dupont" role="doc-biblioref">2009</a>)</span>.
</p>
</div>
<ul>
<li>
<p><strong>Table 7.3</strong> Considering gender and dbp interacting. <span class="math display">\[
\begin{align*}
h_i(t) &amp;= h_0(t) \exp \bigg\{ \sum_{j=2}^7 \beta_j
dbp_{ij} + \gamma male_i + \sum_{j=2}^7 \delta_j dbp_{ij}
male_i \bigg\}
\end{align*}
\]</span></p>
<ul>
<li>The change in deviance is 21.23 (<span class="math inline">\(H_0: \delta_j =0\)</span>), so with six degrees of freedom, the p-value is 0.002. The evidence of interaction is statistically significant.<br>
</li>
<li>Note the marked differences between the estimates in table 7.2 and 7.3. The interactive model indicates that the effect of gender on the risk of CHD is greatest for people with low or moderate blood pressure and diminishes as blood pressure rises. Gender appears to have no effect on CHD for people with a DBP above 110 mm Hg.</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">followup</span>,<span class="va">chdfate</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span><span class="op">*</span><span class="va">dbpf</span>, data <span class="op">=</span> <span class="va">heart</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">kable</span><span class="op">(</span>caption <span class="op">=</span> <span class="st">"coefficients for Cox PH with sex and dpb categorical interacting."</span>,
        digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-10">Table 6.3: </span>coefficients for Cox PH with sex and dpb categorical interacting.
</caption>
<thead><tr>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
p.value
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
sexmale
</td>
<td style="text-align:right;">
0.864
</td>
<td style="text-align:right;">
0.471
</td>
<td style="text-align:right;">
1.833
</td>
<td style="text-align:right;">
0.067
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpf60-70
</td>
<td style="text-align:right;">
0.603
</td>
<td style="text-align:right;">
0.352
</td>
<td style="text-align:right;">
1.714
</td>
<td style="text-align:right;">
0.087
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpf70-80
</td>
<td style="text-align:right;">
0.887
</td>
<td style="text-align:right;">
0.342
</td>
<td style="text-align:right;">
2.596
</td>
<td style="text-align:right;">
0.009
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpf80-90
</td>
<td style="text-align:right;">
1.258
</td>
<td style="text-align:right;">
0.341
</td>
<td style="text-align:right;">
3.683
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpf90-100
</td>
<td style="text-align:right;">
1.546
</td>
<td style="text-align:right;">
0.347
</td>
<td style="text-align:right;">
4.458
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpf100-110
</td>
<td style="text-align:right;">
2.033
</td>
<td style="text-align:right;">
0.358
</td>
<td style="text-align:right;">
5.672
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
dbpfover110
</td>
<td style="text-align:right;">
2.612
</td>
<td style="text-align:right;">
0.372
</td>
<td style="text-align:right;">
7.023
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
sexmale:dbpf60-70
</td>
<td style="text-align:right;">
0.057
</td>
<td style="text-align:right;">
0.495
</td>
<td style="text-align:right;">
0.115
</td>
<td style="text-align:right;">
0.908
</td>
</tr>
<tr>
<td style="text-align:left;">
sexmale:dbpf70-80
</td>
<td style="text-align:right;">
-0.038
</td>
<td style="text-align:right;">
0.482
</td>
<td style="text-align:right;">
-0.079
</td>
<td style="text-align:right;">
0.937
</td>
</tr>
<tr>
<td style="text-align:left;">
sexmale:dbpf80-90
</td>
<td style="text-align:right;">
-0.458
</td>
<td style="text-align:right;">
0.482
</td>
<td style="text-align:right;">
-0.951
</td>
<td style="text-align:right;">
0.342
</td>
</tr>
<tr>
<td style="text-align:left;">
sexmale:dbpf90-100
</td>
<td style="text-align:right;">
-0.296
</td>
<td style="text-align:right;">
0.487
</td>
<td style="text-align:right;">
-0.608
</td>
<td style="text-align:right;">
0.543
</td>
</tr>
<tr>
<td style="text-align:left;">
sexmale:dbpf100-110
</td>
<td style="text-align:right;">
-0.508
</td>
<td style="text-align:right;">
0.509
</td>
<td style="text-align:right;">
-0.999
</td>
<td style="text-align:right;">
0.318
</td>
</tr>
<tr>
<td style="text-align:left;">
sexmale:dbpfover110
</td>
<td style="text-align:right;">
-0.913
</td>
<td style="text-align:right;">
0.549
</td>
<td style="text-align:right;">
-1.661
</td>
<td style="text-align:right;">
0.097
</td>
</tr>
</tbody>
</table></div>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R">  
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">followup</span>,<span class="va">chdfate</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span><span class="op">*</span><span class="va">dbpf</span>, data <span class="op">=</span> <span class="va">heart</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://generics.r-lib.org/reference/glance.html">glance</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">kable</span><span class="op">(</span>caption <span class="op">=</span> <span class="st">"glance for Cox PH with sex and dpb categorical interacting."</span>,
        digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-10">Table 6.3: </span>glance for Cox PH with sex and dpb categorical interacting.
</caption>
<thead><tr>
<th style="text-align:right;">
n
</th>
<th style="text-align:right;">
nevent
</th>
<th style="text-align:right;">
statistic.log
</th>
<th style="text-align:right;">
p.value.log
</th>
<th style="text-align:right;">
statistic.sc
</th>
<th style="text-align:right;">
p.value.sc
</th>
<th style="text-align:right;">
statistic.wald
</th>
<th style="text-align:right;">
p.value.wald
</th>
<th style="text-align:right;">
statistic.robust
</th>
<th style="text-align:right;">
p.value.robust
</th>
<th style="text-align:right;">
r.squared
</th>
<th style="text-align:right;">
r.squared.max
</th>
<th style="text-align:right;">
concordance
</th>
<th style="text-align:right;">
std.error.concordance
</th>
<th style="text-align:right;">
logLik
</th>
<th style="text-align:right;">
AIC
</th>
<th style="text-align:right;">
BIC
</th>
<th style="text-align:right;">
nobs
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:right;">
4699
</td>
<td style="text-align:right;">
1473
</td>
<td style="text-align:right;">
376
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
409
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
362
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
0.99
</td>
<td style="text-align:right;">
0.65
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
-11647
</td>
<td style="text-align:right;">
23320
</td>
<td style="text-align:right;">
23388
</td>
<td style="text-align:right;">
4699
</td>
</tr></tbody>
</table></div>
<div class="figure" style="text-align: center">
<span id="fig:unnamed-chunk-11"></span>
<img src="figs/table73_CHDHR.png" alt="Table 7.3 from @Dupont." width="90%"><p class="caption">
Figure 6.3: Table 7.3 from <span class="citation"><a href="references.html#ref-Dupont" role="doc-biblioref">Dupont</a> (<a href="references.html#ref-Dupont" role="doc-biblioref">2009</a>)</span>.
</p>
</div>
<ul>
<li>
<p><strong>Table 7.4</strong><br>
Adjusting for confounding variables. Of particular interest is age at baseline exam. We know that age varied widely among study subjects, and both DBP and risk of CHD increase with age. We will also consider the effect of body mass index and serum cholesterol. <span class="math display">\[
\begin{align*}
h_i(t) &amp;= h_0(t) \exp \bigg\{ \sum_{j=2}^7 \beta_j dbp_{ij} + \gamma male_i + \sum_{j=2}^7 \delta_j dbp_{ij} male_i \\
&amp; \ \ \ \ \ \ \ \ \ \ \ \ \ \ \  \ \ \ \ \ \  \theta_1 age_i + \theta_2 bmi_i + \theta_3 scl_i \bigg\}
\end{align*}
\]</span></p>
<ul>
<li>We need <span class="math inline">\(\theta_1, \theta_2, \theta_3\)</span>, as they are all statistically significant.</li>
<li>The HR in Table 7.4 are substantially smaller than those in Table 7.3. It is important to realize that the HR in Table 7.4 compare people of the same age, body mass index, and serum cholesterol, while those of Table 7.3 compare people without regard to other variables. It is not surprising that the unadjusted HR are inflated due to the confounding variables.</li>
<li>Goal: to predict CHD <span class="math inline">\(\rightarrow\)</span> because it’s easier to measure blood pressure than cholesterol, we may just prefer to use the unadjusted model.</li>
<li>Goal: to establish a causal link <span class="math inline">\(\rightarrow\)</span> we <em>must</em> adjust for all possible confounding variables.</li>
</ul>
</li>
</ul>
<p>When should we transform a continuous variable into a factor variable?</p>
<ul>
<li>
<strong>continuous</strong> If we believe that the relationship is linear in log(HR)<br>
</li>
<li>
<strong>factor</strong> If the relationship is not linear. Although keep in mind that there can be lots of coefficients to estimate when we make factor variables, so we lose df.</li>
</ul>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">followup</span>,<span class="va">chdfate</span><span class="op">)</span> <span class="op">~</span> <span class="va">dbpf</span> <span class="op">*</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">bmi</span> <span class="op">+</span> <span class="va">scl</span>, data <span class="op">=</span> <span class="va">heart</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 16 x 5</span>
<span class="co">#&gt;   term        estimate std.error statistic   p.value</span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 dbpf60-70      0.415     0.352      1.18 0.238    </span>
<span class="co">#&gt; 2 dbpf70-80      0.503     0.343      1.47 0.142    </span>
<span class="co">#&gt; 3 dbpf80-90      0.648     0.344      1.89 0.0592   </span>
<span class="co">#&gt; 4 dbpf90-100     0.661     0.351      1.88 0.0599   </span>
<span class="co">#&gt; 5 dbpf100-110    1.13      0.363      3.12 0.00183  </span>
<span class="co">#&gt; 6 dbpfover110    1.66      0.377      4.40 0.0000107</span>
<span class="co">#&gt; # … with 10 more rows</span>
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">followup</span>,<span class="va">chdfate</span><span class="op">)</span> <span class="op">~</span> <span class="va">dbpf</span> <span class="op">*</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">bmi</span> <span class="op">+</span> <span class="va">scl</span>, data <span class="op">=</span> <span class="va">heart</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/glance.html">glance</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 x 18</span>
<span class="co">#&gt;       n nevent statistic.log p.value.log statistic.sc p.value.sc statistic.wald</span>
<span class="co">#&gt;   &lt;int&gt;  &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;          &lt;dbl&gt;</span>
<span class="co">#&gt; 1  4658   1465          754.   5.12e-150         774.  2.21e-154           707.</span>
<span class="co">#&gt; # … with 11 more variables: p.value.wald &lt;dbl&gt;, statistic.robust &lt;dbl&gt;,</span>
<span class="co">#&gt; #   p.value.robust &lt;dbl&gt;, r.squared &lt;dbl&gt;, r.squared.max &lt;dbl&gt;,</span>
<span class="co">#&gt; #   concordance &lt;dbl&gt;, std.error.concordance &lt;dbl&gt;, logLik &lt;dbl&gt;, AIC &lt;dbl&gt;,</span>
<span class="co">#&gt; #   BIC &lt;dbl&gt;, nobs &lt;int&gt;</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:unnamed-chunk-13"></span>
<img src="figs/table74_CHDHR.png" alt="Table 7.4 from @Dupont." width="90%"><p class="caption">
Figure 6.4: Table 7.4 from <span class="citation"><a href="references.html#ref-Dupont" role="doc-biblioref">Dupont</a> (<a href="references.html#ref-Dupont" role="doc-biblioref">2009</a>)</span>.
</p>
</div>
</div>
</div>
<div id="testingph" class="section level3" number="6.3.4">
<h3>
<span class="header-section-number">6.3.4</span> Testing Proportional Hazards<a class="anchor" aria-label="anchor" href="#testingph"><i class="fas fa-link"></i></a>
</h3>
<!-- Note: in my yellow notes from 2008 I've covered all the residual analysis stuff.  The notes aren't particularly organized or well thought-out.  The topic probably isn't relevant for this class. -->
<p>As mentioned earlier, proportional hazards means that the ratio of hazard functions is not a function of time. Therefore a violation of proportional hazards means that there is interaction between the covariate (e.g., the treatment) and time when determining the response (time to event). Non-proportional hazards means you have work to do in interpreting the model and understanding the coefficients. Generally, violation of proportional hazards also means that you will have lower power.</p>
<div id="proportional-hazards-via-survival-curves" class="section level4" number="6.3.4.1">
<h4>
<span class="header-section-number">6.3.4.1</span> Proportional Hazards via survival curves:<a class="anchor" aria-label="anchor" href="#proportional-hazards-via-survival-curves"><i class="fas fa-link"></i></a>
</h4>
<p>We’ve discussed that proportional hazards means that the hazard in one group is a constant multiple of the hazard in another group. What does that mean in terms of the survival function?</p>
<p><span class="math display">\[
\begin{align*}
h_1 (t) &amp;= h_0 (t) e^\beta\\
S(t) &amp;= e^{-\int_0^t h(x) dx}\\
S_0(t) &amp;= e^{-\int_0^t h_0(x) dx}\\
S_1(t) &amp;= e^{-\int_0^t h_0(x)e^\beta dx}\\
S_1(t) &amp;= e^{- e^\beta \int_0^t h_0(x) dx}\\
S_1(t) &amp;= \bigg[ e^{- \int_0^t h_0(x) dx} \bigg]^{e^\beta}\\
\ln(S_1(t)) &amp;= e^\beta \ln [e^{- \int_0^t h_0(x) dx}]\\
-\ln(S_1(t)) &amp;= e^\beta  [-\ln(S_0(t))]\\
\ln(-\ln(S_1(t))) &amp;= \beta + \ln [-\ln(S_0(t))]\\
\end{align*}
\]</span></p>
<div id="test-1-for-ph" class="section level5 unnumbered">
<h5>Test 1 for PH<a class="anchor" aria-label="anchor" href="#test-1-for-ph"><i class="fas fa-link"></i></a>
</h5>
<p>Therefore, the <span class="math inline">\(\ln (- \ln\)</span> survival curves) should be parallel and differ only by a y-intercept constant of <span class="math inline">\(\beta\)</span>.</p>
<p>Note that if <span class="math inline">\(h_0(t)\)</span> is a constant (i.e., <span class="math inline">\(h_i(t) = e^\beta\)</span>), then</p>
<p><span class="math display">\[
\begin{align*}
S(t) &amp;= e^{-\int_0^t h(x) dx}\\
&amp;= e^{- e^\beta t}\\
\ln S(t) &amp;= - e^\beta t\\
- \ln S(t) &amp;= e^\beta t\\
\ln(- \ln S(t)) &amp;= \beta + \ln(t)\\
\end{align*}
\]</span></p>
<p>Which is to say that if <span class="math inline">\(ln(- ln S(t))\)</span> is linear in <span class="math inline">\(\ln(t)\)</span>, then <span class="math inline">\(h_0(t)\)</span> is not only PH but also constant for all <span class="math inline">\(t\)</span>.</p>
</div>
</div>
<div id="proportional-hazards-via-a-test-for-time-dependent-covariates" class="section level4" number="6.3.4.2">
<h4>
<span class="header-section-number">6.3.4.2</span> Proportional Hazards via a test for time dependent covariates<a class="anchor" aria-label="anchor" href="#proportional-hazards-via-a-test-for-time-dependent-covariates"><i class="fas fa-link"></i></a>
</h4>
<p>If the PH assumption is violated, then we have:</p>
<p><span class="math display">\[\frac{h_i(t)}{h_0(t)} = g(t)\]</span> some function of <span class="math inline">\(t\)</span>. Consider the following model (the function of time is completely specified, but it is just one possibility for the dependence relationship):</p>
<p><span class="math display">\[
\begin{align*}
x_{i1}  &amp;= \left\{
\begin{array}{ll}
1 &amp; treatment\\
0 &amp; control
\end{array}
\right.\\
x_{i2} &amp;= \left\{
\begin{array}{ll}
t &amp; treatment\\
0 &amp; control\\
\end{array}
\right.\\
\end{align*}
\]</span></p>
<p>The relative hazard becomes:
<span class="math display">\[
\begin{align*}
h_i(t) &amp;= e^{\beta_1 x_{i1} + \beta_2 x_{i2}} h_0(t)\\
\frac{h_1(t)}{h_0(t)} &amp;= e^{\beta_1 +\beta_2 t}\\
\end{align*}
\]</span></p>
<p>If <span class="math inline">\(\beta_2 &lt; 0\)</span>, the relative hazard decreases with time. If <span class="math inline">\(\beta_2 &gt; 0\)</span>, the relative hazard increases with time.</p>
<div id="test-2-for-ph" class="section level5 unnumbered">
<h5>Test 2 for PH<a class="anchor" aria-label="anchor" href="#test-2-for-ph"><i class="fas fa-link"></i></a>
</h5>
<p>The PH test of interest will be: <span class="math display">\[H_0: \beta_2 = 0\]</span> It isn’t a Wald test, but it is the same general idea (in R: <code>cox.zph</code>). [The variable in the denominator of the likelihood (for calculating the MLE) will have different values at different times.] An alternative form of the test is to call: <span class="math inline">\(x_{i2} = t \ \ \forall t\)</span> and let <span class="math display">\[h_i(t) = e^{\beta_1 x_{i1} + \beta_2 x_{i1} x_{i2}} h_0(t).\]</span></p>
<p>If there is time dependency in the model, then the <code>coxph</code> analysis won’t be accurate.</p>
</div>
</div>
<div id="proportional-hazards-via-schoenfeld-residuals" class="section level4" number="6.3.4.3">
<h4>
<span class="header-section-number">6.3.4.3</span> Proportional Hazards via Schoenfeld Residuals<a class="anchor" aria-label="anchor" href="#proportional-hazards-via-schoenfeld-residuals"><i class="fas fa-link"></i></a>
</h4>
<p>Recall: under the Cox model, the probability that any particular member <span class="math inline">\(i\)</span> fails at time <span class="math inline">\(t_j\)</span> is:</p>
<p><span class="math display">\[
\begin{align*}
P(i^{th} \mbox{ indiv w/}x_i \mbox{ dies at } t_j | \mbox{at least
one death at } t_j) &amp;= \frac{P(i^{th} \mbox{ indiv w/}x_i \mbox{
dies at } t_j )}{P(\mbox{at least one death at } t_j)}\\
&amp;= \frac{\mbox{hazard at } t_i}{\mbox{sum over all patients at risk
at time } t_j}\\
&amp;= \frac{h_i(t_j)}{\sum_{k:t_k \geq t_j} h_k (t_j)} \\
&amp;= \frac{e^{\beta x_i}}{\sum_{k:t_k \geq t_j} e^{\beta
x_k}}\\
w_j(\beta, t_j) &amp;= \frac{e^{\beta x_i}}{\sum_{k:t_k \geq t_j}
e^{\beta x_k}}
\end{align*}
\]</span></p>
<p>Using the weights above, we can calculate the average value for the <span class="math inline">\(l^{th}\)</span> covariate (i.e., explanatory variable): <span class="math display">\[\bar{x}_l (\beta,t_j) = \sum_{k: t_k \geq t_j} x_{kl}
w_j(\beta, t_j)\]</span></p>
<p>The Schoenfeld Residual for <span class="math inline">\(x_l\)</span> and any subject <span class="math inline">\(i\)</span> who is still alive at time <span class="math inline">\(t_j\)</span>, is the <em>difference</em> between the covariate <span class="math inline">\(x_{il}\)</span> for that subject and the weighted average of the covariates in the risk set: <span class="math display">\[\mbox{Schoenfeld resid }_i = x_{il} - \bar{x}_l(\beta, t_i)\]</span> Note that the calculation is for the <span class="math inline">\(i^{th}\)</span> subject which means there was a death at time <span class="math inline">\(t_i\)</span>.</p>
<div id="test-3-for-ph" class="section level5 unnumbered">
<h5>Test 3 for PH<a class="anchor" aria-label="anchor" href="#test-3-for-ph"><i class="fas fa-link"></i></a>
</h5>
<p>The idea is for the residual plot of (Schoenfeld residual wrt a paticular covariate on the y-axis, time on the x-axis)to be flat. What if there is a strong linear trend for the residuals? What would that say about the time dependency? Imagine a scatterplot where the residual is very positively linearly associated with time. If <span class="math inline">\(t_i &gt; &gt;\)</span> then <span class="math inline">\(x_i\)</span> is much bigger than expected; if <span class="math inline">\(t_i &lt; &lt;\)</span> then <span class="math inline">\(x_i\)</span> is much smaller than expected. That is, the covariate of interest changes over time and its effect on the risk of survival does, too.</p>
</div>
</div>
<div id="solutions-to-violations-of-ph" class="section level4" number="6.3.4.4">
<h4>
<span class="header-section-number">6.3.4.4</span> Solutions to violations of PH<a class="anchor" aria-label="anchor" href="#solutions-to-violations-of-ph"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>
<strong>crossing</strong> If the hazard functions (or survivor functions!) cross over time, the PH assumption is violated.<br>
</li>
<li>
<strong>help</strong> What should we do?<br>
</li>
</ul>
<ol style="list-style-type: decimal">
<li>Don’t do coxph, just fit K-M curves separately and perform a log-rank test.<br>
</li>
<li>Start at <span class="math inline">\(t^*\)</span>, the crossing point.<br>
</li>
<li>Fit different models for before <span class="math inline">\(t^*\)</span> and after <span class="math inline">\(t^*\)</span>.<br>
</li>
<li>Fit a model with a time dependent covariate.<br>
</li>
<li>Creative analysis: instead of tumor size, use % change over a set period of time.</li>
</ol>
<ul>
<li>
<p><strong>examples</strong> of PH violations</p>
<ul>
<li>over time, the treatment effect lessens (short term benefits)<br>
</li>
<li>tumor size at endpoint is more predictive than tumor size at entrance.<br>
</li>
<li>clinical variables that change over time (lung capacity, weight, white blood cell count)<br>
</li>
<li>exposure variables (pollution, UV rays, etc.)<br>
</li>
<li>age, temperature</li>
</ul>
</li>
</ul>
</div>
<div id="log-linearity" class="section level4" number="6.3.4.5">
<h4>
<span class="header-section-number">6.3.4.5</span> Log linearity<a class="anchor" aria-label="anchor" href="#log-linearity"><i class="fas fa-link"></i></a>
</h4>
<p>We’ve also assumed that the log of the hazard ratio is linear in the covariates. That a one unit change in any covariate has the same effect on the log of the HR (at any level of the covariate). Just like with logistic regression, this assumption is hard to check. However, we can see how the modeling performs by checking to see if quadratic (or other higher order terms) are significant in the model. Another possibility is to categorize a continuous predictor to check PH assumptions as above.</p>
</div>
</div>
</div>
<div id="othersurv" class="section level2" number="6.4">
<h2>
<span class="header-section-number">6.4</span> Other stuff<a class="anchor" aria-label="anchor" href="#othersurv"><i class="fas fa-link"></i></a>
</h2>
<div id="sample-size-calculation" class="section level3" number="6.4.1">
<h3>
<span class="header-section-number">6.4.1</span> Sample Size Calculation<a class="anchor" aria-label="anchor" href="#sample-size-calculation"><i class="fas fa-link"></i></a>
</h3>
<div id="sample-size-for-two-independent-sample-means-inference" class="section level4" number="6.4.1.1">
<h4>
<span class="header-section-number">6.4.1.1</span> Sample Size for Two Independent Sample Means Inference<a class="anchor" aria-label="anchor" href="#sample-size-for-two-independent-sample-means-inference"><i class="fas fa-link"></i></a>
</h4>
<p>Taking a step back to consider a slightly simpler inference (two sample mean), let’s say we want a size of <span class="math inline">\(\alpha=0.05\)</span> and a power of <span class="math inline">\(1-\beta=0.8\)</span>. What does that mean? How do they relate to the type I and type II errors? Draw some pictures. We’re talking about the only thing we can control: the sample size. We cannot actually control the truth of the hypotheses, the extent of the difference in in <span class="math inline">\(H_0\)</span> versus <span class="math inline">\(H_A\)</span>, or the variability of the underlying population. We <strong>can</strong> control the sample size. The larger your sample size, the easier it is to identify a true alternative hypothesis (that is, the higher the power).</p>
<p>In order to estimate the needed sample size, you need to know how often you are willing to make type I errors, how often you are willing to make type II errors, and how big of a difference between <span class="math inline">\(H_0\)</span> and <span class="math inline">\(H_A\)</span> you would like to determine. Without all three of those components, it is <strong>impossible</strong> to determine the sample size. If you read that a sample size calculation has been done, they <strong>must</strong> report the associated size, power, and difference (or their calculation will be meaningless).</p>
<p><span class="math display">\[
\begin{align*}
H_0: \ &amp;\mu_1 - \mu_2 = 0\\
H_A: \ &amp;\mu_1 - \mu_2 \ne 0
\end{align*}
\]</span></p>
<p>We have to make some assumptions. We assume that the size is 0.05, the power is 0.8, and the alternative hypothesis is <span class="math inline">\(D = \mu_1 - \mu_2\)</span>. For this case, let’s also assume that <span class="math inline">\(\sigma_1=\sigma_2=\sigma\)</span> and <span class="math inline">\(n_1=n_2=n\)</span>. Without loss of generality, let’s say <span class="math inline">\(\overline{Y}_1 - \overline{Y}_2 &gt; 0\)</span>.</p>
<p><span class="math display">\[
\begin{align*}
P\bigg(\frac{\overline{Y}_1 - \overline{Y}_2 - 0}{\sigma
\sqrt{1/n + 1/n}} &gt; 1.96 \bigg| \mu_1 - \mu_2 = 0 \bigg) &amp;=
0.025\\
P(\overline{Y}_1 - \overline{Y}_2 &gt; 1.96 \sigma \sqrt{1/n + 1/n}
\bigg| \mu_1 - \mu_2 = 0) &amp;= 0.025\\
P(\overline{Y}_1 - \overline{Y}_2 &gt; 1.96 \sigma \sqrt{1/n + 1/n}
\bigg| \mu_1 - \mu_2 = D) &amp;\geq 0.8\\
P\bigg(\frac{\overline{Y}_1 - \overline{Y}_2 - D}{\sigma
\sqrt{1/n + 1/n}} &gt; \frac{1.96 \sigma \sqrt{1/n + 1/n}-D}{\sigma
\sqrt{1/n + 1/n}} \bigg| \mu_1 - \mu_2 = D \bigg) &amp;\geq 0.8\\
P\bigg(Z &gt; \frac{1.96 \sigma \sqrt{1/n + 1/n}-D}{\sigma \sqrt{1/n
+ 1/n}} \bigg) &amp;\geq 0.8\\
\frac{1.96 \sigma \sqrt{1/n + 1/n}-D}{\sigma \sqrt{1/n + 1/n}}
&amp;\leq Z\_{0.8}\\
1.96 \sigma \sqrt{2/n} - D &amp;\leq Z\_{0.8} \sigma \sqrt{2/n}\\
2.845 \sigma \sqrt{2/n} &amp;\leq D\\
n &amp;\geq \frac{16 \sigma^2}{D^2}
\end{align*}
\]</span></p>
<p>Again, if we want to be able to find a 2 point difference in unrestricted versus deprived mean visual acuity scores, (<span class="math inline">\(\sigma=14\)</span>, equal sample sizes):</p>
<p><span class="math display">\[
\begin{align*}
n &amp;\geq \frac{16 \cdot 14^2}{4}\\
&amp;\geq 784
\end{align*}
\]</span></p>
</div>
<div id="sample-size-for-survival-model" class="section level4" number="6.4.1.2">
<h4>
<span class="header-section-number">6.4.1.2</span> Sample Size for Survival model<a class="anchor" aria-label="anchor" href="#sample-size-for-survival-model"><i class="fas fa-link"></i></a>
</h4>
<p>The sample size calculations below are derived from the inference done with a log-rank statistics comparing two groups. The total number of deaths required to detect a difference in groups with a size of <span class="math inline">\(\alpha\)</span> and a power of <span class="math inline">\(1-\beta\)</span> is <span class="math display">\[d = \frac{(z_{\alpha/2} + z_\beta)^2}{\pi_1 \pi_2 \theta^2_R}\]</span> where <span class="math inline">\(\pi_1\)</span> is the proportion of the sample in group 1, <span class="math inline">\(\pi_2\)</span> is the proportion of the sample in group 2, and <span class="math inline">\(\theta_R\)</span> is the log hazard ratio to detect.</p>
<p>(Derivation in <span class="citation"><a href="references.html#ref-Collett" role="doc-biblioref">Collett</a> (<a href="references.html#ref-Collett" role="doc-biblioref">2015</a>)</span> pg 256.)</p>
<p>Consider the following sample size calculator. The variables included are slightly different, but give the same general structure to the calculation. For example, the equation above calculates the number of deaths. The applet calculates the number of samples (where <span class="math inline">\(d = p_E \cdot n\)</span>). <a href="http://powerandsamplesize.com/Calculators/Test-Time-To-Event-Data/Cox-PH-Equivalence" class="uri">http://powerandsamplesize.com/Calculators/Test-Time-To-Event-Data/Cox-PH-Equivalence</a></p>
</div>
<div id="significance-level-vs.-power-vs.-sample-size" class="section level4" number="6.4.1.3">
<h4>
<span class="header-section-number">6.4.1.3</span> Significance level vs. Power vs. Sample Size<a class="anchor" aria-label="anchor" href="#significance-level-vs.-power-vs.-sample-size"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>
<strong>Sig level</strong> <span class="math inline">\(\alpha\)</span>: we <em>set</em> our type I error rate<br>
</li>
<li>
<strong>power</strong> <span class="math inline">\(1-\beta\)</span>: probability of not making a type II error. To set the power, we would need to know the sample size, significance level, and the clinically important difference that we wish to detect (effect size).<br>
</li>
<li>
<strong>sample size</strong> n: To set the sample size, we need <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, and effect size<br>
</li>
</ul>
<ol style="list-style-type: decimal">
<li>“The trial has 90% power” is meaningless<br>
</li>
<li>“With 500 subjects per group, the trial has 90% power to detect a decrease of 10mmHg in blood pressure due to the new treatment at a 0.05 significance level.”</li>
</ol>
</div>
</div>
<div id="study-design" class="section level3" number="6.4.2">
<h3>
<span class="header-section-number">6.4.2</span> Study Design<a class="anchor" aria-label="anchor" href="#study-design"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>Randomized, controlled trial</p></li>
<li>
<p>Factorial design</p>
<ul>
<li>Random allocation (within a factorial design) allows for estimation of interaction between treatments<br>
</li>
<li>Physicians’ health study was factorial with aspirin (to measure myocardial infarction) and beta carotene (cancer)<br>
</li>
<li>Can include 3 or more treatments (but would need large sample sizes to measure anything)</li>
</ul>
</li>
</ul>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th></th>
<th></th>
<th align="center">treatment A</th>
<th align="center"></th>
</tr></thead>
<tbody>
<tr class="odd">
<td></td>
<td></td>
<td align="center">Yes</td>
<td align="center">No</td>
</tr>
<tr class="even">
<td></td>
<td>Yes</td>
<td align="center">Both A &amp; B</td>
<td align="center">only B</td>
</tr>
<tr class="odd">
<td><strong>treatment B</strong></td>
<td>No</td>
<td align="center">only A</td>
<td align="center">neither</td>
</tr>
</tbody>
</table></div>
<ul>
<li>
<p>Cross-over design: all participants receive <em>both</em> treatments (e.g., surgery and chemotherapy)</p>
<ul>
<li>Each patient serves as their own control (need fewer samples)<br>
</li>
<li>Often cross-over effect from the initial treatment</li>
</ul>
</li>
</ul>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="center"><span class="math inline">\(\swarrow\)</span></th>
<th align="center"></th>
<th align="center"><span class="math inline">\(\searrow\)</span></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Group 1</td>
<td align="center"></td>
<td align="center">Group 2</td>
</tr>
<tr class="even">
<td align="center">
<span class="math inline">\(\downarrow\)</span> (1)</td>
<td align="center"></td>
<td align="center">
<span class="math inline">\(\downarrow\)</span> (1)</td>
</tr>
<tr class="odd">
<td align="center">Drug A</td>
<td align="center"><span class="math inline">\(\stackrel{(2)}{\rightarrow}\)</span></td>
<td align="center">Drug B</td>
</tr>
<tr class="even">
<td align="center"></td>
<td align="center"><span class="math inline">\(\stackrel{(2)}{\hookleftarrow}\)</span></td>
<td align="center"></td>
</tr>
</tbody>
</table></div>
<ul>
<li>
<p>Noncompliance</p>
<ul>
<li>Patients will switch on their own! How do you analyze the data?<br>
</li>
<li>Analyze according to assigned treatment (intent-to-treat). Crossover does not happen randomly and is well known to be associated to outcome.<br>
</li>
<li>Can perform a secondary analysis on only those patients who stayed on treatment.<br>
</li>
<li>Example: surgery and radiation</li>
</ul>
</li>
</ul>
<div id="subgroup-analysis" class="section level4" number="6.4.2.1">
<h4>
<span class="header-section-number">6.4.2.1</span> subgroup analysis<a class="anchor" aria-label="anchor" href="#subgroup-analysis"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li><p>Refers to analyzing a subset of patients in a trial separately (e.g., gender, race, family background, etc.)<br></p></li>
<li><p>Important for: clinical decision making, regulatory requirements, hypothesis generation<br></p></li>
<li>
<p>Problems:</p>
<ul>
<li>insufficient power. If powered for overall treatment effect, it will be underpowered to detect similar effects in subgroups.<br>
</li>
<li>multiple comparisons. If you torture your data long enough, eventually it will confess to anything.<br>
</li>
<li>whenever possible, subgroup analysis should be defined <em>a priori</em> in the protocol</li>
</ul>
</li>
</ul>
</div>
<div id="some-topics-worth-investigating" class="section level4" number="6.4.2.2">
<h4>
<span class="header-section-number">6.4.2.2</span> Some topics worth investigating<a class="anchor" aria-label="anchor" href="#some-topics-worth-investigating"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>Meta Analysis <span class="citation">(<a href="references.html#ref-crowley" role="doc-biblioref">Green, Benedetti, and Crowley 1997</a>)</span><br>
</li>
<li>General Thoughts on Clinical Trials for cancer <span class="citation">(<a href="references.html#ref-crowley" role="doc-biblioref">Green, Benedetti, and Crowley 1997</a>)</span><br>
</li>
<li>Stratified Cox Model <span class="citation">(<a href="references.html#ref-vittinghoff" role="doc-biblioref">Vittinghoff et al. 2012</a>)</span><br>
</li>
<li>Interim analyses / stopping rules<br>
</li>
<li>Intent-to-treat (missing data)<br>
</li>
<li>Investigating time-varying effects <span class="citation">(<a href="references.html#ref-timevar" role="doc-biblioref">Bellera et al. 2010</a>)</span>
</li>
</ul>
</div>
</div>
<div id="simulating-survival-data" class="section level3" number="6.4.3">
<h3>
<span class="header-section-number">6.4.3</span> Simulating survival data<a class="anchor" aria-label="anchor" href="#simulating-survival-data"><i class="fas fa-link"></i></a>
</h3>
<p>There is a package designed to simulate survival data, <code>simsurv</code>. It allows for complex models, but there is some difficulty with scenarios with very few events or with binary explanatory variables. Sam Brilleman spoke about the <code>simsurv</code> package at useR! 2018: <a href="https://www.youtube.com/watch?v=fJTYsncvpvI" class="uri">https://www.youtube.com/watch?v=fJTYsncvpvI</a>.</p>
</div>
</div>
<div id="Rsurv" class="section level2" number="6.5">
<h2>
<span class="header-section-number">6.5</span> R example: ProPublica Analysis<a class="anchor" aria-label="anchor" href="#Rsurv"><i class="fas fa-link"></i></a>
</h2>
<div id="recidivism-in-florida" class="section level3" number="6.5.1">
<h3>
<span class="header-section-number">6.5.1</span> Recidivism in Florida<a class="anchor" aria-label="anchor" href="#recidivism-in-florida"><i class="fas fa-link"></i></a>
</h3>
<blockquote>
<p>[The ProPublica] analysis of Northpointe’s tool, called COMPAS (which stands for Correctional Offender Management Profiling for Alternative Sanctions), found that black defendants were far more likely than white defendants to be incorrectly judged to be at a higher risk of recidivism, while white defendants were more likely than black defendants to be incorrectly flagged as low risk.</p>
</blockquote>
<blockquote>
<p>[ProPublica] looked at more than 10,000 criminal defendants in Broward County, Florida, and compared their predicted recidivism rates with the rate that actually occurred over a two-year period. When most defendants are booked in jail, they respond to a COMPAS questionnaire. Their answers are fed into the COMPAS software to generate several scores including predictions of “Risk of Recidivism” and “Risk of Violent Recidivism.” <span class="citation">(<a href="references.html#ref-angwin" role="doc-biblioref">Larson et al. {May 23, 2016}</a>)</span></p>
</blockquote>
<p>The original article is here: <a href="https://www.propublica.org/article/machine-bias-risk-assessments-in-criminal-sentencing" class="uri">https://www.propublica.org/article/machine-bias-risk-assessments-in-criminal-sentencing</a></p>
<p>The data analysis is here: <a href="https://www.propublica.org/article/how-we-analyzed-the-compas-recidivism-algorithm" class="uri">https://www.propublica.org/article/how-we-analyzed-the-compas-recidivism-algorithm</a></p>
<p>The GitHub repo with data and code is here: <a href="https://github.com/propublica/compas-analysis" class="uri">https://github.com/propublica/compas-analysis</a></p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span>
<span class="va">recid</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/propublica/compas-analysis/master/compas-scores-two-years.csv"</span><span class="op">)</span>

<span class="va">recid</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">recid</span>, <span class="va">age</span>, <span class="va">c_charge_degree</span>, <span class="va">race</span>, <span class="va">age_cat</span>, <span class="va">score_text</span>, <span class="va">sex</span>, <span class="va">priors_count</span>, 
                    <span class="va">days_b_screening_arrest</span>, <span class="va">decile_score</span>, <span class="va">is_recid</span>, <span class="va">two_year_recid</span>, 
                    <span class="va">c_jail_in</span>, <span class="va">c_jail_out</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">days_b_screening_arrest</span> <span class="op">&lt;=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">days_b_screening_arrest</span> <span class="op">&gt;=</span> <span class="op">-</span><span class="fl">30</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">is_recid</span> <span class="op">!=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">c_charge_degree</span> <span class="op">!=</span> <span class="st">"O"</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">score_text</span> <span class="op">!=</span> <span class="st">'N/A'</span><span class="op">)</span>
        
<span class="va">recid</span> <span class="op">&lt;-</span> <span class="va">recid</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>length_of_stay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">c_jail_out</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">c_jail_in</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">mutate</span><span class="op">(</span>crime_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">c_charge_degree</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">mutate</span><span class="op">(</span>age_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">age_cat</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/base/with.html">within</a></span><span class="op">(</span><span class="va">age_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span><span class="va">age_factor</span>, ref <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">mutate</span><span class="op">(</span>race_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">race</span>,
                                  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"African-American"</span>, 
                                             <span class="st">"Asian"</span>,
                                             <span class="st">"Caucasian"</span>, 
                                             <span class="st">"Hispanic"</span>, 
                                             <span class="st">"Native American"</span>,
                                             <span class="st">"Other"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/base/with.html">within</a></span><span class="op">(</span><span class="va">race_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span><span class="va">race_factor</span>, ref <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">mutate</span><span class="op">(</span>gender_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">sex</span>, labels<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Female"</span>,<span class="st">"Male"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/base/with.html">within</a></span><span class="op">(</span><span class="va">gender_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span><span class="va">gender_factor</span>, ref <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">mutate</span><span class="op">(</span>score_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">score_text</span> <span class="op">!=</span> <span class="st">"Low"</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LowScore"</span>,<span class="st">"HighScore"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
      </code></pre></div>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">recidKM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">read_csv</span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/propublica/compas-analysis/master/cox-parsed.csv"</span><span class="op">)</span>, <span class="va">score_text</span> <span class="op">!=</span> <span class="st">"N/A"</span><span class="op">)</span>, <span class="va">end</span> <span class="op">&gt;</span> <span class="va">start</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">mutate</span><span class="op">(</span>race_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">race</span>,
                                  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"African-American"</span>, 
                                             <span class="st">"Asian"</span>,
                                             <span class="st">"Caucasian"</span>, 
                                             <span class="st">"Hispanic"</span>, 
                                             <span class="st">"Native American"</span>,
                                             <span class="st">"Other"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/base/with.html">within</a></span><span class="op">(</span><span class="va">race_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span><span class="va">race_factor</span>, ref <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">mutate</span><span class="op">(</span>score_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">score_text</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/base/with.html">within</a></span><span class="op">(</span><span class="va">score_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span><span class="va">score_factor</span>, ref<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">mutate</span><span class="op">(</span>timefollow <span class="op">=</span> <span class="va">end</span> <span class="op">-</span> <span class="va">start</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">race</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"African-American"</span>, <span class="st">"Caucasian"</span><span class="op">)</span><span class="op">)</span>

<span class="va">recidKMV</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">read_csv</span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/propublica/compas-analysis/master/cox-violent-parsed.csv"</span><span class="op">)</span>, <span class="va">score_text</span> <span class="op">!=</span> <span class="st">"N/A"</span><span class="op">)</span>, <span class="va">end</span> <span class="op">&gt;</span> <span class="va">start</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">mutate</span><span class="op">(</span>race_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">race</span>,
                                  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"African-American"</span>, 
                                             <span class="st">"Asian"</span>,
                                             <span class="st">"Caucasian"</span>, 
                                             <span class="st">"Hispanic"</span>, 
                                             <span class="st">"Native American"</span>,
                                             <span class="st">"Other"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/base/with.html">within</a></span><span class="op">(</span><span class="va">race_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span><span class="va">race_factor</span>, ref <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">mutate</span><span class="op">(</span>score_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">score_text</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/base/with.html">within</a></span><span class="op">(</span><span class="va">score_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span><span class="va">score_factor</span>, ref<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">mutate</span><span class="op">(</span>timefollow <span class="op">=</span> <span class="va">end</span> <span class="op">-</span> <span class="va">start</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">race</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"African-American"</span>, <span class="st">"Caucasian"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="kaplan-meier-survival-curve" class="section level3" number="6.5.2">
<h3>
<span class="header-section-number">6.5.2</span> Kaplan-Meier survival curve<a class="anchor" aria-label="anchor" href="#kaplan-meier-survival-curve"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">recid.surv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKM</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">recid.surv</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, xlab<span class="op">=</span><span class="st">"time"</span>, ylab<span class="op">=</span><span class="st">"survival function"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">.4</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"low"</span>, <span class="st">"high"</span>, <span class="st">"medium"</span><span class="op">)</span>,lty<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>

<span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html">ggsurvplot</a></span><span class="op">(</span><span class="va">recid.surv</span>, conf.int<span class="op">=</span><span class="cn">TRUE</span>, censor<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Overall"</span><span class="op">)</span></code></pre></div>
<p><img src="06-surv_files/figure-html/unnamed-chunk-16-1.png" width="80%" style="display: block; margin: auto;"><img src="06-surv_files/figure-html/unnamed-chunk-16-2.png" width="80%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggsurvplot</span><span class="op">(</span><span class="va">recid.surv</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, conf.int<span class="op">=</span><span class="cn">TRUE</span>, censor<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Low Only"</span><span class="op">)</span>

<span class="fu">ggsurvplot</span><span class="op">(</span><span class="va">recid.surv</span>, conf.int<span class="op">=</span><span class="cn">TRUE</span>, censor<span class="op">=</span><span class="cn">FALSE</span>, risk.table <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="06-surv_files/figure-html/unnamed-chunk-17-1.png" width="80%" style="display: block; margin: auto;"><img src="06-surv_files/figure-html/unnamed-chunk-17-2.png" width="80%" style="display: block; margin: auto;"></p>
<p>different options for CI</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">4747</span><span class="op">)</span>
<span class="va">recidKM2</span> <span class="op">&lt;-</span> <span class="va">recidKM</span> <span class="op">%&gt;%</span> <span class="fu">sample_n</span><span class="op">(</span><span class="fl">200</span><span class="op">)</span>  <span class="co"># CI on a smaller random sample just to see the different CIs</span>
<span class="fu">ggsurvplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKM2</span><span class="op">)</span>, 
           censor<span class="op">=</span><span class="cn">F</span>, conf.int<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"No CI"</span><span class="op">)</span>
<span class="fu">ggsurvplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKM2</span>,
                   conf.type<span class="op">=</span><span class="st">"log"</span><span class="op">)</span>, censor<span class="op">=</span><span class="cn">F</span>, conf.int<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Log CI"</span><span class="op">)</span>
<span class="fu">ggsurvplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKM2</span>,
                   conf.type<span class="op">=</span><span class="st">"log-log"</span><span class="op">)</span>, censor<span class="op">=</span><span class="cn">F</span>, conf.int<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Log-Log CI"</span><span class="op">)</span>
<span class="fu">ggsurvplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKM2</span>,
                   conf.type<span class="op">=</span><span class="st">"plain"</span><span class="op">)</span>, censor<span class="op">=</span><span class="cn">F</span>, conf.int<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Plain CI"</span><span class="op">)</span>

<span class="fu">ggsurvplot_facet</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKM2</span><span class="op">)</span>, 
                 data<span class="op">=</span><span class="va">recidKM2</span>, facet.by <span class="op">=</span> <span class="st">"race"</span><span class="op">)</span></code></pre></div>
<p><img src="06-surv_files/figure-html/unnamed-chunk-18-1.png" width="80%" style="display: block; margin: auto;"><img src="06-surv_files/figure-html/unnamed-chunk-18-2.png" width="80%" style="display: block; margin: auto;"><img src="06-surv_files/figure-html/unnamed-chunk-18-3.png" width="80%" style="display: block; margin: auto;"><img src="06-surv_files/figure-html/unnamed-chunk-18-4.png" width="80%" style="display: block; margin: auto;"><img src="06-surv_files/figure-html/unnamed-chunk-18-5.png" width="80%" style="display: block; margin: auto;"></p>
</div>
<div id="log-rank-test-rho0-and-the-wilcoxon-test-rho1" class="section level3" number="6.5.3">
<h3>
<span class="header-section-number">6.5.3</span> Log-rank test [rho=0] and the Wilcoxon test [rho=1]<a class="anchor" aria-label="anchor" href="#log-rank-test-rho0-and-the-wilcoxon-test-rho1"><i class="fas fa-link"></i></a>
</h3>
<p>General recidivism</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survdiff.html">survdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKM2</span>, rho<span class="op">=</span><span class="fl">0</span><span class="op">)</span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; survdiff(formula = Surv(timefollow, event) ~ score_factor, data = recidKM2, </span>
<span class="co">#&gt;     rho = 0)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                      N Observed Expected (O-E)^2/E (O-E)^2/V</span>
<span class="co">#&gt; score_factor=Low    91       16     29.3      6.04     13.13</span>
<span class="co">#&gt; score_factor=High   52       20     11.6      6.11      7.80</span>
<span class="co">#&gt; score_factor=Medium 57       19     14.1      1.70      2.29</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  Chisq= 14.1  on 2 degrees of freedom, p= 9e-04</span>
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/survdiff.html">survdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKM2</span>, rho<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; survdiff(formula = Surv(timefollow, event) ~ score_factor, data = recidKM2, </span>
<span class="co">#&gt;     rho = 1)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                      N Observed Expected (O-E)^2/E (O-E)^2/V</span>
<span class="co">#&gt; score_factor=Low    91     13.8    24.54      4.68     11.69</span>
<span class="co">#&gt; score_factor=High   52     17.0     9.99      4.88      7.21</span>
<span class="co">#&gt; score_factor=Medium 57     15.8    12.04      1.16      1.82</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  Chisq= 12.6  on 2 degrees of freedom, p= 0.002</span>

<span class="fu">ggsurvplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKM2</span><span class="op">)</span>, 
           censor<span class="op">=</span><span class="cn">F</span>, conf.int<span class="op">=</span><span class="cn">F</span>, pval<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"No CI"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06-surv_files/figure-html/unnamed-chunk-19-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>Violent recidivism</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">4747</span><span class="op">)</span>
<span class="va">recidKMV2</span> <span class="op">&lt;-</span> <span class="va">recidKMV</span> <span class="op">%&gt;%</span>
  <span class="fu">sample_n</span><span class="op">(</span><span class="fl">500</span><span class="op">)</span>

<span class="va">recidKMV2</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">race</span> <span class="op">==</span> <span class="st">"Caucasian"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survdiff.html">survdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">.</span>, rho<span class="op">=</span><span class="fl">0</span><span class="op">)</span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; survdiff(formula = Surv(timefollow, event) ~ score_factor, data = ., </span>
<span class="co">#&gt;     rho = 0)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                       N Observed Expected (O-E)^2/E (O-E)^2/V</span>
<span class="co">#&gt; score_factor=Low    112        6    6.087   0.00126   0.00392</span>
<span class="co">#&gt; score_factor=High    25        2    0.966   1.10625   1.24725</span>
<span class="co">#&gt; score_factor=Medium  46        1    1.946   0.46016   0.58870</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  Chisq= 1.6  on 2 degrees of freedom, p= 0.5</span>

<span class="va">recidKMV2</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">race</span> <span class="op">==</span> <span class="st">"African-American"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survdiff.html">survdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">.</span>, rho<span class="op">=</span><span class="fl">0</span><span class="op">)</span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; survdiff(formula = Surv(timefollow, event) ~ score_factor, data = ., </span>
<span class="co">#&gt;     rho = 0)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                       N Observed Expected (O-E)^2/E (O-E)^2/V</span>
<span class="co">#&gt; score_factor=Low     94        3     4.11     0.301     0.488</span>
<span class="co">#&gt; score_factor=High   131        6     3.77     1.322     2.037</span>
<span class="co">#&gt; score_factor=Medium  92        2     3.12     0.401     0.560</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  Chisq= 2  on 2 degrees of freedom, p= 0.4</span>

<span class="fu"><a href="https://rdrr.io/pkg/survival/man/survdiff.html">survdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKMV2</span>, rho<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; survdiff(formula = Surv(timefollow, event) ~ score_factor, data = recidKMV2, </span>
<span class="co">#&gt;     rho = 1)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                       N Observed Expected (O-E)^2/E (O-E)^2/V</span>
<span class="co">#&gt; score_factor=Low    206     8.77     9.63    0.0771     0.158</span>
<span class="co">#&gt; score_factor=High   156     7.78     4.87    1.7317     2.389</span>
<span class="co">#&gt; score_factor=Medium 138     2.96     5.00    0.8343     1.151</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  Chisq= 2.7  on 2 degrees of freedom, p= 0.3</span>

<span class="fu">ggsurvplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKMV2</span><span class="op">)</span>, 
           censor<span class="op">=</span><span class="cn">F</span>, conf.int<span class="op">=</span><span class="cn">T</span>, pval<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Violent Recidivism"</span><span class="op">)</span>

<span class="fu">ggsurvplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKMV2</span><span class="op">)</span>, 
                 data<span class="op">=</span><span class="va">recidKMV</span>, censor <span class="op">=</span> <span class="cn">FALSE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span>, facet.by <span class="op">=</span> <span class="st">"race"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Violent Recidivism"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">recidKMV2</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># must be a data.frame see "." below:</span>
<span class="fu">ggsurvplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span> <span class="va">.</span><span class="op">)</span>, 
                 data <span class="op">=</span> <span class="va">.</span>, censor <span class="op">=</span> <span class="cn">FALSE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span>, pval<span class="op">=</span><span class="cn">TRUE</span>, facet.by <span class="op">=</span> <span class="st">"race"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Violent Recidivism"</span><span class="op">)</span></code></pre></div>
<p><img src="06-surv_files/figure-html/unnamed-chunk-20-1.png" width="80%" style="display: block; margin: auto;"><img src="06-surv_files/figure-html/unnamed-chunk-20-2.png" width="80%" style="display: block; margin: auto;"><img src="06-surv_files/figure-html/unnamed-chunk-20-3.png" width="80%" style="display: block; margin: auto;"></p>
</div>
<div id="cox-proportional-hazards-models" class="section level3" number="6.5.4">
<h3>
<span class="header-section-number">6.5.4</span> Cox Proportional Hazards models<a class="anchor" aria-label="anchor" href="#cox-proportional-hazards-models"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Just score_factor</span>
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKM</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 x 5</span>
<span class="co">#&gt;   term               estimate std.error statistic   p.value</span>
<span class="co">#&gt;   &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 score_factorHigh      1.08     0.0446      24.1 7.67e-129</span>
<span class="co">#&gt; 2 score_factorMedium    0.704    0.0439      16.0 9.78e- 58</span>
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKM</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/glance.html">glance</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 x 18</span>
<span class="co">#&gt;       n nevent statistic.log p.value.log statistic.sc p.value.sc statistic.wald</span>
<span class="co">#&gt;   &lt;int&gt;  &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;          &lt;dbl&gt;</span>
<span class="co">#&gt; 1 11426   3058          617.   9.39e-135         654.  1.15e-142           609.</span>
<span class="co">#&gt; # … with 11 more variables: p.value.wald &lt;dbl&gt;, statistic.robust &lt;dbl&gt;,</span>
<span class="co">#&gt; #   p.value.robust &lt;dbl&gt;, r.squared &lt;dbl&gt;, r.squared.max &lt;dbl&gt;,</span>
<span class="co">#&gt; #   concordance &lt;dbl&gt;, std.error.concordance &lt;dbl&gt;, logLik &lt;dbl&gt;, AIC &lt;dbl&gt;,</span>
<span class="co">#&gt; #   BIC &lt;dbl&gt;, nobs &lt;int&gt;</span>

<span class="co"># score_factor and race</span>
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span> <span class="op">+</span> <span class="va">race</span>, data<span class="op">=</span><span class="va">recidKM</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 x 5</span>
<span class="co">#&gt;   term               estimate std.error statistic   p.value</span>
<span class="co">#&gt;   &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 score_factorHigh      1.03     0.0460     22.3  3.96e-110</span>
<span class="co">#&gt; 2 score_factorMedium    0.674    0.0445     15.2  7.45e- 52</span>
<span class="co">#&gt; 3 raceCaucasian        -0.170    0.0396     -4.29 1.78e-  5</span>
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span> <span class="op">+</span> <span class="va">race</span>, data<span class="op">=</span><span class="va">recidKM</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/glance.html">glance</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 x 18</span>
<span class="co">#&gt;       n nevent statistic.log p.value.log statistic.sc p.value.sc statistic.wald</span>
<span class="co">#&gt;   &lt;int&gt;  &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;          &lt;dbl&gt;</span>
<span class="co">#&gt; 1 11426   3058          636.   1.65e-137         671.  3.72e-145           626.</span>
<span class="co">#&gt; # … with 11 more variables: p.value.wald &lt;dbl&gt;, statistic.robust &lt;dbl&gt;,</span>
<span class="co">#&gt; #   p.value.robust &lt;dbl&gt;, r.squared &lt;dbl&gt;, r.squared.max &lt;dbl&gt;,</span>
<span class="co">#&gt; #   concordance &lt;dbl&gt;, std.error.concordance &lt;dbl&gt;, logLik &lt;dbl&gt;, AIC &lt;dbl&gt;,</span>
<span class="co">#&gt; #   BIC &lt;dbl&gt;, nobs &lt;int&gt;</span>

<span class="co"># score_factor, race, age, sex</span>
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span>, data<span class="op">=</span><span class="va">recidKM</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 5 x 5</span>
<span class="co">#&gt;   term               estimate std.error statistic  p.value</span>
<span class="co">#&gt;   &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt; 1 score_factorHigh     0.926    0.0471      19.6  7.63e-86</span>
<span class="co">#&gt; 2 score_factorMedium   0.611    0.0452      13.5  1.54e-41</span>
<span class="co">#&gt; 3 raceCaucasian       -0.120    0.0398      -3.01 2.63e- 3</span>
<span class="co">#&gt; 4 age                 -0.0137   0.00175     -7.82 5.38e-15</span>
<span class="co">#&gt; 5 sexMale              0.411    0.0502       8.19 2.53e-16</span>
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span>, data<span class="op">=</span><span class="va">recidKM</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://generics.r-lib.org/reference/glance.html">glance</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 x 18</span>
<span class="co">#&gt;       n nevent statistic.log p.value.log statistic.sc p.value.sc statistic.wald</span>
<span class="co">#&gt;   &lt;int&gt;  &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;          &lt;dbl&gt;</span>
<span class="co">#&gt; 1 11426   3058          768.   8.91e-164         787.  7.45e-168           739.</span>
<span class="co">#&gt; # … with 11 more variables: p.value.wald &lt;dbl&gt;, statistic.robust &lt;dbl&gt;,</span>
<span class="co">#&gt; #   p.value.robust &lt;dbl&gt;, r.squared &lt;dbl&gt;, r.squared.max &lt;dbl&gt;,</span>
<span class="co">#&gt; #   concordance &lt;dbl&gt;, std.error.concordance &lt;dbl&gt;, logLik &lt;dbl&gt;, AIC &lt;dbl&gt;,</span>
<span class="co">#&gt; #   BIC &lt;dbl&gt;, nobs &lt;int&gt;</span></code></pre></div>
<p>Using the <code>rms</code> package, we can plot CIs for each of the relevant HRs for the model at hand:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">recid.data</span> <span class="op">&lt;-</span> <span class="va">recidKM</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">timefollow</span>, <span class="va">event</span>, <span class="va">score_factor</span>, <span class="va">race</span>, <span class="va">age</span>, <span class="va">sex</span><span class="op">)</span>
<span class="va">recid.final</span> <span class="op">&lt;-</span> <span class="fu">rms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rms/man/cph.html">cph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span>, data<span class="op">=</span><span class="va">recid.data</span><span class="op">)</span>
<span class="va">ddist</span> <span class="op">&lt;-</span> <span class="fu">rms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rms/man/datadist.html">datadist</a></span><span class="op">(</span><span class="va">recid.data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>datadist <span class="op">=</span> <span class="st">'ddist'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">recid.final</span><span class="op">)</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06-surv_files/figure-html/unnamed-chunk-22-1.png" width="80%" style="display: block; margin: auto;"></div>
</div>
<div id="checking-proportional-hazards-with-the-plot-of-ln-lnst" class="section level3" number="6.5.5">
<h3>
<span class="header-section-number">6.5.5</span> Checking proportional hazards with the plot of <span class="math inline">\(\ln(-\ln(S(t)))\)</span><a class="anchor" aria-label="anchor" href="#checking-proportional-hazards-with-the-plot-of-ln-lnst"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggsurvplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKM</span><span class="op">)</span>, 
           censor<span class="op">=</span><span class="cn">F</span>, conf.int<span class="op">=</span><span class="cn">T</span>, fun<span class="op">=</span><span class="st">"cloglog"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Complementary Log-Log"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06-surv_files/figure-html/unnamed-chunk-23-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>The cox.zph function will test proportionality of all the predictors in the model by creating interactions with time using the transformation of time specified in the transform option. In this example we are testing proportionality by looking at the interactions with log(time). The column rho is the Pearson product-moment correlation between the scaled Schoenfeld residuals and log(time) for each covariate. The last row contains the global test for all the interactions tested at once. A p-value less than 0.05 indicates a violation of the proportionality assumption.</p>
</div>
<div id="checking-proportional-hazards-with-cox.zph" class="section level3" number="6.5.6">
<h3>
<span class="header-section-number">6.5.6</span> Checking proportional hazards with cox.zph<a class="anchor" aria-label="anchor" href="#checking-proportional-hazards-with-cox.zph"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/survival/man/cox.zph.html">cox.zph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKM</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;              chisq df   p</span>
<span class="co">#&gt; score_factor 0.457  2 0.8</span>
<span class="co">#&gt; GLOBAL       0.457  2 0.8</span>
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/cox.zph.html">cox.zph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span>, data<span class="op">=</span><span class="va">recidKM</span><span class="op">)</span>, transform<span class="op">=</span><span class="st">"log"</span><span class="op">)</span>
<span class="co">#&gt;              chisq df    p</span>
<span class="co">#&gt; score_factor  3.04  2 0.22</span>
<span class="co">#&gt; GLOBAL        3.04  2 0.22</span>
<span class="fu"><a href="https://rdrr.io/pkg/survival/man/cox.zph.html">cox.zph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span>, data<span class="op">=</span><span class="va">recidKM</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;                chisq df      p</span>
<span class="co">#&gt; score_factor  0.5254  2 0.7690</span>
<span class="co">#&gt; race          7.6193  1 0.0058</span>
<span class="co">#&gt; age           6.7511  1 0.0094</span>
<span class="co">#&gt; sex           0.0387  1 0.8440</span>
<span class="co">#&gt; GLOBAL       13.6196  5 0.0182</span></code></pre></div>
<p>Note the big p-values. We do not reject the null hypothesis, so we conclude that there is no evidence of non-proportional hazards. If for example, the model seemed to be non-proportional on time but proportional on log(time), you might consider transforming the time variable (i.e., taking the natural log) in your original model.</p>
<p>The function cox.zph creates a cox.zph object that contains a list of the scaled Schoenfeld residuals. The ordering of the residuals in the list is the same order as the predictors were entered in the cox model. So, the first element of the list corresponds to the scaled Schoenfeld residuals for married, the second element corresponds to the scaled Schoenfeld residuals for person, and so forth. The cox.zph object can be used in a plot function. By specifying a particular element of the list it is possible to generate plots of residuals for individual predictors. Leaving out the list number results in plots for all the predictors being generated at one time. In the plots a non-zero slope is evidence against proportionality. The horizontal line at y=0 has been added for reference.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggcoxzph</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/cox.zph.html">cox.zph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span>, data<span class="op">=</span><span class="va">recidKM</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="06-surv_files/figure-html/unnamed-chunk-25-1.png" width="80%" style="display: block; margin: auto;"></div>
</div>
<div id="coxph-diagnostics-look-into-all-the-different-arguments-of-the-function" class="section level3" number="6.5.7">
<h3>
<span class="header-section-number">6.5.7</span> Coxph diagnostics … look into all the different arguments of the function!<a class="anchor" aria-label="anchor" href="#coxph-diagnostics-look-into-all-the-different-arguments-of-the-function"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggcoxdiagnostics</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">timefollow</span>,<span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">score_factor</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span>, data<span class="op">=</span><span class="va">recidKM</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06-surv_files/figure-html/unnamed-chunk-26-1.png" width="80%" style="display: block; margin: auto;"></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="logistic-regression.html"><span class="header-section-number">5</span> Logistic Regression</a></div>
<div class="next"><a href="multiple-comparisons.html"><span class="header-section-number">7</span> Multiple Comparisons</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#survival-analysis"><span class="header-section-number">6</span> Survival Analysis</a></li>
<li>
<a class="nav-link" href="#timedata"><span class="header-section-number">6.1</span> Time-to-event data</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#survival-function"><span class="header-section-number">6.1.1</span> Survival Function</a></li></ul>
</li>
<li>
<a class="nav-link" href="#KM"><span class="header-section-number">6.2</span> Kaplan-Meier Curves</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#KMCI"><span class="header-section-number">6.2.1</span> CI for KM curve</a></li>
<li><a class="nav-link" href="#logrank"><span class="header-section-number">6.2.2</span> Log-rank Test</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#hazfunc"><span class="header-section-number">6.3</span> Hazard Functions</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#estimating-ht-ala-kaplan-meier"><span class="header-section-number">6.3.1</span> Estimating \(h(t)\) ala Kaplan-Meier</a></li>
<li><a class="nav-link" href="#proportional-hazards"><span class="header-section-number">6.3.2</span> Proportional Hazards</a></li>
<li><a class="nav-link" href="#coxph"><span class="header-section-number">6.3.3</span> Cox PH Regression Analysis</a></li>
<li><a class="nav-link" href="#testingph"><span class="header-section-number">6.3.4</span> Testing Proportional Hazards</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#othersurv"><span class="header-section-number">6.4</span> Other stuff</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sample-size-calculation"><span class="header-section-number">6.4.1</span> Sample Size Calculation</a></li>
<li><a class="nav-link" href="#study-design"><span class="header-section-number">6.4.2</span> Study Design</a></li>
<li><a class="nav-link" href="#simulating-survival-data"><span class="header-section-number">6.4.3</span> Simulating survival data</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#Rsurv"><span class="header-section-number">6.5</span> R example: ProPublica Analysis</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#recidivism-in-florida"><span class="header-section-number">6.5.1</span> Recidivism in Florida</a></li>
<li><a class="nav-link" href="#kaplan-meier-survival-curve"><span class="header-section-number">6.5.2</span> Kaplan-Meier survival curve</a></li>
<li><a class="nav-link" href="#log-rank-test-rho0-and-the-wilcoxon-test-rho1"><span class="header-section-number">6.5.3</span> Log-rank test [rho=0] and the Wilcoxon test [rho=1]</a></li>
<li><a class="nav-link" href="#cox-proportional-hazards-models"><span class="header-section-number">6.5.4</span> Cox Proportional Hazards models</a></li>
<li><a class="nav-link" href="#checking-proportional-hazards-with-the-plot-of-ln-lnst"><span class="header-section-number">6.5.5</span> Checking proportional hazards with the plot of \(\ln(-\ln(S(t)))\)</a></li>
<li><a class="nav-link" href="#checking-proportional-hazards-with-cox.zph"><span class="header-section-number">6.5.6</span> Checking proportional hazards with cox.zph</a></li>
<li><a class="nav-link" href="#coxph-diagnostics-look-into-all-the-different-arguments-of-the-function"><span class="header-section-number">6.5.7</span> Coxph diagnostics … look into all the different arguments of the function!</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/hardin47/website/blob/master/06-surv.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/hardin47/website/edit/master/06-surv.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Methods in Biostatistics</strong>" was written by Jo Hardin. It was last built on 2021-04-26.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
