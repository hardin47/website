# Simple Linear Regression {#SLR}

```{r, include=FALSE, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, fig.height=3, fig.width=5, 
                      fig.align = "center")

library(tidyverse)
library(broom)
library(survival)
```

Though we've discussed the relationship between tests of means and simple linear regression, we will really consider simple linear regression in a much broader context (one where both the explanatory and response variables are quantitative).

The data below represents 10 different variables on health of a country measured on 143 countries.  Data taken from [@Lock5], originally from the <a href = "http://www.happyplanetindex.org/" target = "_blank">Happy Planet Index Project</a>.  Region of the world is coded as 1 = Latin America, 2 = Western nations, 3 = Middle East, 4 = Sub-Saharan Africa, 5 = South Asia, 6 = East Asia, 7 = former Communist countries.  We are going to investigate happiness and life expectancy.  

## Inference on the Linear Model

In order to make an inferential claims on a linear regression model (e.g., p-values on hypotheses about coefficients, confidence intervals for coefficients, confidence interval for the line, prediction interval for the points, ...), we have a set of technical conditions that provide the mathematical structure leading to the t-procedures (e.g., t-test).  A course more focused on linear regression would spend time discussing how robust the model is to various deviations from the following technical conditions.  For now, we will say that sometimes transformations of either the explanatory or response variables can be an effective way to mitigate deviations from the model.

As with any measurement of the data / population, regression models are built from either statistics (Roman letters to describe a sample) or parameters (Greek letters to describe a population).  For linear regression, we have one additional differentiation due to whether the observed values $(y_i)$ or the average values $(\hat{y}_i$ or $E[Y_i])$ are being modeled.  

\begin{eqnarray*}
E[Y_i|x_i] &=& \beta_0 + \beta_1 x_i \\
y_i &=& \beta_0 + \beta_1 x_i + \epsilon_i\\
&& \epsilon_i = y_i -  (\beta_0 + \beta_1 x_i)\\
\hat{y}_i &=& b_0 + b_1 x_i\\
y_i &=& b_0 + b_1 x_i + e_i\\
&& e_i = y_i - \hat{y}_i = y_i -  (b_0 + b_1 x_i)\\
\end{eqnarray*}

### Technical Conditions 


* The average value for the response variable is a linear function of the explanatory variable.
* The error terms follow a normal distribution around the linear model.
* The error terms have a mean of zero.
* The error terms have a constant variance of $\sigma^2.$
* The error terms are independent (and identically distributed).
* <a href = "http://www.rossmanchance.com/applets/2021/regshuffle/regshuffle.htm" target = "_blank">Regression applet</a>

How do we tell whether the assumptions are met?  We can't always.  But it's good to look at plots: scatter plot, residual plot, histograms of residuals.  We denote the residuals for this model as:

\begin{align}
r_i = \hat{e}_i = y_i - \hat{y}_i
\end{align}

```{r fig.cap = "Figs 3.13 and 3.15 taken from @kutner.",  out.width="95%", fig.align='center', echo=FALSE}
knitr::include_graphics("figs/transfor.jpg")
```


**important note!!**  The idea behind transformations is to make the model as appropriate as possible for the data at hand.  We want to find the correct **linear** model; we want our assumptions to hold.  We are not trying to find the most *significant* model or big $R^2.$


See section 2.9 in @KuiperSklar.  No normal probability plots (qq-plots); use histograms or boxplots to assess the symmetry and normality of the residuals.


## Fitting the regression line
How do we fit a regression line?  Find $b_0$ and $b_1$ that minimize the sum of squared distance of the points to the line (called ordinary least squares):

\begin{align}
\min \sum (y_i - \hat{y}_i)^2 &= \min RSS \mbox{ residual sum of squares}\\
RSS &= \sum (y_i - b_0 - b_1 x_i)^2\\
\frac{\partial RSS}{\partial b_0} &= 0\\
\frac{\partial RSS}{\partial b_1} &= 0\\
b_0 &= \overline{y} - b_1 \overline{x}\\
b_1 &= r \frac{s_y}{s_x}\\
&= \frac{\sum(x_i - \overline{X})(y_i - \overline{y})}{\sum(x_i - \overline{x})^2}
\end{align}


* Is that the only way to find values for $b_0$ and $b_1$? (absolute distances, maximum likelihood,...)
* Resistance to outliers?
* What is $\hat{y}$ at $\overline{x}$?

\begin{align}
\hat{y} &= b_0 + b_1 \overline{x}\\
&= \overline{y} - b_1 \overline{x} + b_1 \overline{x}\\
&= \overline{y}
\end{align}

The regression line will always pass through the point $(\overline{x}, \overline{y}).$

::: {.definition}
An estimate is *unbiased* if, over many repeated samples drawn from the population, the average value of the estimates based on the different samples would equal the population value of the parameter being estimated.  That is, a statistic is unbiased if the mean of its sampling distribution is the population parameter.
:::


## Correlation

Consider a scatterplot, you'll have variability in both directions:  $(x_i - \overline{x}) \ \ \& \ \ (y_i - \overline{y}).$

\begin{align}
\mbox{sample covariance}&\\
cov(x,y) &= \frac{1}{n-1}\sum (x_i - \overline{x}) (y_i - \overline{y})\\
\mbox{sample correlation}&\\
r(x,y) &= \frac{cov(x,y)}{s_x s_y}\\
&= \frac{\frac{1}{n-1} \sum (x_i - \overline{x}) (y_i - \overline{y})}{\sqrt{\frac{\sum(x_i - \overline{x})^2}{n-1} \frac{\sum(y_i - \overline{y})^2}{n-1}}}\\
\mbox{pop cov} &= \sigma_{xy}\\
\mbox{pop cor} &= \rho = \frac{\sigma_{xy}}{\sigma_x \sigma_y}\\
\end{align}




* $-1 \leq r \leq 1 \ \ \ \ \ \& \ \ \ -1 \leq \rho \leq 1.$  
* No Spearman's rank correlation or Kendall's $\tau.$  
* $b_1 = r \frac{s_y}{s_x}$  
    * if $r=0, b_1=0$  
    * if $r=1, b_1 > 0$ but can be anything!  
    * $r < 0 \leftrightarrow b_1 < 0, r > 0 \leftrightarrow b_1 > 0$  
* Recall that $R^2$ is the proportion of variability explained by the line.  


## Errors / Residuals
Recall, part of the technical conditions required that $\epsilon_i \sim N(0, \sigma^2).$  How do we estimate $\sigma^2?$

\begin{align}
RSS &= \sum (y_i - \hat{y}_i)^2 \ \ \ \mbox{ residual sum of squares}\\
MSS &= \sum (\hat{y}_i - \overline{y})^2 \ \ \ \mbox{ model sum of squares}\\
TSS &= \sum (y_i - \overline{y})^2 \ \ \ \mbox{ total sum of squares}\\
s_{y|x}^2 &= \hat{\sigma^2} = \frac{1}{n-2} RSS\\
s_x^2 &= \frac{1}{n-1} \sum (x_i - \overline{x})^2\\
s_y^2 &= \frac{1}{n-1} \sum (y_i - \overline{y})^2\\
var(\epsilon) &= s_{y|x}^2 = \frac{RSS}{n-2} = \frac{\sum(y_i - \hat{y}_i)^2}{n-2} = SE(\epsilon)\\
var(b_1) &= \frac{s_{y|x}^2}{(n-1) s_x^2}\\
SE(b_1) &= \frac{s_{y|x}}{\sqrt{(n-1)} s_x}\\
&= \frac{\hat{\sigma}}{\sqrt{\sum(x_i - \overline{x})^2}} = \frac{\sqrt{\sum(y_i - \hat{y}_i)^2/(n-2)}}{\sqrt{\sum(x_i - \overline{x})^2}}\\
\end{align}

* $SE(b_1) \downarrow$ as $\sigma \downarrow$
* $SE(b_1) \downarrow$ as $n \uparrow$
* $SE(b_1) \downarrow$ as $s_x \uparrow$
* WHY?
* What do we mean by $SE(b_1)$?

As we saw above, the correlation and the slope estimates are intimately related.  They are also both related to the *coefficient of determination*.
\begin{align}
R^2 = r^2 = \frac{MSS}{TSS}
\end{align}

$R^2$ is the proportion of total variability explained by the regression line (the linear relationship between the explanatory and response variables).

* If $x$ and $y$ are not at all correlated, $\hat{y}_i \approx \overline{y},$ MSS = 0, $R^2=0.$
* If $x$ and $y$ are perfectly correlated, $\hat{y}_i = y_i,$ MSS=TSS, $R^2 = 1.$


### Testing $\beta_1$
If the technical conditions hold, the mathematics describing the sampling distribution of $b_1$ are well defined.  That is:

If $H_0: \beta=0$ is true, then
\begin{align}
\frac{b_1 - 0}{SE(b_1)} \sim t_{n-2}
\end{align}
Note that the degrees of freedom are now $n-2$ because we are estimating two parameters $(\beta_0$ and $\beta_1).$  We can also find a $(1-\alpha)100\%$ confidence interval for $\beta_1$:
\begin{align}
b_1 \pm t_{\alpha/2, n-2} SE(b_1)
\end{align}


## Intervals {#intervals}

As with anything that has some type of standard error, we can create intervals that give us some confidence in the statements we are making.

### Confidence Intervals

In general, confidence intervals are of the form:

```
point estimate +/- multiplier * SE(point estimate)
```

### Slope

We can create a CI for the slope parameter, $\beta_1$:
\begin{align}
b_1 &\pm t_{\alpha/2,n-2} SE(b_1)\\
b_1 &\pm t_{\alpha/2, n-2} \frac{s_{y|x}}{\sqrt{(n-1)}s_x}\\
6.693 &\pm t_{.025, 141} 0.375\\
t_{.025,141} &= qt(0.025, 141) = -1.977\\
\mbox{CI: } & (5.95 \mbox{ years/unit of happy}, 7.43 \mbox{ years/unit of happy})
\end{align}
How can we interpret the CI?  Does it make sense to talk about a unit of happiness?

### Mean Response
We can also create a CI for the mean response, $E[Y|x^*] = \beta_0 + \beta_1 x^*.$  Note that the standard error of the point estimate $(\hat{y}=b_0 + b_1 x^*)$ now depends on the variability associated with two things ($b_0, b_1).$
\begin{align}
SE(\hat{y(x^*)}) &= \sqrt{ \frac{s^2_{y|x}}{n} + (x^* - \overline{x})^2 SE(b_1)^2}\\
SE(\hat{y}(\overline{x})) &= s_{y|x}/\sqrt{n}\\
SE(\hat{y}(x)) &\geq s_{y|x}/\sqrt{n} \ \ \ \forall x
\end{align}
How would you interpret the associated interval?


### Prediction of an Individual Response

As should be obvious, predicting an individual is more variable than predicting a mean.

\begin{align}
SE(y(x^*)) &= \sqrt{ \frac{s^2_{y|x}}{n} + (x^* - \overline{x})^2 SE(b_1)^2 + s^2_{y|x}}\\
SE(y(x^*)) &= \sqrt{ SE(\hat{y}(x^*))^2 + s^2_{y|x}}\\
\end{align}
How would you interpret the associated interval?


## Influential Points {#infl}

**We are skipping Section \@ref(infl); you are not responsible for it.**

::: {.theorem}
*High leverage points* are x-outliers with the potential to exert undue influence on regression coefficient estimates.  *Influential points* are points that have exerted undue influence on the regression coefficient estimates.
:::

Note: typically we think of more data as better; more values will tend to decrease the sampling variability of our statistic.  But if I give you a lot more data and put it all at $\overline{x},$ $SE(b_1)$ stays exactly the same.  Why??

Recall
\begin{align}
y_{i} &= \beta_0 + \beta_1 x_i \ \ \ \epsilon_i \sim N(0,\sigma^2)\\
e_i &= y_i - \hat{y}_i
\end{align}

We plot $e_i$ versus $\hat{y}_i.$  (Why?  Typically, we want the $e_i$ to be constant at each value of $x_i.$  Note that $\hat{y}_i$ is a simple linear transformation of $x_i,$ so the plot is identical.)  We want to see if the distributions of the residuals is different across the fitted line (we look for patterns).


**Not all residuals have an equal effect on the regression line!!**

### leverage
\begin{align}
h_i = \frac{1}{n} +\frac{(x_i - \overline{x})^2}{\sum_{j=1}^n (x_j - \overline{x})^2}\\
\frac{1}{n} \leq h_i \leq 1\\
\end{align}
Leverage represents the effect of point $x_i$ on the line.  We need large leverage for a particular value to have a large effect.

Note:
\begin{align}
SE(\hat{y}(x_i)) &= s_{y|x} \sqrt{h_i}\\
SE(y(x_i)) &= s_{y|x} \sqrt{(h_i + 1)}\\
SE(e_i) &= s_{y|x} \sqrt{(1-h_i)}\\
\hat{y}(x^*) &\pm t_{n-2, .025} (s_{y|x} \sqrt{h(x^*)+1})\\
\end{align}
is a 95% prediction interval at $x^*.$  High leverage reduces the variability because the line gets pulled toward the point.

### standardized residuals

\begin{align}
\frac{e_i}{s_{y|x} \sqrt{1-h_i}} \sim t_{n-2}\\
\end{align}

### studentized residuals

\begin{align}
\frac{e_i}{s_{y|x, (i)} \sqrt{1-h_i}} &\sim t_{n-3}\\
s_{y|x, (i)} &= \frac{1}{n-3} \sum_{j \ne i} (y_j - \hat{y}_{j(i)})^2
\end{align}

Where do we predict 90% of residuals?  $\pm t_{n-2,3 , .05}.$  Approximately $\pm 2.$

### DFBETAs

DFBETAs represent the change in the parameter estimate due to one observation.

\begin{align}
DFBETAS_i &= \frac{b_1 - b_{1(i)}}{\frac{s_{y|x, (i)}}{\sqrt{(n-1)} s_x}}\\
\end{align}




## R Example (SLR): Happy Planet  
  

The data below represents 10 different variables on health of a country measured on 143 countries.  Data taken from [@Lock5], originally from the Happy Planet Index Project [http://www.happyplanetindex.org/].  Region of the world is coded as 1 = Latin America, 2 = Western nations, 3 = Middle East, 4 = Sub-Saharan Africa, 5 = South Asia, 6 = East Asia, 7 = former Communist countries.  We are going to investigate happiness and life expectancy.  


### Reading the data into R
```{r warning=FALSE, message=FALSE, echo = TRUE}
happy <- read_delim("./data/happyPlanet.txt", delim="\t")
glimpse(happy)  
```


### Running the linear model (lm)

```{r echo = TRUE}
happy.lm = lm(LifeExpectancy ~ Happiness, data=happy) 

happy.lm %>% tidy()
```

### Ouptut

Some analyses will need the residuals, fitted values, or coefficients individually.
```{r echo = TRUE}
happy.lm %>% augment()
```


We can plot the main relationship, or we can plot the residuals (to check that technical conditions hold):
```
happy %>%
         ggplot(aes(x=Happiness, y=LifeExpectancy)) + 
         geom_point() + 
         geom_smooth(method="lm", se=FALSE) 

happy.lm %>% 
         augment() %>% 
         ggplot(aes(x = .fitted, y = .resid)) + 
         geom_point() + 
         geom_hline(yintercept=0)
```

```{r fig.height=3, echo=FALSE}
library(ggpubr)
p1 <- ggplot(happy, aes(x=Happiness, y=LifeExpectancy)) + geom_point() + 
         geom_smooth(method="lm", se=FALSE) 
p2 <- happy.lm %>% augment %>% ggplot(aes(x = .fitted, y = .resid)) + geom_point() +
         geom_hline(yintercept=0)
ggarrange(p1, p2, ncol=2)
```


Intervals of interest: mean response, individual response, and parameter(s).
```{r echo = TRUE}
predict.lm(happy.lm, newdata=list(Happiness=c(4,7)),interval=c("conf"), level=.95)
predict.lm(happy.lm, newdata=list(Happiness=c(4,7)),interval=c("pred"), level=.95)

happy.lm %>% tidy(conf.int = TRUE)
```
  
  
#### Residuals in R

We skipped the residuals section, so you are not responsible for finding residuals in R, but the R code is here for completion in case you are interested:
  

```{r echo = TRUE}
happy.lm %>% augment()
```









