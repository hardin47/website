{
  "hash": "84f5e126c45fa782b5625165ad80fca2",
  "result": {
    "markdown": "# **SQL** extras {#sec-db-etc}\n\n\n\n\n\n::: {.cell fig.asp='0.618'}\n\n:::\n\n\n\n\n#### Back to the flights {-}\n\nThe examples below use the `airlines` database, including the `flights`, `carriers`, `airports`, and `planes` tables.\n\n## Efficiencies\n\nIt is worth pointing out a few aspects to loading data into **SQL**: keys, indexes, and partitioning.\n\nBefore we get to the definitions, consider this analogy:\n\n> Each library (`database`) has books (`table`s). Each book (`table`) has pages (rows). Each page (row) has a unique page number to identify it (`key` value); to find a particular page, you sort through the page numbers (`key` values). But it isn't immediately obvious where the particular page of interest is, you might have to page through the book a little bit to find the page of interest.  It would be easier if you had several bookmarks throughout the book to anchor some of the page numbers.  For example, if you want page 1047 and you have a bookmark on page 1050, you only have to turn back three pages.  The bookmark is an `index`, it helps you find the desired rows much more quickly.^[Analogy taken from: https://www.quora.com/profile/Lara-Mazilu]\n\n\n### Key\n\nKeys are unique identifiers for each row, used primarily for connecting tables. Keys are generally not helpful for efficiency, but they are important for data integrity and relationships between tables. A key is a pointer that identifies a record. In practice, a key is one or more columns that are earmarked to uniquely identify a record in a table. Keys serve two main purposes:\n\n1. They provide constraints on the column such as that it can't store duplicate or null values.\n2. They are also used to generate relationships among different tables.\n\n* `PRIMARY KEY` is a column or set of columns that uniquely identify each row.  Primary keys cannot be `NULL`. Each table must always have one (and only one) PK. The PK can be made up of one column, but if that isn't enough to uniquely identify the row, more columns may be added. Sometimes it is easier to designate a numeric column (e.g., row number) to be the PK.\n* `FOREIGN KEY` is a column or set of columns that reference a primary key in a different table.  The FK links two tables together, and the link is called a relationship.\n\n(There are other keys such as: Super Key, Minimal Super Key, Candidate Key, Unique Key, Alternate Key, Composite Key, Natural Key, Surrogate Key.)\n\n\n\n### Index\n\nIndexes are the crux of why **SQL** is so much more efficient than, say, **R**.  An index is a lookup table that helps **SQL** keep track of which records contain certain values.  By indexing the rows, **SQL** is able to optimize sorting and joining tables.  The index is created in advance (when the table is created) and saved to disk, which can take up substantial space on the disk.  Sometimes more than one variable is used to index the table. There are trade-offs to having a lot of indexes (disk space but fast wrangling) versus a few indexes (slow wrangling but less space).\n\nA table may have more than one index but you shouldn't add indexes to every column in a table, as these have to be updated for every addition/update/delete to the column. Rather, indexes should be added to columns that are frequently included in queries.\n\nIndexes may not make much difference for small databases, but, as tables grow in size, queries benefit more from indexes.\n\nIn **MySQL** the commands `SHOW KEYS` and `SHOW INDEXES` provide information about the keys and indexes for each table (the two operations are synonymous in **MySQL**).  Neither operation is available in **DuckDB**.\n\nNotice that the `planes` table has a single `PRIMARY` key.  That primary key is used to index the table.  The `flights` table has no `PRIMARY` key, but it does have six different indexes: `Year`, `Date`, `Origin`, `Dest`, `Carrier`, and `tailNum`.\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSHOW INDEXES FROM planes;\n```\n\n\n<div class=\"knitsql-table\">\n<table>\n<caption>1 records</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Table </th>\n   <th style=\"text-align:right;\"> Non_unique </th>\n   <th style=\"text-align:left;\"> Key_name </th>\n   <th style=\"text-align:right;\"> Seq_in_index </th>\n   <th style=\"text-align:left;\"> Column_name </th>\n   <th style=\"text-align:left;\"> Collation </th>\n   <th style=\"text-align:right;\"> Cardinality </th>\n   <th style=\"text-align:right;\"> Sub_part </th>\n   <th style=\"text-align:left;\"> Packed </th>\n   <th style=\"text-align:left;\"> Null </th>\n   <th style=\"text-align:left;\"> Index_type </th>\n   <th style=\"text-align:left;\"> Comment </th>\n   <th style=\"text-align:left;\"> Index_comment </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> planes </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> PRIMARY </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> tailnum </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:right;\"> 3322 </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> BTREE </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n  </tr>\n</tbody>\n</table>\n\n</div>\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSHOW INDEXES FROM flights;\n```\n\n\n<div class=\"knitsql-table\">\n<table>\n<caption>8 records</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Table </th>\n   <th style=\"text-align:right;\"> Non_unique </th>\n   <th style=\"text-align:left;\"> Key_name </th>\n   <th style=\"text-align:right;\"> Seq_in_index </th>\n   <th style=\"text-align:left;\"> Column_name </th>\n   <th style=\"text-align:left;\"> Collation </th>\n   <th style=\"text-align:right;\"> Cardinality </th>\n   <th style=\"text-align:right;\"> Sub_part </th>\n   <th style=\"text-align:left;\"> Packed </th>\n   <th style=\"text-align:left;\"> Null </th>\n   <th style=\"text-align:left;\"> Index_type </th>\n   <th style=\"text-align:left;\"> Comment </th>\n   <th style=\"text-align:left;\"> Index_comment </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Year </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> year </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> YES </td>\n   <td style=\"text-align:left;\"> BTREE </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Date </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> year </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> YES </td>\n   <td style=\"text-align:left;\"> BTREE </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Date </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> month </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:right;\"> 89 </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> YES </td>\n   <td style=\"text-align:left;\"> BTREE </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Date </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> day </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:right;\"> 2712 </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> YES </td>\n   <td style=\"text-align:left;\"> BTREE </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Origin </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> origin </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:right;\"> 2267 </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> BTREE </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Dest </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> dest </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:right;\"> 2267 </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> BTREE </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Carrier </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> carrier </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:right;\"> 134 </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> BTREE </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> tailNum </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> tailnum </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:right;\"> 37862 </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> YES </td>\n   <td style=\"text-align:left;\"> BTREE </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n  </tr>\n</tbody>\n</table>\n\n</div>\n:::\n\n\nThe values output by `SHOW INDEXES` are:^[Taken from: https://dev.mysql.com/doc/refman/8.0/en/show-index.html]\n\n* `Table`: The name of the table.\n\n* `Non_unique`: 0 if the index cannot contain duplicates, 1 if it can.\n\n* `Key_name`: The name of the index. If the index is the primary key, the name is always `PRIMARY`.\n\n* `Seq_in_index`: The column sequence number in the index, starting with 1.\n\n* `Column_name`: The column name. See also the description for the Expression column.\n\n* `Collation`: How the column is sorted in the index. This can have values A (ascending), D (descending), or NULL (not sorted).\n\n* `Cardinality`: An estimate of the number of unique values in the index.  \nCardinality is counted based on statistics stored as integers, so the value is not necessarily exact even for small tables. The higher the cardinality, the greater the chance that **MySQL** uses the index when doing joins. Indexing with a high cardinality variable will be particularly useful for increased efficiency (if that variable is being queried).\n\n* `Sub_part`: The index prefix. That is, the number of indexed characters if the column is only partly indexed, NULL if the entire column is indexed.\n\n* `Packed`: Indicates how the key is packed. `NULL` if it is not.\n\n* `Null`: Contains `YES` if the column may contain `NULL` values and '' if not.\n\n* `Index_type`: The index method used (`BTREE`, `FULLTEXT`, `HASH`, `RTREE`).\n\n* `Comment`: Information about the index not described in its own column, such as disabled if the index is disabled.\n\n* `Index_comment`: Any comment provided for the index with a `COMMENT` attribute when the index was created.\n\n\n\n### Partitioning\n\nAnother way to speed up query retrievals is to partition the data tables.  If, for example, the SNL queries were always done by year, then the `episodes` table could be partitioned such that they are stored as separate tables (one per `year`).  The partitioning functions as an index on `year`.  The user would not be able to tell the difference between the unpartitioned `episodes` table and the partitioned one.  However, queries done by `year` would be faster.  Queries done grouped in another way would be slower.\n\n### Querying\n\nIndexes are built to accommodate the specific queries that are most likely to be run.  However, you might not know which queries are going to be run, so it isn't always obviously how to index a table.\n\nFor the flights table, it seems likely that many queries will involve searching for flights from a particular origin, or to a particular destination, or during a particular year (or range of years), or on a specific carrier, and so indexes have been built on each of those columns. There is also a Date index, since it seems likely that people would want to search for flights on a certain date. However, it does not seem so likely that people would search for flights in a specific month across all years, and thus we have not built an index on month alone. The Date index does contain the month column, but the index can only be used if year is also part of the query.\n\n\n::: {.cell output.var='show_index' fig.asp='0.618'}\n\n```{.sql .cell-code}\nSHOW INDEXES FROM flights;\n```\n:::\n\n::: {#tbl-show-index .cell tbl-cap='SQL information about how the query will be run.  Because distance is not indexed, all 48 million rows must be searched.' fig.asp='0.618'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Table </th>\n   <th style=\"text-align:right;\"> Non_unique </th>\n   <th style=\"text-align:left;\"> Key_name </th>\n   <th style=\"text-align:right;\"> Seq_in_index </th>\n   <th style=\"text-align:left;\"> Column_name </th>\n   <th style=\"text-align:right;\"> Cardinality </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Year </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> year </td>\n   <td style=\"text-align:right;\"> 7 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Date </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> year </td>\n   <td style=\"text-align:right;\"> 7 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Date </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> month </td>\n   <td style=\"text-align:right;\"> 89 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Date </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> day </td>\n   <td style=\"text-align:right;\"> 2712 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Origin </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> origin </td>\n   <td style=\"text-align:right;\"> 2267 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Dest </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> dest </td>\n   <td style=\"text-align:right;\"> 2267 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Carrier </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> carrier </td>\n   <td style=\"text-align:right;\"> 134 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> tailNum </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> tailnum </td>\n   <td style=\"text-align:right;\"> 37862 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n#### efficiencies in `SELECT`ing {-}\n\n**MySQL** provides information about how it is going to perform a query using the `EXPLAIN` syntax. The information communicates how onerous the query is, without actually running it—saving you the time of having to wait for it to execute. @tbl-explain-query-dist provides output that reflects the query plan returned by the **MySQL** server.\n\n\n::: {.cell output.var='explain_query_dist' fig.asp='0.618'}\n\n```{.sql .cell-code}\nEXPLAIN SELECT * FROM flights WHERE distance > 3000;\n```\n:::\n\n::: {#tbl-explain-query-dist .cell tbl-cap='SQL information about how the query will be run.  Because distance is not indexed, all 48 million rows must be searched.' fig.asp='0.618'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> id </th>\n   <th style=\"text-align:left;\"> select_type </th>\n   <th style=\"text-align:left;\"> table </th>\n   <th style=\"text-align:left;\"> partitions </th>\n   <th style=\"text-align:left;\"> type </th>\n   <th style=\"text-align:left;\"> possible_keys </th>\n   <th style=\"text-align:left;\"> key </th>\n   <th style=\"text-align:left;\"> key_len </th>\n   <th style=\"text-align:left;\"> ref </th>\n   <th style=\"text-align:right;\"> rows </th>\n   <th style=\"text-align:right;\"> filtered </th>\n   <th style=\"text-align:left;\"> Extra </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> SIMPLE </td>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:left;\"> p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p17,p18,p19,p20,p21,p22,p23,p24,p25,p26,p27,p28,p29,p30,p31,p32 </td>\n   <td style=\"text-align:left;\"> ALL </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:right;\"> 47932811 </td>\n   <td style=\"text-align:right;\"> 33.3 </td>\n   <td style=\"text-align:left;\"> Using where </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nIf we were to run a query for long flights using the `distance` column the server will have to inspect **each** of the 48 million rows, because `distance` is not indexed. A query on a non-indexed variable is the slowest possible search and is often called a table scan. The 48 million number that you see in the rows column is an estimate of the number of rows that **MySQL** will have to consult in order to process your query. In general, more rows mean a slower query.\n\n\nOn the other hand, a search for recent flights using the `year` column, which has an index built on it, considers many fewer rows (about 6.3 million, those flights in 2013).\n\n\n::: {.cell output.var='explain_query_year' fig.asp='0.618'}\n\n```{.sql .cell-code}\nEXPLAIN SELECT * FROM flights WHERE year = 2013;\n```\n:::\n\n::: {#tbl-explain-query-year .cell tbl-cap='SQL information about how the query will be run.  Because year is indexed, only 6 million rows (those in 2013) must be searched.' fig.asp='0.618'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> id </th>\n   <th style=\"text-align:left;\"> select_type </th>\n   <th style=\"text-align:left;\"> table </th>\n   <th style=\"text-align:left;\"> partitions </th>\n   <th style=\"text-align:left;\"> type </th>\n   <th style=\"text-align:left;\"> possible_keys </th>\n   <th style=\"text-align:left;\"> key </th>\n   <th style=\"text-align:left;\"> key_len </th>\n   <th style=\"text-align:left;\"> ref </th>\n   <th style=\"text-align:right;\"> rows </th>\n   <th style=\"text-align:right;\"> filtered </th>\n   <th style=\"text-align:left;\"> Extra </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> SIMPLE </td>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:left;\"> p27 </td>\n   <td style=\"text-align:left;\"> ALL </td>\n   <td style=\"text-align:left;\"> Year,Date </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:right;\"> 6369482 </td>\n   <td style=\"text-align:right;\"> 100 </td>\n   <td style=\"text-align:left;\"> Using where </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\nIn a search by `year` and `month`, **SQL** uses the `Date` index. Only 700,000 rows are searched, those in June of 2013.\n\n\n::: {.cell output.var='explain_query_date' fig.asp='0.618'}\n\n```{.sql .cell-code}\nEXPLAIN SELECT * FROM flights WHERE year = 2013 AND month = 6;\n```\n:::\n\n::: {#tbl-explain-query-date .cell tbl-cap='SQL information about how the query will be run.  Because year and month are both indexed, only 700,000 rows (those in June of 2013) must be searched.' fig.asp='0.618'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> id </th>\n   <th style=\"text-align:left;\"> select_type </th>\n   <th style=\"text-align:left;\"> table </th>\n   <th style=\"text-align:left;\"> partitions </th>\n   <th style=\"text-align:left;\"> type </th>\n   <th style=\"text-align:left;\"> possible_keys </th>\n   <th style=\"text-align:left;\"> key </th>\n   <th style=\"text-align:left;\"> key_len </th>\n   <th style=\"text-align:left;\"> ref </th>\n   <th style=\"text-align:right;\"> rows </th>\n   <th style=\"text-align:right;\"> filtered </th>\n   <th style=\"text-align:left;\"> Extra </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> SIMPLE </td>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:left;\"> p27 </td>\n   <td style=\"text-align:left;\"> ref </td>\n   <td style=\"text-align:left;\"> Year,Date </td>\n   <td style=\"text-align:left;\"> Date </td>\n   <td style=\"text-align:left;\"> 6 </td>\n   <td style=\"text-align:left;\"> const,const </td>\n   <td style=\"text-align:right;\"> 714535 </td>\n   <td style=\"text-align:right;\"> 100 </td>\n   <td style=\"text-align:left;\">  </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\nIf we search for particular months across all years, the indexing does not help at all.  The query results in a table scan.\n\n\n::: {.cell output.var='explain_query_month' fig.asp='0.618'}\n\n```{.sql .cell-code}\nEXPLAIN SELECT * FROM flights WHERE month = 6;\n```\n:::\n\n::: {#tbl-explain-query-month .cell tbl-cap='SQL information about how the query will be run.  Because month is not indexed on its own, all rows (48 million!) must be searched.' fig.asp='0.618'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> id </th>\n   <th style=\"text-align:left;\"> select_type </th>\n   <th style=\"text-align:left;\"> table </th>\n   <th style=\"text-align:left;\"> partitions </th>\n   <th style=\"text-align:left;\"> type </th>\n   <th style=\"text-align:left;\"> possible_keys </th>\n   <th style=\"text-align:left;\"> key </th>\n   <th style=\"text-align:left;\"> key_len </th>\n   <th style=\"text-align:left;\"> ref </th>\n   <th style=\"text-align:right;\"> rows </th>\n   <th style=\"text-align:right;\"> filtered </th>\n   <th style=\"text-align:left;\"> Extra </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> SIMPLE </td>\n   <td style=\"text-align:left;\"> flights </td>\n   <td style=\"text-align:left;\"> p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p17,p18,p19,p20,p21,p22,p23,p24,p25,p26,p27,p28,p29,p30,p31,p32 </td>\n   <td style=\"text-align:left;\"> ALL </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:right;\"> 47932811 </td>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> Using where </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\nAlthough month is part of the `Date` index, it is the **second** column in the index, and thus it doesn't help us when we aren't filtering on year. Thus, if it were common for our users to search on month without year, it would probably be worth building an index on month. Were we to actually run these queries, there would be a significant difference in computational time.\n\n#### efficiencies in `JOIN`ing {-}\n\nUsing indexes is especially important for efficiency when performing `JOIN` operations on large tables. In the two examples below, both queries use indexes. However, because the cardinality of the index on `tailnum` is larger that the cardinality of the index on `year` (see @tbl-show-index), the number of rows in `flights` associated with each unique value of `tailnum` is smaller than for each unique value of `year`. Thus, the first query runs faster.\n\n\n\n::: {.cell output.var='explain_join_tail' fig.asp='0.618'}\n\n```{.sql .cell-code}\nEXPLAIN \n  SELECT * FROM planes p \n  LEFT JOIN flights o ON p.tailnum = o.TailNum\n  WHERE manufacturer = 'BOEING';\n```\n:::\n\n::: {#tbl-explain-join-tail .cell tbl-cap='SQL information about how the query will be run.  Because month is not indexed on its own, all rows (48 million!) must be searched.' fig.asp='0.618'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> id </th>\n   <th style=\"text-align:left;\"> select_type </th>\n   <th style=\"text-align:left;\"> table </th>\n   <th style=\"text-align:right;\"> rows </th>\n   <th style=\"text-align:left;\"> key </th>\n   <th style=\"text-align:left;\"> key_len </th>\n   <th style=\"text-align:left;\"> ref </th>\n   <th style=\"text-align:left;\"> partitions </th>\n   <th style=\"text-align:left;\"> type </th>\n   <th style=\"text-align:left;\"> possible_keys </th>\n   <th style=\"text-align:right;\"> filtered </th>\n   <th style=\"text-align:left;\"> Extra </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> SIMPLE </td>\n   <td style=\"text-align:left;\"> p </td>\n   <td style=\"text-align:right;\"> 3322 </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> ALL </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> Using where </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> SIMPLE </td>\n   <td style=\"text-align:left;\"> o </td>\n   <td style=\"text-align:right;\"> 1266 </td>\n   <td style=\"text-align:left;\"> tailNum </td>\n   <td style=\"text-align:left;\"> 9 </td>\n   <td style=\"text-align:left;\"> airlines.p.tailnum </td>\n   <td style=\"text-align:left;\"> p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p17,p18,p19,p20,p21,p22,p23,p24,p25,p26,p27,p28,p29,p30,p31,p32 </td>\n   <td style=\"text-align:left;\"> ref </td>\n   <td style=\"text-align:left;\"> tailNum </td>\n   <td style=\"text-align:right;\"> 100 </td>\n   <td style=\"text-align:left;\">  </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n::: {.cell output.var='explain_join_year' fig.asp='0.618'}\n\n```{.sql .cell-code}\nEXPLAIN \n  SELECT * FROM planes p \n  LEFT JOIN flights o ON p.Year = o.Year\n  WHERE manufacturer = 'BOEING';\n```\n:::\n\n::: {#tbl-explain-join-year .cell tbl-cap='SQL information about how the query will be run.  Because month is not indexed on its own, all rows (48 million!) must be searched.' fig.asp='0.618'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> id </th>\n   <th style=\"text-align:left;\"> select_type </th>\n   <th style=\"text-align:left;\"> table </th>\n   <th style=\"text-align:right;\"> rows </th>\n   <th style=\"text-align:left;\"> key </th>\n   <th style=\"text-align:left;\"> key_len </th>\n   <th style=\"text-align:left;\"> ref </th>\n   <th style=\"text-align:left;\"> partitions </th>\n   <th style=\"text-align:left;\"> type </th>\n   <th style=\"text-align:left;\"> possible_keys </th>\n   <th style=\"text-align:right;\"> filtered </th>\n   <th style=\"text-align:left;\"> Extra </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> SIMPLE </td>\n   <td style=\"text-align:left;\"> p </td>\n   <td style=\"text-align:right;\"> 3322 </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> ALL </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> Using where </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> SIMPLE </td>\n   <td style=\"text-align:left;\"> o </td>\n   <td style=\"text-align:right;\"> 6450117 </td>\n   <td style=\"text-align:left;\"> Year </td>\n   <td style=\"text-align:left;\"> 3 </td>\n   <td style=\"text-align:left;\"> airlines.p.year </td>\n   <td style=\"text-align:left;\"> p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p17,p18,p19,p20,p21,p22,p23,p24,p25,p26,p27,p28,p29,p30,p31,p32 </td>\n   <td style=\"text-align:left;\"> ref </td>\n   <td style=\"text-align:left;\"> Year,Date </td>\n   <td style=\"text-align:right;\"> 100 </td>\n   <td style=\"text-align:left;\"> Using where </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n\n## **SQL** in **dbplyr**\n\n\n### Median\n\nLet's start with an example, calculating the median `alt`itude in the `airports` table.  (Using `airports` instead of `flights` just because the `airports` table is so much smaller.)^[Example taken from: https://sebhastian.com/mysql-median/]\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\nairports <- tbl(con_air, \"airports\")\n\nhead(airports)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# Source:   SQL [6 x 9]\n# Database: mysql  [mdsr_public@mdsr.cdc7tgkkqd0n.us-east-1.rds.amazonaws.com:NA/airlines]\n  faa   name                           lat   lon   alt    tz dst   city  country\n  <chr> <chr>                        <dbl> <dbl> <int> <int> <chr> <chr> <chr>  \n1 04G   Lansdowne Airport             41.1 -80.6  1044    -5 A     Youn… United…\n2 06A   Moton Field Municipal Airpo…  32.5 -85.7   264    -6 A     Tusk… United…\n3 06C   Schaumburg Regional           42.0 -88.1   801    -6 A     Scha… United…\n4 06N   Randall Airport               41.4 -74.4   523    -5 A     Midd… United…\n5 09J   Jekyll Island Airport         31.1 -81.4    11    -5 A     Jeky… United…\n6 0A9   Elizabethton Municipal Airp…  36.4 -82.2  1593    -5 A     Eliz… United…\n```\n:::\n:::\n\n\nIt seems as though the **SQL** query to calculate the median should be reasonably straightforward.\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\nmedian_query <- airports |>\n  summarize(med_alt = median(alt, na.rm = TRUE))\n\nshow_query(median_query)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n<SQL>\nSELECT PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY `alt`) AS `med_alt`\nFROM `airports`\n```\n:::\n:::\n\n\nBut when the **SQL** query is applied to the `airports` table, we get an error.\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSELECT PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY `alt`) AS `med_alt`\nFROM `airports`;\n```\n\n\n::: {.cell-output .cell-output-stdout}\n```\nError: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'GROUP (ORDER BY `alt`) AS `med_alt`\nFROM `airports`' at line 1 [1064]\n```\n:::\n:::\n\n\n\nAdditionally, the **R** code itself doesn't run and gives the same error.  Huh, maybe calculating the median is actually harder than it seems (yes, it is).\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\nairports |>\n  summarize(med_alt = median(alt, na.rm = TRUE))\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in `collect()`:\n! Failed to collect lazy table.\nCaused by error:\n! You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'GROUP (ORDER BY `alt`) AS `med_alt`\nFROM `airports`\nLIMIT 7' at line 1 [1064]\n```\n:::\n:::\n\n\n\n\nOne way to calculate the median is to use a row index on the sorted values.  Note that attaching a row index to the sorted values requires the values to be sorted (sorting can take a long time).\n\n\nBelow is the full code to calculate the median.\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSET @row_index := -1;\n```\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSELECT AVG(subquery.alt) AS median_value\nFROM (\nSELECT @row_index:=@row_index + 1 AS row_index, alt\n  FROM airports\n  ORDER BY alt\n) AS subquery\nWHERE subquery.row_index IN (FLOOR(@row_index / 2), CEIL(@row_index / 2));\n```\n\n\n<div class=\"knitsql-table\">\n<table>\n<caption>1 records</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> median_value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 476 </td>\n  </tr>\n</tbody>\n</table>\n\n</div>\n:::\n\n\n\nBut let's break down what the code is doing...  First, set the `row_index` to -1 and iterate through by adding +1 for each row.  Then concatenate the `row_index` information onto our table of interest.\n\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSET @row_index := -1;\n```\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSELECT @row_index:=@row_index + 1 AS row_index, alt\n  FROM airports\n  ORDER BY alt\n  LIMIT 10;\n```\n\n\n<div class=\"knitsql-table\">\n<table>\n<caption>Displaying records 1 - 10</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> row_index </th>\n   <th style=\"text-align:right;\"> alt </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 0 </td>\n   <td style=\"text-align:right;\"> -54 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1 </td>\n   <td style=\"text-align:right;\"> -42 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 4 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 5 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 6 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 7 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 8 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 9 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n</tbody>\n</table>\n\n</div>\n:::\n\n\n\nNext, filter the data to include only the middle row or two rows.\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSET @row_index := -1;\n```\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSELECT *\nFROM (\nSELECT @row_index:=@row_index + 1 AS row_index, alt\n  FROM airports\n  ORDER BY alt\n) AS subquery\nWHERE subquery.row_index IN (FLOOR(@row_index / 2), CEIL(@row_index / 2));\n```\n\n\n<div class=\"knitsql-table\">\n<table>\n<caption>2 records</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> row_index </th>\n   <th style=\"text-align:right;\"> alt </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 728 </td>\n   <td style=\"text-align:right;\"> 474 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 729 </td>\n   <td style=\"text-align:right;\"> 477 </td>\n  </tr>\n</tbody>\n</table>\n\n</div>\n:::\n\n\n\nThe last step is to average the middle row(s).  If only one row is pulled out in the previous query, then only one row will be averaged (which the computer does happily).\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSET @row_index := -1;\n```\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSELECT AVG(subquery.alt) AS median_value\nFROM (\nSELECT @row_index:=@row_index + 1 AS row_index, alt\n  FROM airports\n  ORDER BY alt\n) AS subquery\nWHERE subquery.row_index IN (FLOOR(@row_index / 2), CEIL(@row_index / 2));\n```\n\n\n<div class=\"knitsql-table\">\n<table>\n<caption>1 records</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> median_value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 476 </td>\n  </tr>\n</tbody>\n</table>\n\n</div>\n:::\n\n\n**For a computer to calculate the median**: If sorting the numbers and then finding the (average of the) middle numbers, the task will take $O(nlog(n))$ time.  That is, a dataset with 1000 records will be $(1000 \\cdot log(1000)) / (100 \\cdot log(100)) = 10 \\cdot log(900)$ times slower than a data set with 100 records.  There are some caveats:  (1) some sorting algorithms are faster, and (2) you don't need to sort every number to get the median.  But generally, sorting is a slow operation!\n\n**For a computer to calculate the mean**:  Averaging is just summing, and it happens in linear time, $O(n)$.  That means that a dataset with 1000 records will be $1000/100 = 10$ times slower than a dataset with 100 records.\n\n**Verdict:** Generally, for a computer, it is easier to calculate a mean than a median, because of the need to sort in finding a median.\n\n\n### `CASE WHEN` \n\nConsider the various R functions that create new variables based on an original variable.  The `CASE WHEN` function in **SQL** plays the role of multiple R functions including `ifelse()`, `case_when()`, and `cut()`.  \n\n#### `ifelse()` {-}\n\nWith `ifelse()` the **R** translates directly to `CASE WHEN` in **SQL**, and the **SQL** query runs easily.\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\nairports |>\n  mutate(sea = ifelse(alt > 500, \"above sea\", \"near sea\")) |>\n  head(5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# Source:   SQL [5 x 10]\n# Database: mysql  [mdsr_public@mdsr.cdc7tgkkqd0n.us-east-1.rds.amazonaws.com:NA/airlines]\n  faa   name                     lat   lon   alt    tz dst   city  country sea  \n  <chr> <chr>                  <dbl> <dbl> <int> <int> <chr> <chr> <chr>   <chr>\n1 04G   Lansdowne Airport       41.1 -80.6  1044    -5 A     Youn… United… abov…\n2 06A   Moton Field Municipal…  32.5 -85.7   264    -6 A     Tusk… United… near…\n3 06C   Schaumburg Regional     42.0 -88.1   801    -6 A     Scha… United… abov…\n4 06N   Randall Airport         41.4 -74.4   523    -5 A     Midd… United… abov…\n5 09J   Jekyll Island Airport   31.1 -81.4    11    -5 A     Jeky… United… near…\n```\n:::\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\nif_query <- airports |>\n  mutate(sea = ifelse(alt > 500, \"above sea\", \"near sea\"))\n\nshow_query(if_query)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n<SQL>\nSELECT\n  *,\n  CASE WHEN (`alt` > 500.0) THEN 'above sea' WHEN NOT (`alt` > 500.0) THEN 'near sea' END AS `sea`\nFROM `airports`\n```\n:::\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSELECT *,\nCASE WHEN (`alt` > 500.0) THEN 'above sea' WHEN NOT (`alt` > 500.0) THEN 'near sea' END AS `sea`\nFROM `airports` \nLIMIT 5;\n```\n\n\n<div class=\"knitsql-table\">\n<table>\n<caption>5 records</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> faa </th>\n   <th style=\"text-align:left;\"> name </th>\n   <th style=\"text-align:right;\"> lat </th>\n   <th style=\"text-align:right;\"> lon </th>\n   <th style=\"text-align:right;\"> alt </th>\n   <th style=\"text-align:right;\"> tz </th>\n   <th style=\"text-align:left;\"> dst </th>\n   <th style=\"text-align:left;\"> city </th>\n   <th style=\"text-align:left;\"> country </th>\n   <th style=\"text-align:left;\"> sea </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 04G </td>\n   <td style=\"text-align:left;\"> Lansdowne Airport </td>\n   <td style=\"text-align:right;\"> 41.1 </td>\n   <td style=\"text-align:right;\"> -80.6 </td>\n   <td style=\"text-align:right;\"> 1044 </td>\n   <td style=\"text-align:right;\"> -5 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Youngstown </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> above sea </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 06A </td>\n   <td style=\"text-align:left;\"> Moton Field Municipal Airport </td>\n   <td style=\"text-align:right;\"> 32.5 </td>\n   <td style=\"text-align:right;\"> -85.7 </td>\n   <td style=\"text-align:right;\"> 264 </td>\n   <td style=\"text-align:right;\"> -6 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Tuskegee </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> near sea </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 06C </td>\n   <td style=\"text-align:left;\"> Schaumburg Regional </td>\n   <td style=\"text-align:right;\"> 42.0 </td>\n   <td style=\"text-align:right;\"> -88.1 </td>\n   <td style=\"text-align:right;\"> 801 </td>\n   <td style=\"text-align:right;\"> -6 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Schaumburg </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> above sea </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 06N </td>\n   <td style=\"text-align:left;\"> Randall Airport </td>\n   <td style=\"text-align:right;\"> 41.4 </td>\n   <td style=\"text-align:right;\"> -74.4 </td>\n   <td style=\"text-align:right;\"> 523 </td>\n   <td style=\"text-align:right;\"> -5 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Middletown </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> above sea </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 09J </td>\n   <td style=\"text-align:left;\"> Jekyll Island Airport </td>\n   <td style=\"text-align:right;\"> 31.1 </td>\n   <td style=\"text-align:right;\"> -81.4 </td>\n   <td style=\"text-align:right;\"> 11 </td>\n   <td style=\"text-align:right;\"> -5 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Jekyll Island </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> near sea </td>\n  </tr>\n</tbody>\n</table>\n\n</div>\n:::\n\n\n\n#### `case_when()`\n\nWith `case_when()` the **R** translates directly to `CASE WHEN` in **SQL**, and the **SQL** query runs easily.\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\nairports |>\n  mutate(sea = case_when(\n    alt < 500 ~ \"near sea\",\n    alt < 2000 ~ \"low alt\",\n    alt < 3000 ~ \"mod alt\",\n    alt < 5500 ~ \"high alt\",\n    alt > 5500 ~ \"extreme alt\")) |>\n  head(5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# Source:   SQL [5 x 10]\n# Database: mysql  [mdsr_public@mdsr.cdc7tgkkqd0n.us-east-1.rds.amazonaws.com:NA/airlines]\n  faa   name                     lat   lon   alt    tz dst   city  country sea  \n  <chr> <chr>                  <dbl> <dbl> <int> <int> <chr> <chr> <chr>   <chr>\n1 04G   Lansdowne Airport       41.1 -80.6  1044    -5 A     Youn… United… low …\n2 06A   Moton Field Municipal…  32.5 -85.7   264    -6 A     Tusk… United… near…\n3 06C   Schaumburg Regional     42.0 -88.1   801    -6 A     Scha… United… low …\n4 06N   Randall Airport         41.4 -74.4   523    -5 A     Midd… United… low …\n5 09J   Jekyll Island Airport   31.1 -81.4    11    -5 A     Jeky… United… near…\n```\n:::\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\ncw_query <- airports |>\n  mutate(sea = case_when(\n    alt < 500 ~ \"near sea\",\n    alt < 2000 ~ \"low alt\",\n    alt < 3000 ~ \"mod alt\",\n    alt < 5500 ~ \"high alt\",\n    alt > 5500 ~ \"extreme alt\"))\n\nshow_query(cw_query)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n<SQL>\nSELECT\n  *,\n  CASE\nWHEN (`alt` < 500.0) THEN 'near sea'\nWHEN (`alt` < 2000.0) THEN 'low alt'\nWHEN (`alt` < 3000.0) THEN 'mod alt'\nWHEN (`alt` < 5500.0) THEN 'high alt'\nWHEN (`alt` > 5500.0) THEN 'extreme alt'\nEND AS `sea`\nFROM `airports`\n```\n:::\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSELECT\n  *,\n  CASE\nWHEN (`alt` < 500.0) THEN 'near sea'\nWHEN (`alt` < 2000.0) THEN 'low alt'\nWHEN (`alt` < 3000.0) THEN 'mod alt'\nWHEN (`alt` < 5500.0) THEN 'high alt'\nWHEN (`alt` > 5500.0) THEN 'extreme alt'\nEND AS `sea`\nFROM `airports`\nLIMIT 5;\n```\n\n\n<div class=\"knitsql-table\">\n<table>\n<caption>5 records</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> faa </th>\n   <th style=\"text-align:left;\"> name </th>\n   <th style=\"text-align:right;\"> lat </th>\n   <th style=\"text-align:right;\"> lon </th>\n   <th style=\"text-align:right;\"> alt </th>\n   <th style=\"text-align:right;\"> tz </th>\n   <th style=\"text-align:left;\"> dst </th>\n   <th style=\"text-align:left;\"> city </th>\n   <th style=\"text-align:left;\"> country </th>\n   <th style=\"text-align:left;\"> sea </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 04G </td>\n   <td style=\"text-align:left;\"> Lansdowne Airport </td>\n   <td style=\"text-align:right;\"> 41.1 </td>\n   <td style=\"text-align:right;\"> -80.6 </td>\n   <td style=\"text-align:right;\"> 1044 </td>\n   <td style=\"text-align:right;\"> -5 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Youngstown </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> low alt </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 06A </td>\n   <td style=\"text-align:left;\"> Moton Field Municipal Airport </td>\n   <td style=\"text-align:right;\"> 32.5 </td>\n   <td style=\"text-align:right;\"> -85.7 </td>\n   <td style=\"text-align:right;\"> 264 </td>\n   <td style=\"text-align:right;\"> -6 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Tuskegee </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> near sea </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 06C </td>\n   <td style=\"text-align:left;\"> Schaumburg Regional </td>\n   <td style=\"text-align:right;\"> 42.0 </td>\n   <td style=\"text-align:right;\"> -88.1 </td>\n   <td style=\"text-align:right;\"> 801 </td>\n   <td style=\"text-align:right;\"> -6 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Schaumburg </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> low alt </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 06N </td>\n   <td style=\"text-align:left;\"> Randall Airport </td>\n   <td style=\"text-align:right;\"> 41.4 </td>\n   <td style=\"text-align:right;\"> -74.4 </td>\n   <td style=\"text-align:right;\"> 523 </td>\n   <td style=\"text-align:right;\"> -5 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Middletown </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> low alt </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 09J </td>\n   <td style=\"text-align:left;\"> Jekyll Island Airport </td>\n   <td style=\"text-align:right;\"> 31.1 </td>\n   <td style=\"text-align:right;\"> -81.4 </td>\n   <td style=\"text-align:right;\"> 11 </td>\n   <td style=\"text-align:right;\"> -5 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Jekyll Island </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> near sea </td>\n  </tr>\n</tbody>\n</table>\n\n</div>\n:::\n\n\n\n#### `cut()` {-}\n\nWith `cut()` the **R** translates directly to `CASE WHEN` in **SQL**, and the **SQL** query runs easily.\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\nairports |>\n  mutate(sea = cut(\n    alt,\n    breaks = c(-Inf, 500, 2000, 3000, 5500, Inf),\n    labels = c(\"near sea\", \"low alt\", \"mod alt\", \"high alt\", \"extreme alt\")\n  )\n)|>\n  head(5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# Source:   SQL [5 x 10]\n# Database: mysql  [mdsr_public@mdsr.cdc7tgkkqd0n.us-east-1.rds.amazonaws.com:NA/airlines]\n  faa   name                     lat   lon   alt    tz dst   city  country sea  \n  <chr> <chr>                  <dbl> <dbl> <int> <int> <chr> <chr> <chr>   <chr>\n1 04G   Lansdowne Airport       41.1 -80.6  1044    -5 A     Youn… United… low …\n2 06A   Moton Field Municipal…  32.5 -85.7   264    -6 A     Tusk… United… near…\n3 06C   Schaumburg Regional     42.0 -88.1   801    -6 A     Scha… United… low …\n4 06N   Randall Airport         41.4 -74.4   523    -5 A     Midd… United… low …\n5 09J   Jekyll Island Airport   31.1 -81.4    11    -5 A     Jeky… United… near…\n```\n:::\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\ncw_query <- airports |>\n  mutate(sea = cut(\n    alt,\n    breaks = c(-Inf, 500, 2000, 3000, 5500, Inf),\n    labels = c(\"near sea\", \"low alt\", \"mod alt\", \"high alt\", \"extreme alt\")\n  )\n)\n\nshow_query(cw_query)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n<SQL>\nSELECT\n  *,\n  CASE\nWHEN (`alt` <= 500.0) THEN 'near sea'\nWHEN (`alt` <= 2000.0) THEN 'low alt'\nWHEN (`alt` <= 3000.0) THEN 'mod alt'\nWHEN (`alt` <= 5500.0) THEN 'high alt'\nWHEN (`alt` > 5500.0) THEN 'extreme alt'\nEND AS `sea`\nFROM `airports`\n```\n:::\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSELECT\n  *,\n  CASE\nWHEN (`alt` <= 500.0) THEN 'near sea'\nWHEN (`alt` <= 2000.0) THEN 'low alt'\nWHEN (`alt` <= 3000.0) THEN 'mod alt'\nWHEN (`alt` <= 5500.0) THEN 'high alt'\nWHEN (`alt` > 5500.0) THEN 'extreme alt'\nEND AS `sea`\nFROM `airports`\nLIMIT 5;\n```\n\n\n<div class=\"knitsql-table\">\n<table>\n<caption>5 records</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> faa </th>\n   <th style=\"text-align:left;\"> name </th>\n   <th style=\"text-align:right;\"> lat </th>\n   <th style=\"text-align:right;\"> lon </th>\n   <th style=\"text-align:right;\"> alt </th>\n   <th style=\"text-align:right;\"> tz </th>\n   <th style=\"text-align:left;\"> dst </th>\n   <th style=\"text-align:left;\"> city </th>\n   <th style=\"text-align:left;\"> country </th>\n   <th style=\"text-align:left;\"> sea </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 04G </td>\n   <td style=\"text-align:left;\"> Lansdowne Airport </td>\n   <td style=\"text-align:right;\"> 41.1 </td>\n   <td style=\"text-align:right;\"> -80.6 </td>\n   <td style=\"text-align:right;\"> 1044 </td>\n   <td style=\"text-align:right;\"> -5 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Youngstown </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> low alt </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 06A </td>\n   <td style=\"text-align:left;\"> Moton Field Municipal Airport </td>\n   <td style=\"text-align:right;\"> 32.5 </td>\n   <td style=\"text-align:right;\"> -85.7 </td>\n   <td style=\"text-align:right;\"> 264 </td>\n   <td style=\"text-align:right;\"> -6 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Tuskegee </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> near sea </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 06C </td>\n   <td style=\"text-align:left;\"> Schaumburg Regional </td>\n   <td style=\"text-align:right;\"> 42.0 </td>\n   <td style=\"text-align:right;\"> -88.1 </td>\n   <td style=\"text-align:right;\"> 801 </td>\n   <td style=\"text-align:right;\"> -6 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Schaumburg </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> low alt </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 06N </td>\n   <td style=\"text-align:left;\"> Randall Airport </td>\n   <td style=\"text-align:right;\"> 41.4 </td>\n   <td style=\"text-align:right;\"> -74.4 </td>\n   <td style=\"text-align:right;\"> 523 </td>\n   <td style=\"text-align:right;\"> -5 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Middletown </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> low alt </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 09J </td>\n   <td style=\"text-align:left;\"> Jekyll Island Airport </td>\n   <td style=\"text-align:right;\"> 31.1 </td>\n   <td style=\"text-align:right;\"> -81.4 </td>\n   <td style=\"text-align:right;\"> 11 </td>\n   <td style=\"text-align:right;\"> -5 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Jekyll Island </td>\n   <td style=\"text-align:left;\"> United States </td>\n   <td style=\"text-align:left;\"> near sea </td>\n  </tr>\n</tbody>\n</table>\n\n</div>\n:::\n\n\n\n### `SELECT DISTINCT`\n\nHow many distinct time zones are there in the `airports` table?  `distinct()` translates to `SELECT DISTINCT` which runs easily on our `tbl`.\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\nairports |>\n  select(tz) |>\n  distinct()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# Source:   SQL [?? x 1]\n# Database: mysql  [mdsr_public@mdsr.cdc7tgkkqd0n.us-east-1.rds.amazonaws.com:NA/airlines]\n     tz\n  <int>\n1    -5\n2    -6\n3    -8\n4    -7\n5    -9\n6   -10\n# ℹ more rows\n```\n:::\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\ndist_query <- airports |>\n  select(tz) |>\n  distinct()\n\nshow_query(dist_query)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n<SQL>\nSELECT DISTINCT `tz`\nFROM `airports`\n```\n:::\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSELECT DISTINCT `tz`\nFROM `airports`;\n```\n\n\n<div class=\"knitsql-table\">\n<table>\n<caption>7 records</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> tz </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> -5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> -6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> -8 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> -7 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> -9 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> -10 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n  </tr>\n</tbody>\n</table>\n\n</div>\n:::\n\n\n\n\n\n### `LIMIT` \n\nAs expected, `head()` translates to `LIMIT` which we've already used many many times.\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\nairports |>\n  head(5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# Source:   SQL [5 x 9]\n# Database: mysql  [mdsr_public@mdsr.cdc7tgkkqd0n.us-east-1.rds.amazonaws.com:NA/airlines]\n  faa   name                           lat   lon   alt    tz dst   city  country\n  <chr> <chr>                        <dbl> <dbl> <int> <int> <chr> <chr> <chr>  \n1 04G   Lansdowne Airport             41.1 -80.6  1044    -5 A     Youn… United…\n2 06A   Moton Field Municipal Airpo…  32.5 -85.7   264    -6 A     Tusk… United…\n3 06C   Schaumburg Regional           42.0 -88.1   801    -6 A     Scha… United…\n4 06N   Randall Airport               41.4 -74.4   523    -5 A     Midd… United…\n5 09J   Jekyll Island Airport         31.1 -81.4    11    -5 A     Jeky… United…\n```\n:::\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\nhead_query <- airports |>\n  head(5)\n\nshow_query(head_query)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n<SQL>\nSELECT *\nFROM `airports`\nLIMIT 5\n```\n:::\n:::\n\n::: {.cell fig.asp='0.618'}\n\n```{.sql .cell-code}\nSELECT *\nFROM `airports`\nLIMIT 5;\n```\n\n\n<div class=\"knitsql-table\">\n<table>\n<caption>5 records</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> faa </th>\n   <th style=\"text-align:left;\"> name </th>\n   <th style=\"text-align:right;\"> lat </th>\n   <th style=\"text-align:right;\"> lon </th>\n   <th style=\"text-align:right;\"> alt </th>\n   <th style=\"text-align:right;\"> tz </th>\n   <th style=\"text-align:left;\"> dst </th>\n   <th style=\"text-align:left;\"> city </th>\n   <th style=\"text-align:left;\"> country </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 04G </td>\n   <td style=\"text-align:left;\"> Lansdowne Airport </td>\n   <td style=\"text-align:right;\"> 41.1 </td>\n   <td style=\"text-align:right;\"> -80.6 </td>\n   <td style=\"text-align:right;\"> 1044 </td>\n   <td style=\"text-align:right;\"> -5 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Youngstown </td>\n   <td style=\"text-align:left;\"> United States </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 06A </td>\n   <td style=\"text-align:left;\"> Moton Field Municipal Airport </td>\n   <td style=\"text-align:right;\"> 32.5 </td>\n   <td style=\"text-align:right;\"> -85.7 </td>\n   <td style=\"text-align:right;\"> 264 </td>\n   <td style=\"text-align:right;\"> -6 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Tuskegee </td>\n   <td style=\"text-align:left;\"> United States </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 06C </td>\n   <td style=\"text-align:left;\"> Schaumburg Regional </td>\n   <td style=\"text-align:right;\"> 42.0 </td>\n   <td style=\"text-align:right;\"> -88.1 </td>\n   <td style=\"text-align:right;\"> 801 </td>\n   <td style=\"text-align:right;\"> -6 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Schaumburg </td>\n   <td style=\"text-align:left;\"> United States </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 06N </td>\n   <td style=\"text-align:left;\"> Randall Airport </td>\n   <td style=\"text-align:right;\"> 41.4 </td>\n   <td style=\"text-align:right;\"> -74.4 </td>\n   <td style=\"text-align:right;\"> 523 </td>\n   <td style=\"text-align:right;\"> -5 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Middletown </td>\n   <td style=\"text-align:left;\"> United States </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 09J </td>\n   <td style=\"text-align:left;\"> Jekyll Island Airport </td>\n   <td style=\"text-align:right;\"> 31.1 </td>\n   <td style=\"text-align:right;\"> -81.4 </td>\n   <td style=\"text-align:right;\"> 11 </td>\n   <td style=\"text-align:right;\"> -5 </td>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Jekyll Island </td>\n   <td style=\"text-align:left;\"> United States </td>\n  </tr>\n</tbody>\n</table>\n\n</div>\n:::\n\n\n### Plotting (!?!?!)\n\nWhat if we want to plot the values in a `tbl`?  Seems like `ggplot()` will support using a `tbl` as input.\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\nairports |>\n  ggplot(aes(x = lon, y = lat)) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](07-db-etc_files/figure-html/unnamed-chunk-46-1.png){width=90%}\n:::\n:::\n\n\nLet's ignore the airports outside of the US.\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\nairports |>\n  filter(lon < 0) |>\n  ggplot(aes(x = lon, y = lat)) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](07-db-etc_files/figure-html/unnamed-chunk-47-1.png){width=90%}\n:::\n:::\n\n\nWhat does the `ggplot()` code translate to in **SQL**?  Of course there is an error!  **SQL** doesn't have any plotting mechanism, so there couldn't be any translation into **SQL**.  Which reminds us that different programming languages have different advantages and disadvantages.  The more we know about them, the better adept we will be at using the right language at the right time.\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\ngg_query <- airports |>\n  filter(lon < 0) |>\n  ggplot(aes(x = lon, y = lat)) +\n  geom_point()\n\nshow_query(gg_query)\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in UseMethod(\"show_query\"): no applicable method for 'show_query' applied to an object of class \"c('gg', 'ggplot')\"\n```\n:::\n:::\n\n\n\n## Best practice\n\nIt is always a good idea to terminate the **SQL** connection when you are done with it.\n\n\n::: {.cell fig.asp='0.618'}\n\n```{.r .cell-code}\ndbDisconnect(con_air, shutdown = TRUE)\n```\n:::\n\n\n\n## <i class=\"fas fa-lightbulb\"></i> Reflection questions  \n\n1. What is the main purpose of a `KEY`?  Can a `KEY` ever be `NULL`?  (Hint: does it depend on what type of `KEY` it is?)\n\n2. What is the main purpose of an `INDEX`?  Can an `INDEX` ever be `NULL`?\n\n3. How should we approach indexing?  That is, what variables are good candidates for choosing to be the index?\n\n4. Why is it harder to calculate the median than the mean?\n\n5. Why are there three functions in **R** (`ifelse()`, `case_when()`, and `cut()`) to do the job of a single function in **SQL** (`CASE WHEN`)?\n\n6. Why won't **dbplyr** provide the syntax for the **SQL** translation of `ggplot()`?\n\n\n## <i class=\"fas fa-balance-scale\"></i> Ethics considerations \n\n1. What types of tasks is **R** best suited for?  What types of tasks is **SQL** best suited for?  Does it matter which one you use if they can both accomplish the same goal?\n\n2. When setting up a database in **SQL** why is it important to consider potential users of the database and their potential questions / queries? That is, how is the *set-up* of the database related to the *use* of the database?\n\n\n",
    "supporting": [
      "07-db-etc_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/font-awesome-6.4.2/css/all.min.css\" rel=\"stylesheet\" />\n<link href=\"site_libs/font-awesome-6.4.2/css/v4-shims.min.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n<link href=\"site_libs/bsTable-3.3.7/bootstrapTable.min.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/bsTable-3.3.7/bootstrapTable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}