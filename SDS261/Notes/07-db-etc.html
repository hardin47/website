<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Jo Hardin">
<title>Data Science, the SQL - 7&nbsp; SQL extras</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./p4-regex.html" rel="next">
<link href="./06-change-db.html" rel="prev">
<link href="./images/favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/x-mathjax-config">
const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers){
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');
  
  // Will this work with TeX on its own line?
  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
  	MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
  	MathJax.Hub.Queue(function(){
      popover.setAttribute('data-content', div.innerHTML);
  	})
  }
}
</script><link rel="shortcut icon" href="figs/favicon.ico">
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script><link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="site_libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet">
<script src="site_libs/bsTable-3.3.7/bootstrapTable.js"></script><link rel="stylesheet" media="screen" href="https://fonts.googleapis.com/css2?family=Quicksand" type="text/css">
</head>
<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./p3-build-db.html">Building databases</a></li><li class="breadcrumb-item"><a href="./07-db-etc.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">**SQL** extras</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Data Science, the SQL</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/hardin47/SDS261-SQL" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome to Data Science, the SQL</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./p1-intro-to-sql.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to databases and SQL</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-db.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Databases</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-sql-in-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">SQL in R and DBeaver</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./p2-using-sql.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using SQL</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-sql-verbs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">SQL clauses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-sql-joins.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Combining tables in SQL</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./p3-build-db.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Building databases</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-creating-db.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Creating databases</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-change-db.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Changing databases</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-db-etc.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title"><strong>SQL</strong> extras</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./p4-regex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regular expressions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-regex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Regular Expressions</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#efficiencies" id="toc-efficiencies" class="nav-link active" data-scroll-target="#efficiencies"><span class="header-section-number">7.1</span> Efficiencies</a>
  <ul class="collapse">
<li><a href="#key" id="toc-key" class="nav-link" data-scroll-target="#key"><span class="header-section-number">7.1.1</span> Key</a></li>
  <li><a href="#index" id="toc-index" class="nav-link" data-scroll-target="#index"><span class="header-section-number">7.1.2</span> Index</a></li>
  <li><a href="#partitioning" id="toc-partitioning" class="nav-link" data-scroll-target="#partitioning"><span class="header-section-number">7.1.3</span> Partitioning</a></li>
  <li><a href="#querying" id="toc-querying" class="nav-link" data-scroll-target="#querying"><span class="header-section-number">7.1.4</span> Querying</a></li>
  </ul>
</li>
  <li>
<a href="#sql-in-dbplyr" id="toc-sql-in-dbplyr" class="nav-link" data-scroll-target="#sql-in-dbplyr"><span class="header-section-number">7.2</span> <strong>SQL</strong> in <strong>dbplyr</strong></a>
  <ul class="collapse">
<li><a href="#median" id="toc-median" class="nav-link" data-scroll-target="#median"><span class="header-section-number">7.2.1</span> Median</a></li>
  <li><a href="#case_when" id="toc-case_when" class="nav-link" data-scroll-target="#case_when"><span class="header-section-number">7.2.2</span> <code>case_when()</code></a></li>
  <li><a href="#other-functions" id="toc-other-functions" class="nav-link" data-scroll-target="#other-functions"><span class="header-section-number">7.2.3</span> Other functions</a></li>
  </ul>
</li>
  <li><a href="#best-practice" id="toc-best-practice" class="nav-link" data-scroll-target="#best-practice"><span class="header-section-number">7.3</span> Best practice</a></li>
  <li><a href="#reflection-questions" id="toc-reflection-questions" class="nav-link" data-scroll-target="#reflection-questions"><span class="header-section-number">7.4</span> <i class="fas fa-lightbulb"></i> Reflection questions</a></li>
  <li><a href="#ethics-considerations" id="toc-ethics-considerations" class="nav-link" data-scroll-target="#ethics-considerations"><span class="header-section-number">7.5</span> <i class="fas fa-balance-scale"></i> Ethics considerations</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/hardin47/SDS261-SQL/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-db-etc" class="quarto-section-identifier"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title"><strong>SQL</strong> extras</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><section id="back-to-the-flights" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="back-to-the-flights">Back to the flights</h4>
<p>The examples below use the <code>airlines</code> database, including the <code>flights</code>, <code>carriers</code>, <code>airports</code>, and <code>planes</code> tables.</p>
</section><section id="efficiencies" class="level2" data-number="7.1"><h2 data-number="7.1" class="anchored" data-anchor-id="efficiencies">
<span class="header-section-number">7.1</span> Efficiencies</h2>
<p>It is worth pointing out a few aspects to loading data into <strong>SQL</strong>: keys, indexes, and partitioning.</p>
<p>Before we get to the definitions, consider this analogy:</p>
<blockquote class="blockquote">
<p>Each library (<code>database</code>) has books (<code>table</code>s). Each book (<code>table</code>) has pages (rows). Each page (row) has a unique page number to identify it (<code>key</code> value); to find a particular page, you sort through the page numbers (<code>key</code> values). But it isn’t immediately obvious where the particular page of interest is, you might have to page through the book a little bit to find the page of interest. It would be easier if you had several bookmarks throughout the book to anchor some of the page numbers. For example, if you want page 1047 and you have a bookmark on page 1050, you only have to turn back three pages. The bookmark is an <code>index</code>, it helps you find the desired rows much more quickly.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
</blockquote>
<section id="key" class="level3" data-number="7.1.1"><h3 data-number="7.1.1" class="anchored" data-anchor-id="key">
<span class="header-section-number">7.1.1</span> Key</h3>
<p>Keys are unique identifiers for each row, used primarily for connecting tables. Keys are generally not helpful for efficiency, but they are important for data integrity and relationships between tables. A key is a pointer that identifies a record. In practice, a key is one or more columns that are earmarked to uniquely identify a record in a table. Keys serve two main purposes:</p>
<ol type="1">
<li>They provide constraints on the column such as that it can’t store duplicate or null values.</li>
<li>They are also used to generate relationships among different tables.</li>
</ol>
<ul>
<li>
<code>PRIMARY KEY</code> is a column or set of columns that uniquely identify each row. Primary keys cannot be <code>NULL</code>. Each table must always have one (and only one) PK. The PK can be made up of one column, but if that isn’t enough to uniquely identify the row, more columns may be added. Sometimes it is easier to designate a numeric column (e.g., row number) to be the PK.</li>
<li>
<code>FOREIGN KEY</code> is a column or set of columns that reference a primary key in a different table. The FK links two tables together, and the link is called a relationship.</li>
</ul>
<p>(There are other keys such as: Super Key, Minimal Super Key, Candidate Key, Unique Key, Alternate Key, Composite Key, Natural Key, Surrogate Key.)</p>
</section><section id="index" class="level3" data-number="7.1.2"><h3 data-number="7.1.2" class="anchored" data-anchor-id="index">
<span class="header-section-number">7.1.2</span> Index</h3>
<p>Indexes are the crux of why <strong>SQL</strong> is so much more efficient than, say, <strong>R</strong>. An index is a lookup table that helps <strong>SQL</strong> keep track of which records contain certain values. By indexing the rows, <strong>SQL</strong> is able to optimize sorting and joining tables. The index is created in advance (when the table is created) and saved to disk, which can take up substantial space on the disk. Sometimes more than one variable is used to index the table. There are trade-offs to having a lot of indexes (disk space but fast wrangling) versus a few indexes (slow wrangling but less space).</p>
<p>A table may have more than one index but you shouldn’t add indexes to every column in a table, as these have to be updated for every addition/update/delete to the column. Rather, indexes should be added to columns that are frequently included in queries.</p>
<p>Indexes may not make much difference for small databases, but, as tables grow in size, queries benefit more from indexes.</p>
<p>In <strong>MySQL</strong> the commands <code>SHOW KEYS</code> and <code>SHOW INDEXES</code> provide information about the keys and indexes for each table (the two operations are synonymous in <strong>MySQL</strong>). Neither operation is available in <strong>DuckDB</strong>.</p>
<p>Notice that the <code>planes</code> table has a single <code>PRIMARY</code> key. That primary key is used to index the table. The <code>flights</code> table has no <code>PRIMARY</code> key, but it does have six different indexes: <code>Year</code>, <code>Date</code>, <code>Origin</code>, <code>Dest</code>, <code>Carrier</code>, and <code>tailNum</code>.</p>
<div class="cell" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">INDEXES</span> <span class="kw">FROM</span> planes;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">

<table>
<caption>
1 records
</caption>
<thead><tr>
<th style="text-align:left;">
Table
</th>
<th style="text-align:right;">
Non_unique
</th>
<th style="text-align:left;">
Key_name
</th>
<th style="text-align:right;">
Seq_in_index
</th>
<th style="text-align:left;">
Column_name
</th>
<th style="text-align:left;">
Collation
</th>
<th style="text-align:right;">
Cardinality
</th>
<th style="text-align:right;">
Sub_part
</th>
<th style="text-align:right;">
Packed
</th>
<th style="text-align:left;">
Null
</th>
<th style="text-align:left;">
Index_type
</th>
<th style="text-align:left;">
Comment
</th>
<th style="text-align:left;">
Index_comment
</th>
<th style="text-align:left;">
Visible
</th>
<th style="text-align:left;">
Expression
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:left;">
planes
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
PRIMARY
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
tailnum
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;">
3358
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
BTREE
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
YES
</td>
<td style="text-align:left;">
</td>
</tr></tbody>
</table>
</div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">INDEXES</span> <span class="kw">FROM</span> flights;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">

<table>
<caption>
8 records
</caption>
<thead><tr>
<th style="text-align:left;">
Table
</th>
<th style="text-align:right;">
Non_unique
</th>
<th style="text-align:left;">
Key_name
</th>
<th style="text-align:right;">
Seq_in_index
</th>
<th style="text-align:left;">
Column_name
</th>
<th style="text-align:left;">
Collation
</th>
<th style="text-align:right;">
Cardinality
</th>
<th style="text-align:right;">
Sub_part
</th>
<th style="text-align:right;">
Packed
</th>
<th style="text-align:left;">
Null
</th>
<th style="text-align:left;">
Index_type
</th>
<th style="text-align:left;">
Comment
</th>
<th style="text-align:left;">
Index_comment
</th>
<th style="text-align:left;">
Visible
</th>
<th style="text-align:left;">
Expression
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
flights
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
Year
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
year
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:left;">
YES
</td>
<td style="text-align:left;">
BTREE
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
YES
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
flights
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
Date
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
year
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:left;">
YES
</td>
<td style="text-align:left;">
BTREE
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
YES
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
flights
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
Date
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
month
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;">
261
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:left;">
YES
</td>
<td style="text-align:left;">
BTREE
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
YES
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
flights
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
Date
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
day
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;">
8463
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:left;">
YES
</td>
<td style="text-align:left;">
BTREE
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
YES
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
flights
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
Origin
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
origin
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;">
6775
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
BTREE
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
YES
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
flights
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
Dest
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
dest
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;">
7155
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
BTREE
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
YES
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
flights
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
Carrier
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
carrier
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;">
451
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
BTREE
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
YES
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
flights
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
tailNum
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
tailnum
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;">
327836
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:left;">
YES
</td>
<td style="text-align:left;">
BTREE
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
YES
</td>
<td style="text-align:left;">
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The values output by <code>SHOW INDEXES</code> are:<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<ul>
<li><p><code>Table</code>: The name of the table.</p></li>
<li><p><code>Non_unique</code>: 0 if the index cannot contain duplicates, 1 if it can.</p></li>
<li><p><code>Key_name</code>: The name of the index. If the index is the primary key, the name is always <code>PRIMARY</code>.</p></li>
<li><p><code>Seq_in_index</code>: The column sequence number in the index, starting with 1.</p></li>
<li><p><code>Column_name</code>: The column name. See also the description for the Expression column.</p></li>
<li><p><code>Collation</code>: How the column is sorted in the index. This can have values A (ascending), D (descending), or NULL (not sorted).</p></li>
<li><p><code>Cardinality</code>: An estimate of the number of unique values in the index.<br>
Cardinality is counted based on statistics stored as integers, so the value is not necessarily exact even for small tables. The higher the cardinality, the greater the chance that <strong>MySQL</strong> uses the index when doing joins. Indexing with a high cardinality variable will be particularly useful for increased efficiency (if that variable is being queried).</p></li>
<li><p><code>Sub_part</code>: The index prefix. That is, the number of indexed characters if the column is only partly indexed, NULL if the entire column is indexed.</p></li>
<li><p><code>Packed</code>: Indicates how the key is packed. <code>NULL</code> if it is not.</p></li>
<li><p><code>Null</code>: Contains <code>YES</code> if the column may contain <code>NULL</code> values and ’’ if not.</p></li>
<li><p><code>Index_type</code>: The index method used (<code>BTREE</code>, <code>FULLTEXT</code>, <code>HASH</code>, <code>RTREE</code>).</p></li>
<li><p><code>Comment</code>: Information about the index not described in its own column, such as disabled if the index is disabled.</p></li>
<li><p><code>Index_comment</code>: Any comment provided for the index with a <code>COMMENT</code> attribute when the index was created.</p></li>
</ul></section><section id="partitioning" class="level3" data-number="7.1.3"><h3 data-number="7.1.3" class="anchored" data-anchor-id="partitioning">
<span class="header-section-number">7.1.3</span> Partitioning</h3>
<p>Another way to speed up query retrievals is to partition the data tables. If, for example, the SNL queries were always done by year, then the <code>episodes</code> table could be partitioned such that they are stored as separate tables (one per <code>year</code>). The partitioning functions as an index on <code>year</code>. The user would not be able to tell the difference between the unpartitioned <code>episodes</code> table and the partitioned one. However, queries done by <code>year</code> would be faster. Queries done grouped in another way would be slower.</p>
</section><section id="querying" class="level3" data-number="7.1.4"><h3 data-number="7.1.4" class="anchored" data-anchor-id="querying">
<span class="header-section-number">7.1.4</span> Querying</h3>
<p>Indexes are built to accommodate the specific queries that are most likely to be run. However, you might not know which queries are going to be run, so it isn’t always obviously how to index a table.</p>
<p>For the flights table, it seems likely that many queries will involve searching for flights from a particular origin, or to a particular destination, or during a particular year (or range of years), or on a specific carrier, and so indexes have been built on each of those columns. There is also a Date index, since it seems likely that people would want to search for flights on a certain date. However, it does not seem so likely that people would search for flights in a specific month across all years, and thus we have not built an index on month alone. The Date index does contain the month column, but the index can only be used if year is also part of the query.</p>
<div class="cell" data-output.var="show_index" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">INDEXES</span> <span class="kw">FROM</span> flights;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="cell-output-display">
<div id="tbl-show-index" class="anchored">
<table class="table table-striped table-condensed table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;7.1: SQL information about how the query will be run. Because distance is not indexed, all 48 million rows must be searched.</caption>
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Table</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Non_unique</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Key_name</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Seq_in_index</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Column_name</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Cardinality</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">flights</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Year</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">year</td>
<td style="text-align: right;">23</td>
</tr>
<tr class="even">
<td style="text-align: left;">flights</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Date</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">year</td>
<td style="text-align: right;">23</td>
</tr>
<tr class="odd">
<td style="text-align: left;">flights</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Date</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">month</td>
<td style="text-align: right;">261</td>
</tr>
<tr class="even">
<td style="text-align: left;">flights</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Date</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">day</td>
<td style="text-align: right;">8463</td>
</tr>
<tr class="odd">
<td style="text-align: left;">flights</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Origin</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">origin</td>
<td style="text-align: right;">6775</td>
</tr>
<tr class="even">
<td style="text-align: left;">flights</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Dest</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">dest</td>
<td style="text-align: right;">7155</td>
</tr>
<tr class="odd">
<td style="text-align: left;">flights</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Carrier</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">carrier</td>
<td style="text-align: right;">451</td>
</tr>
<tr class="even">
<td style="text-align: left;">flights</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">tailNum</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">tailnum</td>
<td style="text-align: right;">327836</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<section id="efficiencies-in-selecting" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="efficiencies-in-selecting">efficiencies in <code>SELECT</code>ing</h4>
<p><strong>MySQL</strong> provides information about how it is going to perform a query using the <code>EXPLAIN</code> syntax. The information communicates how onerous the query is, without actually running it—saving you the time of having to wait for it to execute. <a href="#tbl-explain-query-dist">Table&nbsp;<span>7.2</span></a> provides output that reflects the query plan returned by the <strong>MySQL</strong> server.</p>
<div class="cell" data-output.var="explain_query_dist" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> flights <span class="kw">WHERE</span> distance <span class="op">&gt;</span> <span class="dv">3000</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="cell-output-display">
<div id="tbl-explain-query-dist" class="anchored">
<table class="table table-striped table-condensed table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;7.2: SQL information about how the query will be run. Because distance is not indexed, all 48 million rows must be searched.</caption>
<thead><tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">id</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">select_type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">table</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">partitions</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">possible_keys</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">key</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">key_len</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">ref</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rows</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">filtered</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Extra</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">SIMPLE</td>
<td style="text-align: left;">flights</td>
<td style="text-align: left;">p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p17,p18,p19,p20,p21,p22,p23,p24,p25,p26,p27,p28,p29,p30,p31</td>
<td style="text-align: left;">ALL</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: right;">163980678</td>
<td style="text-align: right;">33.3</td>
<td style="text-align: left;">Using where</td>
</tr></tbody>
</table>
</div>


</div>
</div>
<p>If we were to run a query for long flights using the <code>distance</code> column the server will have to inspect <strong>each</strong> of the 48 million rows, because <code>distance</code> is not indexed. A query on a non-indexed variable is the slowest possible search and is often called a table scan. The 48 million number that you see in the rows column is an estimate of the number of rows that <strong>MySQL</strong> will have to consult in order to process your query. In general, more rows mean a slower query.</p>
<p>On the other hand, a search for recent flights using the <code>year</code> column, which has an index built on it, considers many fewer rows (about 6.3 million, those flights in 2013).</p>
<div class="cell" data-output.var="explain_query_year" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> flights <span class="kw">WHERE</span> <span class="dt">year</span> <span class="op">=</span> <span class="dv">2013</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="cell-output-display">
<div id="tbl-explain-query-year" class="anchored">
<table class="table table-striped table-condensed table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;7.3: SQL information about how the query will be run. Because year is indexed, only 6 million rows (those in 2013) must be searched.</caption>
<thead><tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">id</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">select_type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">table</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">partitions</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">possible_keys</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">key</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">key_len</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">ref</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rows</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">filtered</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Extra</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">SIMPLE</td>
<td style="text-align: left;">flights</td>
<td style="text-align: left;">p27</td>
<td style="text-align: left;">ref</td>
<td style="text-align: left;">Year,Date</td>
<td style="text-align: left;">Year</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">const</td>
<td style="text-align: right;">2978153</td>
<td style="text-align: right;">100</td>
<td style="text-align: left;"></td>
</tr></tbody>
</table>
</div>


</div>
</div>
<p>In a search by <code>year</code> and <code>month</code>, <strong>SQL</strong> uses the <code>Date</code> index. Only 700,000 rows are searched, those in June of 2013.</p>
<div class="cell" data-output.var="explain_query_date" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> flights <span class="kw">WHERE</span> <span class="dt">year</span> <span class="op">=</span> <span class="dv">2013</span> <span class="kw">AND</span> <span class="dt">month</span> <span class="op">=</span> <span class="dv">6</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="cell-output-display">
<div id="tbl-explain-query-date" class="anchored">
<table class="table table-striped table-condensed table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;7.4: SQL information about how the query will be run. Because year and month are both indexed, only 700,000 rows (those in June of 2013) must be searched.</caption>
<thead><tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">id</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">select_type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">table</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">partitions</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">possible_keys</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">key</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">key_len</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">ref</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rows</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">filtered</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Extra</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">SIMPLE</td>
<td style="text-align: left;">flights</td>
<td style="text-align: left;">p27</td>
<td style="text-align: left;">ref</td>
<td style="text-align: left;">Year,Date</td>
<td style="text-align: left;">Date</td>
<td style="text-align: left;">6</td>
<td style="text-align: left;">const,const</td>
<td style="text-align: right;">1056720</td>
<td style="text-align: right;">100</td>
<td style="text-align: left;"></td>
</tr></tbody>
</table>
</div>


</div>
</div>
<p>If we search for particular months across all years, the indexing does not help at all. The query results in a table scan.</p>
<div class="cell" data-output.var="explain_query_month" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> flights <span class="kw">WHERE</span> <span class="dt">month</span> <span class="op">=</span> <span class="dv">6</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="cell-output-display">
<div id="tbl-explain-query-month" class="anchored">
<table class="table table-striped table-condensed table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;7.5: SQL information about how the query will be run. Because month is not indexed on its own, all rows (48 million!) must be searched.</caption>
<thead><tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">id</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">select_type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">table</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">partitions</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">possible_keys</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">key</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">key_len</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">ref</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rows</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">filtered</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Extra</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">SIMPLE</td>
<td style="text-align: left;">flights</td>
<td style="text-align: left;">p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p17,p18,p19,p20,p21,p22,p23,p24,p25,p26,p27,p28,p29,p30,p31</td>
<td style="text-align: left;">ALL</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: right;">163980678</td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">Using where</td>
</tr></tbody>
</table>
</div>


</div>
</div>
<p>Although month is part of the <code>Date</code> index, it is the <strong>second</strong> column in the index, and thus it doesn’t help us when we aren’t filtering on year. Thus, if it were common for our users to search on month without year, it would probably be worth building an index on month. Were we to actually run these queries, there would be a significant difference in computational time.</p>
</section><section id="efficiencies-in-joining" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="efficiencies-in-joining">efficiencies in <code>JOIN</code>ing</h4>
<p>Using indexes is especially important for efficiency when performing <code>JOIN</code> operations on large tables. In the two examples below, both queries use indexes. However, because the cardinality of the index on <code>tailnum</code> is larger that the cardinality of the index on <code>year</code> (see <a href="#tbl-show-index">Table&nbsp;<span>7.1</span></a>), the number of rows in <code>flights</code> associated with each unique value of <code>tailnum</code> is smaller than for each unique value of <code>year</code>. Thus, the first query runs faster.</p>
<div class="cell" data-output.var="explain_join_tail" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> planes p </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> flights o <span class="kw">ON</span> p.tailnum <span class="op">=</span> o.TailNum</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> manufacturer <span class="op">=</span> <span class="st">'BOEING'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="cell-output-display">
<div id="tbl-explain-join-tail" class="anchored">
<table class="table table-striped table-condensed table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;7.6: SQL information about how the query will be run. Because month is not indexed on its own, all rows (48 million!) must be searched.</caption>
<thead><tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">id</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">select_type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">table</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rows</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">key</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">key_len</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">ref</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">partitions</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">possible_keys</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">filtered</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Extra</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">SIMPLE</td>
<td style="text-align: left;">p</td>
<td style="text-align: right;">3358</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">ALL</td>
<td style="text-align: left;"></td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">Using where</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: left;">SIMPLE</td>
<td style="text-align: left;">o</td>
<td style="text-align: right;">500</td>
<td style="text-align: left;">tailNum</td>
<td style="text-align: left;">9</td>
<td style="text-align: left;">airlines.p.tailnum</td>
<td style="text-align: left;">p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p17,p18,p19,p20,p21,p22,p23,p24,p25,p26,p27,p28,p29,p30,p31</td>
<td style="text-align: left;">ref</td>
<td style="text-align: left;">tailNum</td>
<td style="text-align: right;">100</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<div class="cell" data-output.var="explain_join_year" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> planes p </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> flights o <span class="kw">ON</span> p.<span class="dt">Year</span> <span class="op">=</span> o.<span class="dt">Year</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> manufacturer <span class="op">=</span> <span class="st">'BOEING'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="cell-output-display">
<div id="tbl-explain-join-year" class="anchored">
<table class="table table-striped table-condensed table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;7.7: SQL information about how the query will be run. Because month is not indexed on its own, all rows (48 million!) must be searched.</caption>
<thead><tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">id</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">select_type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">table</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rows</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">key</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">key_len</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">ref</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">partitions</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">possible_keys</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">filtered</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Extra</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">SIMPLE</td>
<td style="text-align: left;">p</td>
<td style="text-align: right;">3358</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">ALL</td>
<td style="text-align: left;"></td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">Using where</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: left;">SIMPLE</td>
<td style="text-align: left;">o</td>
<td style="text-align: right;">6897632</td>
<td style="text-align: left;">Year</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">airlines.p.year</td>
<td style="text-align: left;">p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p17,p18,p19,p20,p21,p22,p23,p24,p25,p26,p27,p28,p29,p30,p31</td>
<td style="text-align: left;">ref</td>
<td style="text-align: left;">Year,Date</td>
<td style="text-align: right;">100</td>
<td style="text-align: left;">Using where</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
</section></section></section><section id="sql-in-dbplyr" class="level2" data-number="7.2"><h2 data-number="7.2" class="anchored" data-anchor-id="sql-in-dbplyr">
<span class="header-section-number">7.2</span> <strong>SQL</strong> in <strong>dbplyr</strong>
</h2>
<section id="median" class="level3" data-number="7.2.1"><h3 data-number="7.2.1" class="anchored" data-anchor-id="median">
<span class="header-section-number">7.2.1</span> Median</h3>
<p>Let’s start with an example, calculating the median <code>alt</code>itude in the <code>airports</code> table. (Using <code>airports</code> instead of <code>flights</code> just because the <code>airports</code> table is so much smaller.)<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<div class="cell" data-fig.asp="0.618">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airports</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">con_air</span>, <span class="st">"airports"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">airports</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Source:   SQL [6 x 9]
# Database: mysql  [sds192@scidb.smith.edu:NA/airlines]
  faa   name                           lat   lon   alt    tz dst   city  country
  &lt;chr&gt; &lt;chr&gt;                        &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  
1 04G   Lansdowne Airport             41.1 -80.6  1044    -5 A     Youn… United…
2 06A   Moton Field Municipal Airpo…  32.5 -85.7   264    -6 A     Tusk… United…
3 06C   Schaumburg Regional           42.0 -88.1   801    -6 A     Scha… United…
4 06N   Randall Airport               41.4 -74.4   523    -5 A     Midd… United…
5 09J   Jekyll Island Airport         31.1 -81.4    11    -5 A     Jeky… United…
6 0A9   Elizabethton Municipal Airp…  36.4 -82.2  1593    -5 A     Eliz… United…</code></pre>
</div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">median_query</span> <span class="op">&lt;-</span> <span class="va">airports</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>med_alt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">alt</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">show_query</span><span class="op">(</span><span class="va">median_query</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY `alt`) AS `med_alt`
FROM `airports`</code></pre>
</div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airports</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>med_lat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">alt</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `collect()`:
! Failed to collect lazy table.
Caused by error:
! You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(ORDER BY `alt`) AS `med_lat`
FROM `airports`
LIMIT 7' at line 1 [1064]</code></pre>
</div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @row_index <span class="op">:=</span> <span class="op">-</span><span class="dv">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">AVG</span>(subquery.alt) <span class="kw">AS</span> median_value</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @row_index<span class="op">:=</span>@row_index <span class="op">+</span> <span class="dv">1</span> <span class="kw">AS</span> row_index, alt</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> airports</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> alt</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> subquery</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> subquery.row_index <span class="kw">IN</span> (<span class="fu">FLOOR</span>(@row_index <span class="op">/</span> <span class="dv">2</span>), <span class="fu">CEIL</span>(@row_index <span class="op">/</span> <span class="dv">2</span>));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">

<table>
<caption>
1 records
</caption>
<thead><tr>
<th style="text-align:right;">
median_value
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:right;">
476
</td>
</tr></tbody>
</table>
</div>
</div>
<p>But let’s break down what the code is doing… First, set the <code>row_index</code> to -1 and iterate through by adding +1 for each row. Then concatenate the <code>row_index</code> information onto our table of interest.</p>
<div class="cell" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @row_index <span class="op">:=</span> <span class="op">-</span><span class="dv">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @row_index<span class="op">:=</span>@row_index <span class="op">+</span> <span class="dv">1</span> <span class="kw">AS</span> row_index, alt</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> airports</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> alt</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">

<table>
<caption>
Displaying records 1 - 10
</caption>
<thead><tr>
<th style="text-align:left;">
row_index
</th>
<th style="text-align:right;">
alt
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
0
</td>
<td style="text-align:right;">
-54
</td>
</tr>
<tr>
<td style="text-align:left;">
1
</td>
<td style="text-align:right;">
-42
</td>
</tr>
<tr>
<td style="text-align:left;">
2
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
3
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
4
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
5
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
6
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
7
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
8
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
9
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Next, filter the data to include only the middle row or two rows.</p>
<div class="cell" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @row_index <span class="op">:=</span> <span class="op">-</span><span class="dv">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @row_index<span class="op">:=</span>@row_index <span class="op">+</span> <span class="dv">1</span> <span class="kw">AS</span> row_index, alt</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> airports</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> alt</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> subquery</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> subquery.row_index <span class="kw">IN</span> (<span class="fu">FLOOR</span>(@row_index <span class="op">/</span> <span class="dv">2</span>), <span class="fu">CEIL</span>(@row_index <span class="op">/</span> <span class="dv">2</span>));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">

<table>
<caption>
2 records
</caption>
<thead><tr>
<th style="text-align:left;">
row_index
</th>
<th style="text-align:right;">
alt
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
728
</td>
<td style="text-align:right;">
474
</td>
</tr>
<tr>
<td style="text-align:left;">
729
</td>
<td style="text-align:right;">
477
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The last step is to average the middle row(s). If only one row is pulled out in the previous query, then only one row will be averaged (which the computer does happily).</p>
<div class="cell" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @row_index <span class="op">:=</span> <span class="op">-</span><span class="dv">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-fig.asp="0.618">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">AVG</span>(subquery.alt) <span class="kw">AS</span> median_value</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @row_index<span class="op">:=</span>@row_index <span class="op">+</span> <span class="dv">1</span> <span class="kw">AS</span> row_index, alt</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> airports</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> alt</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> subquery</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> subquery.row_index <span class="kw">IN</span> (<span class="fu">FLOOR</span>(@row_index <span class="op">/</span> <span class="dv">2</span>), <span class="fu">CEIL</span>(@row_index <span class="op">/</span> <span class="dv">2</span>));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">

<table>
<caption>
1 records
</caption>
<thead><tr>
<th style="text-align:right;">
median_value
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:right;">
476
</td>
</tr></tbody>
</table>
</div>
</div>
</section><section id="case_when" class="level3" data-number="7.2.2"><h3 data-number="7.2.2" class="anchored" data-anchor-id="case_when">
<span class="header-section-number">7.2.2</span> <code>case_when()</code>
</h3>
<p>The <strong>dplyr</strong> function <code>case_when()</code> is interesting to look at!<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
</section><section id="other-functions" class="level3" data-number="7.2.3"><h3 data-number="7.2.3" class="anchored" data-anchor-id="other-functions">
<span class="header-section-number">7.2.3</span> Other functions</h3>
<p>distinct() / head()</p>
</section></section><section id="best-practice" class="level2" data-number="7.3"><h2 data-number="7.3" class="anchored" data-anchor-id="best-practice">
<span class="header-section-number">7.3</span> Best practice</h2>
<p>It is always a good idea to terminate the <strong>SQL</strong> connection when you are done with it.</p>
<div class="cell" data-fig.asp="0.618">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con_air</span>, shutdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="reflection-questions" class="level2" data-number="7.4"><h2 data-number="7.4" class="anchored" data-anchor-id="reflection-questions">
<span class="header-section-number">7.4</span> <i class="fas fa-lightbulb"></i> Reflection questions</h2>
</section><section id="ethics-considerations" class="level2" data-number="7.5"><h2 data-number="7.5" class="anchored" data-anchor-id="ethics-considerations">
<span class="header-section-number">7.5</span> <i class="fas fa-balance-scale"></i> Ethics considerations</h2>


</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>Analogy taken from: https://www.quora.com/profile/Lara-Mazilu<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Taken from: https://dev.mysql.com/doc/refman/8.0/en/show-index.html<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Example taken from: https://sebhastian.com/mysql-median/<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Example taken from: https://r4ds.hadley.nz/databases#sec-sql-expressions<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./06-change-db.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Changing databases</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./p4-regex.html" class="pagination-link">
        <span class="nav-page-text">Regular expressions</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">Data Science, the SQL by Jo Hardin.</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">Built with 💚 and <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>


</body></html>