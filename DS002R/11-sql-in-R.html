<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>sql-in-r</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="11-sql-in-R_files/libs/clipboard/clipboard.min.js"></script>
<script src="11-sql-in-R_files/libs/quarto-html/quarto.js"></script>
<script src="11-sql-in-R_files/libs/quarto-html/popper.min.js"></script>
<script src="11-sql-in-R_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="11-sql-in-R_files/libs/quarto-html/anchor.min.js"></script>
<link href="11-sql-in-R_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="11-sql-in-R_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="11-sql-in-R_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="11-sql-in-R_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="11-sql-in-R_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="11-sql-in-R_files/libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="11-sql-in-R_files/libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<section id="sec-sql-R" class="level1">
<h1>SQL in R and DBeaver</h1>
<p>There are three ways to engage with SQL using R. We will discuss each of them in this chapter, and we will expand on the third method in what follows (using interfaces like DBeaver, and RStudio, to run actual SQL code directly).</p>
<ol type="1">
<li>Using the package <strong>dbplyr</strong> <strong>R</strong> will directly translate <strong>dplyr</strong> code into <strong>SQL</strong>.</li>
<li>Using the <strong>DBI</strong> package, we can send <strong>SQL</strong> queries through an <code>r</code> chunk.</li>
<li>Using a <code>sql</code> chunk, we can write actual <strong>SQL</strong> code inside a quarto document.</li>
</ol>
<section id="sec-dplyr-seq" class="level2">
<h2 class="anchored" data-anchor-id="sec-dplyr-seq">Translating <strong>dplyr</strong> code into <strong>SQL</strong></h2>
<p>Let’s go back to the <strong>airlines</strong> database to try out some things that we already know how to do in <strong>R</strong>. Recall that we need the <strong>DBI</strong> and <strong>RMariaDB</strong> packages to connect to <strong>R</strong>; we need the <strong>dbplyr</strong> package to translate <strong>SQL</strong> code into <strong>R</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RMariaDB)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dbplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>con_air <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  RMariaDB<span class="sc">::</span><span class="fu">MariaDB</span>(),</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">dbname =</span> <span class="st">"airlines"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">host =</span> <span class="fu">Sys.getenv</span>(<span class="st">"MDSR_HOST"</span>),</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">user =</span> <span class="fu">Sys.getenv</span>(<span class="st">"MDSR_USER"</span>),</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">password =</span> <span class="fu">Sys.getenv</span>(<span class="st">"MDSR_PWD"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function <code>dbListTables()</code> in the <strong>DBI</strong> package will tell us what tables exist in the <strong>airlines</strong> database.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbListTables</span>(con_air)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "planes"          "carriers"        "airports"        "flights_summary"
[5] "flights"        </code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>flights <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_air, <span class="st">"flights"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>carriers <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_air, <span class="st">"carriers"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s ask a few questions about the data set using data wrangling techniques that should already be familiar.</p>
<ul>
<li>Over what years is the <code>flights</code> data taken?</li>
</ul>
<p>To start, let’s write the commands using tidy <strong>dplyr</strong> code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>yrs <span class="ot">&lt;-</span> flights <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">min_year =</span> <span class="fu">min</span>(year), <span class="at">max_year =</span> <span class="fu">max</span>(year))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>yrs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Missing values are always removed in SQL aggregation functions.
Use `na.rm = TRUE` to silence this warning
This warning is displayed once every 8 hours.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># Source:   SQL [1 x 2]
# Database: mysql  [mdsr_public@mdsr.cdc7tgkkqd0n.us-east-1.rds.amazonaws.com:3306/airlines]
  min_year max_year
     &lt;int&gt;    &lt;int&gt;
1     2013     2015</code></pre>
</div>
</div>
<p>Because <code>flights</code> is not actually a <code>data.frame</code> in <strong>R</strong> (but instead a <code>tbl</code> in <strong>SQL</strong>), the work that was done above was actually performed in <strong>SQL</strong>. To see the <strong>SQL</strong> code, we can use the function <code>show_query</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_query</span>(yrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT MIN(`year`) AS `min_year`, MAX(`year`) AS `max_year`
FROM `flights`</code></pre>
</div>
</div>
<p>Note the similarity between the <strong>R</strong> code and the <strong>SQL</strong> code. We can see <code>SELECT</code> and <code>MIN</code> and <code>MAX</code> which are familiar. The <code>AS</code> function is new, but maybe it that <code>AS</code> does the job of assigning a new name to the output columns. <code>FROM</code> is also new and does the job of piping in a data set to use.</p>
<ul>
<li>Create a data set containing only flights between <code>LAX</code> and <code>BOS</code> in 2012.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>la_bos <span class="ot">&lt;-</span> flights <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2012</span> <span class="sc">&amp;</span> ((origin <span class="sc">==</span> <span class="st">"LAX"</span> <span class="sc">&amp;</span> dest <span class="sc">==</span> <span class="st">"BOS"</span>) <span class="sc">|</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>           (origin <span class="sc">==</span> <span class="st">"BOS"</span> <span class="sc">&amp;</span> dest <span class="sc">==</span> <span class="st">"LAX"</span>))) </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>la_bos</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Source:   SQL [0 x 21]
# Database: mysql  [mdsr_public@mdsr.cdc7tgkkqd0n.us-east-1.rds.amazonaws.com:3306/airlines]
# ℹ 21 variables: year &lt;int&gt;, month &lt;int&gt;, day &lt;int&gt;, dep_time &lt;int&gt;,
#   sched_dep_time &lt;int&gt;, dep_delay &lt;int&gt;, arr_time &lt;int&gt;,
#   sched_arr_time &lt;int&gt;, arr_delay &lt;int&gt;, carrier &lt;chr&gt;, tailnum &lt;chr&gt;,
#   flight &lt;int&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;int&gt;, distance &lt;int&gt;,
#   cancelled &lt;int&gt;, diverted &lt;int&gt;, hour &lt;int&gt;, minute &lt;int&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_query</span>(la_bos)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT `flights`.*
FROM `flights`
WHERE (`year` = 2012.0 AND ((`origin` = 'LAX' AND `dest` = 'BOS') OR (`origin` = 'BOS' AND `dest` = 'LAX')))</code></pre>
</div>
</div>
<p>The <code>WHERE</code> function in <strong>SQL</strong> acts as <code>filter()</code> did in <strong>R</strong>; <code>&amp;</code> has been translated to <code>AND</code>, and <code>|</code> has been translated to <code>OR</code>.</p>
<p>As might be expected, <strong>dbplyr</strong> doesn’t translate every <strong>R</strong> command into <strong>SQL</strong>. After all, <strong>SQL</strong> is not a statistical software and doesn’t, for example, have a mechanism for creating data visualizations. To track which <strong>R</strong> commands are connected to <strong>SQL</strong> see the <a href="https://dbplyr.tidyverse.org/reference/" target="_blank"><strong>dbplyr</strong> reference sheet</a>.</p>
<p>Because the data set has been subsetted substantially, we could pull it into <strong>R</strong> to create an <strong>R</strong> object. Note that now <strong>R</strong> is aware of the size of the entire data frame (7064 rows and 21 columns). The <code>la_bos</code> object now exists in the <strong>R</strong> environment and can be explored through the IDE.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="fas fa-triangle-exclamation"></i> Watch out!
</div>
</div>
<div class="callout-body-container callout-body">
<p>Be careful with <code>collect()</code>. Don’t use <code>collect()</code> on large data frames that won’t fit in an <strong>R</strong> environment.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>la_bos <span class="ot">&lt;-</span> la_bos <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>la_bos</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 0 × 21
# ℹ 21 variables: year &lt;int&gt;, month &lt;int&gt;, day &lt;int&gt;, dep_time &lt;int&gt;,
#   sched_dep_time &lt;int&gt;, dep_delay &lt;int&gt;, arr_time &lt;int&gt;,
#   sched_arr_time &lt;int&gt;, arr_delay &lt;int&gt;, carrier &lt;chr&gt;, tailnum &lt;chr&gt;,
#   flight &lt;int&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;int&gt;, distance &lt;int&gt;,
#   cancelled &lt;int&gt;, diverted &lt;int&gt;, hour &lt;int&gt;, minute &lt;int&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<p><strong>?@sec-sql-clauses</strong> will explore more <strong>SQL</strong> queries and using <strong>SQL</strong> verbs. For now, let’s continue learning about the different ways <strong>R</strong> can talk to <strong>SQL</strong>.</p>
<p>Always a good idea to terminate the <strong>SQL</strong> connection when you are done with it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con_air, <span class="at">shutdown =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sql-queries-through-the-dbi-package" class="level2">
<h2 class="anchored" data-anchor-id="sql-queries-through-the-dbi-package">SQL queries through the <strong>DBI</strong> package</h2>
<p>Using <strong>R</strong> as a wrapper, we can send actual <strong>SQL</strong> code to query data from the connection. It is okay if you aren’t yet able to write <strong>SQL</strong> commands from scratch, but try to figure out what the command is asking for. As mentioned above, we will start from scratch to learn <strong>SQL</strong> commands in <strong>?@sec-sql-clauses</strong>.</p>
<p>Start by setting up the <strong>SQL</strong> connection in the same way.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>con_air <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  RMariaDB<span class="sc">::</span><span class="fu">MariaDB</span>(),</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">dbname =</span> <span class="st">"airlines"</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">host =</span> <span class="fu">Sys.getenv</span>(<span class="st">"MDSR_HOST"</span>),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">user =</span> <span class="fu">Sys.getenv</span>(<span class="st">"MDSR_USER"</span>),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">password =</span> <span class="fu">Sys.getenv</span>(<span class="st">"MDSR_PWD"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Look at the first few rows of the <code>flights</code> data.</li>
</ul>
<p>Because the <code>flights</code> data is not an <strong>R</strong> object, we can’t open it in <strong>R</strong> to explore the variables. If we want to see a small bit of the data, we can <code>SELECT</code> <strong>everything</strong> (i.e, <code>*</code>) from the <code>flights</code> table but <code>LIMIT</code> the query to only the first eight observations.</p>
<p>Note that the code in the <code>dbGetQuery()</code> <strong>R</strong> function is written in <strong>SQL</strong> not in <strong>R</strong>.</p>
<p>A semicolon (<code>;</code>) is typically used to indicate the termination of a <strong>SQL</strong> statement. They are not always required (particularly when only one statement is being sent), however, it is good practice to use a semicolon at the end of each <strong>SQL</strong> statement. (Indeed, some <strong>SQL</strong> dialects require the semicolon at the end of every statement, regardless of whether or not there are more statements following.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con_air,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                <span class="st">"SELECT * FROM flights LIMIT 8;"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year month day dep_time sched_dep_time dep_delay arr_time sched_arr_time
1 2013    10   1        2             10        -8      453            505
2 2013    10   1        4           2359         5      730            729
3 2013    10   1       11             15        -4      528            530
4 2013    10   1       14           2355        19      544            540
5 2013    10   1       16             17        -1      515            525
6 2013    10   1       22             20         2      552            554
7 2013    10   1       29             35        -6      808            816
8 2013    10   1       29             35        -6      449            458
  arr_delay carrier tailnum flight origin dest air_time distance cancelled
1       -12      AA  N201AA   2400    LAX  DFW      149     1235         0
2         1      FL  N344AT    710    SFO  ATL      247     2139         0
3        -2      AA  N3KMAA   1052    SFO  DFW      182     1464         0
4         4      AA  N3ENAA   2392    SEA  ORD      191     1721         0
5       -10      UA  N38473   1614    LAX  IAH      157     1379         0
6        -2      UA  N458UA    291    SFO  IAH      188     1635         0
7        -8      US  N551UW    436    LAX  CLT      256     2125         0
8        -9      AS  N402AS    108    ANC  SEA      181     1448         0
  diverted hour minute           time_hour
1        0    0     10 2013-10-01 00:10:00
2        0   23     59 2013-10-01 23:59:00
3        0    0     15 2013-10-01 00:15:00
4        0   23     55 2013-10-01 23:55:00
5        0    0     17 2013-10-01 00:17:00
6        0    0     20 2013-10-01 00:20:00
7        0    0     35 2013-10-01 00:35:00
8        0    0     35 2013-10-01 00:35:00</code></pre>
</div>
</div>
<ul>
<li>How many flights per year are in the <code>flights</code> table?</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbGetQuery</span>(con_air, </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT year, count(*) AS num_flights FROM flights GROUP BY year ORDER BY num_flights;"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year num_flights
1 2015     5819079
2 2014     5819811
3 2013     6369482</code></pre>
</div>
</div>
<p>Note that we’ve now <code>SELECT</code>ed two variables: <code>year</code> and <code>num_flights</code> (which we created along the way using <code>count(*)</code> which is written as <code>n()</code> in <strong>R</strong>) <code>FROM</code> the <code>flights</code> table. Then we <code>GROUP BY</code> the <code>year</code> variable which retroactively acts on the <code>count(*)</code> function. And last, we <code>ORDER BY</code> (which is similar to <code>arrange()</code>) the new <code>num_flights</code> variable.</p>
<p>Always a good idea to terminate the <strong>SQL</strong> connection when you are done with it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con_air, <span class="at">shutdown =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="direct-sql-queries-through-a-sql-chunk" class="level2">
<h2 class="anchored" data-anchor-id="direct-sql-queries-through-a-sql-chunk">Direct <strong>SQL</strong> queries through a <code>sql</code> chunk</h2>
<p>Notice that the formatting of the next few chunks is slightly different. Instead of reporting only the inside / code of the chunk, the entire chunk is printed. The <strong>SQL</strong> chunks are given by <code>{sql}</code> instead of <code>{r}</code> and each <strong>SQL</strong> chunk is required to connect to a particular database (through the <code>con_air</code> connection).</p>
<p>The same queries have been run.</p>
<p>Start by setting up the <strong>SQL</strong> connection in the same way.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="in">con_air &lt;- DBI::dbConnect(</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="in">  RMariaDB::MariaDB(),</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="in">  dbname = "airlines",</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="in">  host = Sys.getenv("MDSR_HOST"),</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="in">  user = Sys.getenv("MDSR_USER"),</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="in">  password = Sys.getenv("MDSR_PWD")</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{sql}</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="in">#| connection: con_air</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="in">SELECT * FROM flights LIMIT 8;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>8 records</caption>
<colgroup>
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 4%">
<col style="width: 8%">
<col style="width: 5%">
<col style="width: 4%">
<col style="width: 8%">
<col style="width: 5%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 4%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">year</th>
<th style="text-align: right;">month</th>
<th style="text-align: right;">day</th>
<th style="text-align: right;">dep_time</th>
<th style="text-align: right;">sched_dep_time</th>
<th style="text-align: right;">dep_delay</th>
<th style="text-align: right;">arr_time</th>
<th style="text-align: right;">sched_arr_time</th>
<th style="text-align: right;">arr_delay</th>
<th style="text-align: left;">carrier</th>
<th style="text-align: left;">tailnum</th>
<th style="text-align: right;">flight</th>
<th style="text-align: left;">origin</th>
<th style="text-align: left;">dest</th>
<th style="text-align: right;">air_time</th>
<th style="text-align: right;">distance</th>
<th style="text-align: right;">cancelled</th>
<th style="text-align: right;">diverted</th>
<th style="text-align: right;">hour</th>
<th style="text-align: right;">minute</th>
<th style="text-align: left;">time_hour</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2013</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">-8</td>
<td style="text-align: right;">453</td>
<td style="text-align: right;">505</td>
<td style="text-align: right;">-12</td>
<td style="text-align: left;">AA</td>
<td style="text-align: left;">N201AA</td>
<td style="text-align: right;">2400</td>
<td style="text-align: left;">LAX</td>
<td style="text-align: left;">DFW</td>
<td style="text-align: right;">149</td>
<td style="text-align: right;">1235</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">2013-10-01 00:10:00</td>
</tr>
<tr class="even">
<td style="text-align: right;">2013</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">2359</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">730</td>
<td style="text-align: right;">729</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FL</td>
<td style="text-align: left;">N344AT</td>
<td style="text-align: right;">710</td>
<td style="text-align: left;">SFO</td>
<td style="text-align: left;">ATL</td>
<td style="text-align: right;">247</td>
<td style="text-align: right;">2139</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">59</td>
<td style="text-align: left;">2013-10-01 23:59:00</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2013</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">-4</td>
<td style="text-align: right;">528</td>
<td style="text-align: right;">530</td>
<td style="text-align: right;">-2</td>
<td style="text-align: left;">AA</td>
<td style="text-align: left;">N3KMAA</td>
<td style="text-align: right;">1052</td>
<td style="text-align: left;">SFO</td>
<td style="text-align: left;">DFW</td>
<td style="text-align: right;">182</td>
<td style="text-align: right;">1464</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">15</td>
<td style="text-align: left;">2013-10-01 00:15:00</td>
</tr>
<tr class="even">
<td style="text-align: right;">2013</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">2355</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">544</td>
<td style="text-align: right;">540</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">AA</td>
<td style="text-align: left;">N3ENAA</td>
<td style="text-align: right;">2392</td>
<td style="text-align: left;">SEA</td>
<td style="text-align: left;">ORD</td>
<td style="text-align: right;">191</td>
<td style="text-align: right;">1721</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">55</td>
<td style="text-align: left;">2013-10-01 23:55:00</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2013</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">515</td>
<td style="text-align: right;">525</td>
<td style="text-align: right;">-10</td>
<td style="text-align: left;">UA</td>
<td style="text-align: left;">N38473</td>
<td style="text-align: right;">1614</td>
<td style="text-align: left;">LAX</td>
<td style="text-align: left;">IAH</td>
<td style="text-align: right;">157</td>
<td style="text-align: right;">1379</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">17</td>
<td style="text-align: left;">2013-10-01 00:17:00</td>
</tr>
<tr class="even">
<td style="text-align: right;">2013</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">552</td>
<td style="text-align: right;">554</td>
<td style="text-align: right;">-2</td>
<td style="text-align: left;">UA</td>
<td style="text-align: left;">N458UA</td>
<td style="text-align: right;">291</td>
<td style="text-align: left;">SFO</td>
<td style="text-align: left;">IAH</td>
<td style="text-align: right;">188</td>
<td style="text-align: right;">1635</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">20</td>
<td style="text-align: left;">2013-10-01 00:20:00</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2013</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">-6</td>
<td style="text-align: right;">808</td>
<td style="text-align: right;">816</td>
<td style="text-align: right;">-8</td>
<td style="text-align: left;">US</td>
<td style="text-align: left;">N551UW</td>
<td style="text-align: right;">436</td>
<td style="text-align: left;">LAX</td>
<td style="text-align: left;">CLT</td>
<td style="text-align: right;">256</td>
<td style="text-align: right;">2125</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">35</td>
<td style="text-align: left;">2013-10-01 00:35:00</td>
</tr>
<tr class="even">
<td style="text-align: right;">2013</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">-6</td>
<td style="text-align: right;">449</td>
<td style="text-align: right;">458</td>
<td style="text-align: right;">-9</td>
<td style="text-align: left;">AS</td>
<td style="text-align: left;">N402AS</td>
<td style="text-align: right;">108</td>
<td style="text-align: left;">ANC</td>
<td style="text-align: left;">SEA</td>
<td style="text-align: right;">181</td>
<td style="text-align: right;">1448</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">35</td>
<td style="text-align: left;">2013-10-01 00:35:00</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{sql}</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="in">#| connection: con_air</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="in">SELECT year, count(*) AS num_flights FROM flights GROUP BY year ORDER BY num_flights;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: right;">year</th>
<th style="text-align: right;">num_flights</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2015</td>
<td style="text-align: right;">5819079</td>
</tr>
<tr class="even">
<td style="text-align: right;">2014</td>
<td style="text-align: right;">5819811</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2013</td>
<td style="text-align: right;">6369482</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Always a good idea to terminate the <strong>SQL</strong> connection when you are done with it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con_air, <span class="at">shutdown =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dbeaver" class="level2">
<h2 class="anchored" data-anchor-id="dbeaver">DBeaver</h2>
<p>DBeaver is a free SQL client that supports MySQL (as well as other dialects like MariaDB, PostgreSQL, and SQLite). While writing <strong>SQL</strong> code in <strong>R</strong> has some benefits (e.g., piping results tables into <strong>ggplot2</strong> for visualizations), using a <strong>SQL</strong> client that is designed for <strong>SQL</strong> queries has benefits as well. In order to use DBeaver, <a href="https://dbeaver.io/download/" target="_blank">download the client</a> onto your computer and open it from your Applications.</p>
<section id="new-database-connection" class="level3">
<h3 class="anchored" data-anchor-id="new-database-connection">New database connection</h3>
<p>Using the pull-down menus, navigate to a new database connection (Database -&gt; New Database Connection). Click on the MySQL icon (and click next). You should see an image similar to <a href="#fig-dbeaver-connect" class="quarto-xref">Figure&nbsp;1</a>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-dbeaver-connect" class="quarto-figure quarto-figure-center quarto-float anchored" alt="The available options for setting up a MySQL connection in DBeaver.  In particular.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dbeaver-connect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/dbeaver-connect.png" class="img-fluid figure-img" style="width:70.0%" alt="The available options for setting up a MySQL connection in DBeaver.  In particular.">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dbeaver-connect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Connection settings for a MySQL connection via DBeaver.
</figcaption>
</figure>
</div>
</div>
</div>
<ol type="1">
<li>Keep the <code>Host</code> radio button toggled (don’t click on <code>URL</code>)</li>
<li>Where currently it says <code>Server Host: localhost</code> change <code>localhost</code> to the URL for the MySQL server to which you want to connect.</li>
<li>Change the <code>Username</code> to the appropriate username for the server.</li>
<li>Change the <code>Password</code> to the appropriate password for the server.</li>
<li>Optional: in the <code>Database:</code> box, include the database you will query.</li>
<li>Click <code>Finish</code>.</li>
</ol>
<p>Once the connection is established, you should be able to navigate through the databases and their tables on the left side of the DBeaver window.</p>
</section>
<section id="writing-sql-queries" class="level3">
<h3 class="anchored" data-anchor-id="writing-sql-queries">Writing SQL queries</h3>
<p>Pull up a <strong>SQL</strong> script by clicking ont he <strong>SQL</strong> button as seen in <a href="#fig-sql" class="quarto-xref">Figure&nbsp;2</a>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-sql" class="quarto-figure quarto-figure-center quarto-float anchored" alt="Image of the icon in DBeaver which produces an empty SQL script.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sql-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/sql.png" class="img-fluid figure-img" style="width:70.0%" alt="Image of the icon in DBeaver which produces an empty SQL script.">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sql-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Click on SQL to initiate a SQL script.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Write <strong>SQL</strong> code. Click on the orange triangle to run the code.</p>
<p>Each lab should be saved as a .sql files that can be turned in. The <strong>SQL</strong> queries (in the .sql file) should be able to be run by someone else. Use the hashtag (<code>#</code>) to comment out lines so that you can identify particular problems or comment on the query results.</p>
<p>If you did not specify which database to use when you set up the connection, the database can be specified at the top of the .sql file as <code>USE database;</code> (for example, you might want <code>USE airlines;</code>, with the semi-colon, before running your lines of <strong>SQL</strong> code).</p>
<p>To write text use <code>/* write text here ... */</code>, the slash and asterisk, for any commenting in the <code>.sql</code> file.</p>
</section>
</section>
<section id="reflection-questions" class="level2">
<h2 class="anchored" data-anchor-id="reflection-questions"><i class="fas fa-lightbulb"></i> Reflection questions</h2>
<ol type="1">
<li><p>What are the three main ways to write a <strong>SQL</strong> query using the <strong>R</strong>Studio interface?</p></li>
<li><p>How is DBeaver similar and/or different from writing queries using **R*?</p></li>
<li><p>Why can’t you use <code>collect()</code> to pull the <code>flights</code> data into your <strong>R</strong> session?</p></li>
</ol>
</section>
<section id="ethics-considerations" class="level2">
<h2 class="anchored" data-anchor-id="ethics-considerations"><i class="fas fa-balance-scale"></i> Ethics considerations</h2>
<ol type="1">
<li><p>How / why is <code>Sys.getenv()</code> used to protect the username and password for the <strong>SQL</strong> connection?</p></li>
<li><p>If <strong>SQL</strong> databases are expensive to maintain, who will then have access to important data? Does it matter?</p></li>
</ol>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>